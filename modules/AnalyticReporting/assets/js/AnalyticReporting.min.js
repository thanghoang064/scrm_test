/*! AnalyticReporting 19-07-2018 */
function getLimit(a){var b="",c=a.get("selectedFields");if(c[0]&&c[0].showTop){var d=c[0].showTop;!isNaN(parseFloat(d))&&isFinite(d)&&(b=c[0].showTop)}return b}function getSectionStates(){var a=[];return jQuery(".ar-rv-section").each(function(b,c){var d=!0,e=jQuery(c).attr("id");jQuery(c).find(".toggle").hasClass("asc")&&(d=!1),a.push({name:e,collapsed:d})}),a}function capitalize(a){return a&&a[0].toUpperCase()+a.slice(1)}function pop_include_details(){newwindow2=window.open("","name","height=300,width=600");var a=newwindow2.document;a.write("<html><head><title>Include Details Help</title>"),a.write("</head><body>"),a.write("<p>"+translated_labels.label_tooltip_msg_1+"</p>"),a.write("</body></html>"),a.close()}function pop_crosstab(){newwindow2=window.open("","name","height=300,width=600");var a=newwindow2.document;a.write("<html><head><title>Is Crosstab Help</title>"),a.write("</head><body>"),a.write("<p>"+translated_labels.label_tooltip_msg_2+"</p>"),a.write("</body></html>"),a.close()}function pop_aggregates_as_column(){newwindow2=window.open("","name","height=300,width=600");var a=newwindow2.document;a.write("<html><head><title>Aggregates as column Help</title>"),a.write("</head><body>"),a.write("<p>"+translated_labels.label_tooltip_msg_3+"</p>"),a.write("</body></html>"),a.close()}function push_page(a,b,c){var d={pageNumber:a};return b==a&&(d.currentPage=!0),c.push(d),c}function push_separator(a,b){var c={pageSeparator:!0,symbol:a};return b.push(c),b}function getGrandTotalsLabel(){var a=translated_labels.label_grand_total;return ReportData.labels.grandTotal&&(a=ReportData.labels.grandTotal),a}function getColumnWidth(a){var b=a.data,c=a.label,d=a.name,e=0;a.grouped&&(e=20),a.grouped&&a.groupedLevel>0&&(e+=30);for(var f=0,g=0,h=0;h<b.length;h++)b[h][d]&&b[h][d].length>g&&(g=b[h][d].length);if((f=c.length>g?c.length:g)>17)var i=7;else if(f>10)var i=8;else var i=9;return i*f+e}function parseDateGroups(a){for(var b=jQuery.extend(!0,[],a),c=0;c<b.length;c++)b[c].dateGrouping&&(b[c].name=b[c].name+"_"+b[c].dateGrouping,b[c].aggregate=b[c].aggregate+"_"+b[c].dateGrouping,b[c].title=b[c].title+" ("+capitalize(b[c].dateGrouping)+")");return b}function parseRangesGroups(a){for(var b=jQuery.extend(!0,[],a),c=0;c<b.length;c++)b[c].groupByRange&&(b[c].name=b[c].rangeName);return b}function parseGroupPercent(a,b){for(var c=a.length,d=0;d<c;d++){var e=a[d].showAggregates;for(var f in e){var g=e[f].calculatePercent;if(void 0!==g)for(var h in g)if(-1!==g[h].indexOf("percentFromTotal")){var i=f+aggregatesDefinitions[h].namePostfix+"_total_percent";e[i]={sum:!0},b.push({selectedField:i,value:{sum:!0}})}}}}function loadChart(a,b,c,d){jQuery.post(ReportData.url+ReportData.id+"&chart=1",b,function(a){if(ReportData.chartSize){if(ReportData.chartHeight||ReportData.chartHeight>0)var b=ReportData.chartHeight+"px";else var b=200+400*ReportData.chartSize/100+"px";var e=ReportData.chartSize+"%";jQuery("#chart1").css({width:e,height:b})}ReportData.chartData=JSON.parse(a),(d.length>0||ReportData.options.isCombined)&&initChartView(!1,ReportData,!0,c,d)})}function initChartView(a,b,c,d,e){e=e||b.fieldGroupingSorting,d=d||b.selectedAggregates,c=c||!1;var f="#chart1",g="#chart1 svg";return a&&(f=a,g="#"+a.attr("id")+" svg"),chartView=new ChartView({el:f,data:{svg:g,type:b.chartType,data:b.chartData,title:b.chartTitle,showPercents:b.chartShowPercents,showLabels:b.chartShowLabels,showZoneLabels:b.chartShowZoneLabels,valueZones:b.chartValueZones,xAxisSegment:b.chartAxisXSegment,legend:b.chartLegend,xAxis:b.chartAxisX,yAxis:b.chartAxisY,yAxis2:b.chartAxisY2,yAxisType:b.chartYAxisType,yAxis2Type:b.chartYAxis2Type,aggregates:d,groups:e,bars1Stacked:b.chartBars1Stacked,bars2Stacked:b.chartBars2Stacked,showLinks:c,isWidget:b.isWidget,cumulated:b.chartCumulated,sortableValues:b.chartSortableValues,numberFormat:new NumberFormatter(jQuery.extend({},{numdec:b.chartDecimalDigits},b.numberFormat),null).makeFormatter(),decimalDigits:b.chartDecimalDigits,mapType:b.mapType,country:b.country,state:b.state,zoom:b.zoom,lat:b.lat,lng:b.lng,labels:b.labels,fieldsByName:b.fieldsByName,options:b.options,chartOptions:b.chartOptions,combinedSelectedFields:b.combinedSelectedFields,availableFields:b.availableFields,columns:b.selectedFields,calcFields:b.calcFields,getAvailableGroups:reportUtils.getAvailableGroups(b,e,b.fieldsByName),filters:b.selectedFilters,margin:b.chartMargin,stacked:b.chartStacked,reportData:b,marker:b.marker,markerAxisX:b.markerAxisX,markerAxisY:b.markerAxisY,canEdit:b.canEdit,canDelete:b.canDelete,swapAxis:b.chartSwapAxis,chartColors:b.chartColors},components:{chartComponent:getChartComponent(b.chartType,b.chartLegend,b.chartAxisX,e)}})}function getContextMenuElements(a){return[{title:function(b){var c="#",d={meta:!1},e="",f="";if(b.data&&b.data.label?(e=b.data.label,f=b.color):b.data&&b.data.key?(e=b.data.key,f=b.color):b.series&&b.point?(e=b.series.key,f=b.point.color):b.series&&b.series.key&&(e=b.series.key,f=b.series.color),b.data?d=b.data:b.points?d=b.points:b.point&&(d=b.point),d.meta||d[2]){var g=d.meta||d[2];c=a.urlDrilldown+a.id+"&drilldown="+encodeURI(JSON.stringify(g))}return'<a href="'+c+'" target="_blank">Drill-down to detailed data</a><input type="hidden" value="'+e+'" id="colorForField"><input type="hidden" value="'+f+'" id="drilldownpopup" />'},action:function(a,b,c){}}]}function getChartObject(a){var b;switch(a){case"area":b=ReportAreaChart;break;case"gauge":b=ReportGaugeChart;break;case"funnel":b=ReportFunnelChart;break;case"bar":b=ReportBarChart;break;case"hbar":b=ReportHorizontalBarChart;break;case"line":b=ReportLineChart;break;case"combined":b=ReportCombinedChart;break;case"map":b=ReportMapChart;break;case"pie":default:b=ReportPieChart}return b}function getChartComponent(a,b,c,d){var e;switch(a){case"area":e=AreaChartComponent;break;case"gauge":e=GaugeChartComponent;break;case"funnel":e=FunnelChartComponent;break;case"bar":var f=reportUtils.getGroup(c,d);f&&f.dateGrouping&&c==f.name&&(c=f.name+"_"+f.dateGrouping),e=b!=c?MultiBarChartComponent:BarChartComponent;break;case"hbar":e=HorizontalBarChartComponent;break;case"line":e=LineChartComponent;break;case"combined":e=CombinedChartComponent;break;case"map":e=MapChartComponent;break;case"pie":default:e=PieChartComponent}return e}var postToURL=function(a,b){var c=jQuery("<form/>",{action:a,method:"POST",style:"display: none;"});jQuery.each(b,function(a,b){c.append(jQuery("<input/>",{name:a,value:b,type:"hidden"}))}),c.appendTo("body").submit()},cleanAggregates=function(a){for(var b=0;b<a.length;b++)delete a[b].blocks,delete a[b].availableFields;return a},showData=function(a,b,c,d,e,f,g,h){return function(i){if(jQuery(".ar-loading").hide(),"undefined"!=typeof reportDebugMode&&reportDebugMode){var j=JSON.parse(i);debugResponse.set("debug",JSON.stringify(j.debug,null,2)),delete j.debug,debugResponse.set("response",JSON.stringify(j)),debugResponse.set("queryResult",j.queryResult),debugResponse.set("queryError",j.queryError),debugResponse.set("queryTime",j.queryTime),debugResponse.set("queryCount",j.queryCount),debugResponse.set("processorCount",j.processorCount)}ReportData.currentResult=JSON.parse(i);var k=reportUtils.isMultiSummaryReport(a,b,c,ReportData.isCrosstab);c?DetailGrid.init(d,e,h):k?DetailGrid.init(d,e,h,k):SummaryGrid.init(d,e),jQuery(window).trigger("resize.doubleScroll"),ReportData.currentResult.meta&&(f.set("meta",ReportData.currentResult.meta),f.set("isCrosstab",ReportData.options.isCrosstab),g.set("meta",ReportData.currentResult.meta),g.set("isCrosstab",ReportData.options.isCrosstab))}},chartView;jQuery(document).ready(function(a){function b(){var a=m.get("chartType"),b=null;switch(a){case"gauge":b=ReportGaugeChart;break;case"funnel":b=ReportFunnelChart;break;case"bar":b=ReportBarChart;break;case"hbar":b=ReportHorizontalBarChart;break;case"pie":b=ReportPieChart;break;case"line":b=ReportLineChart;break;case"combined":b=ReportCombinedChart;break;case"map":b=ReportMapChart;break;case"area":b=ReportAreaChart}var c=h.get("groups"),d=i.get("aggregates"),e=j.get("selectedFields"),f=g.get("selectedFields");b.init(j,c,f,d,e)}var c=reportUtils.setFieldsByName();ReportData.reportStates.sectionStates=getSectionStates(),jQuery("#ar-rv-editor-tabs, #ar-rv-chart-editor-tabs").tabs(),jQuery(".ar-rv-section .toggle").click(function(a){a.preventDefault();var b=!0;jQuery(this).is(".asc")?(jQuery(this).removeClass("asc"),jQuery(this).addClass("desc")):(b=!1,jQuery(this).removeClass("desc"),jQuery(this).addClass("asc"));var c=jQuery(this).parent().siblings();jQuery(c[0]).slideToggle(100,function(){if(!b){var a=jQuery(this).closest(".ar-rv-section").attr("id");"ar-rv-data"==a&&jQuery(document).trigger("slickRenderRequest"),"ar-rv-chart-view"==a&&jQuery(document).trigger("d3RenderRequest")}}),ReportData.reportStates.sectionStates=getSectionStates()});var d,e,f,g,h,i,j,k,l,m,n,o,p,q;ReportData.chartAxisY instanceof Array||(ReportData.chartAxisY=[ReportData.chartAxisY]),ReportData.chartAxisY2 instanceof Array||(ReportData.chartAxisY2=[ReportData.chartAxisY2]);var r={blocks:ReportData.availableFields,groups:ReportData.selectedFilters,isAdmin:1==current_user.is_admin,canEdit:ReportData.canEdit,canDelete:ReportData.canDelete},s={blocks:ReportData.availableFields,selectedFields:ReportData.selectedFields,fieldsByName:ReportData.fieldsByName},t={aggregates:ReportData.selectedAggregates,fieldsByName:ReportData.fieldsByName},u={selectedFields:ReportData.fieldGroupingSorting,aggregates:ReportData.selectedAggregates,fieldsByName:ReportData.fieldsByName,availableFields:c,totalAggregates:ReportData.totalAggregates,combinedSelectedFields:ReportData.combinedSelectedFields,aggregatesAsColumn:ReportData.options.aggregateColumn,emptyAsZero:ReportData.options.emptyAsZero,blocks:ReportData.availableFields,options:ReportData.options},v={labels:ReportData.labels,aggregates:ReportData.selectedAggregates,availableFields:ReportData.availableFields,fieldsByName:ReportData.fieldsByName,totalAggregates:ReportData.totalAggregates,aggregatesAsColumn:ReportData.options.aggregateColumn,isCombined:ReportData.options.isCombined},w={users:ReportData.reportAccessUsers,accessRights:ReportData.reportAccessUsersSelected,globalSharing:ReportData.sharedAccess,availableOwners:ReportData.users,owner:ReportData.owner,globalSharingRights:ReportData.sharedAccessRights,canEdit:ReportData.canEdit,canDelete:ReportData.canDelete,allowDrilldownReadOnly:ReportData.options.allowDrilldownReadOnly,allowExportReadOnly:ReportData.options.allowExportReadOnly},x={users:ReportData.reportScheduleUsers,isScheduled:ReportData.schedule.isScheduled,selectedUsers:ReportData.reportScheduleUsersSelected,timeH:ReportData.schedule.timeH,timeM:ReportData.schedule.timeM,interval:ReportData.schedule.interval,intervalOptions:ReportData.schedule.intervalOptions,scheduledFormats:ReportData.schedule.formats,options:ReportData.options},y={options:ReportData.options,availableTemplates:excelTemplates,availableReports:reportNamesForTemplates,canEdit:canEdit},z={fieldsByName:ReportData.fieldsByName,condTypes:[{name:"empt",title:translated_labels.label_fn_empty},{name:"nempt",title:translated_labels.label_fn_nempty},{name:"equal",title:translated_labels.label_fn_equal},{name:"nequal",title:translated_labels.label_fn_nequal}],fieldTypes:[{name:"txt",title:translated_labels.label_fn_text},{name:"date",title:translated_labels.label_fn_date},{name:"datetime",title:translated_labels.label_fn_datetime},{name:"number",title:translated_labels.label_fn_number}],fns:[{name:"plus",title:translated_labels.label_fn_plus,valCount:2,argTitles:["","+"],acceptedFields:["number","integer"],summary:!1},{name:"addDate",title:translated_labels.label_fn_add_date,valCount:3,argTitles:["","+"," as "],acceptedFields:["date","datetime"],summary:!1},{name:"minus",title:translated_labels.label_fn_minus,valCount:2,argTitles:["","-"],acceptedFields:["number","integer"],summary:!1},{name:"subtractDate",title:translated_labels.label_fn_subtract_date,valCount:4,argTitles:["","-"," as "],acceptedFields:["date","datetime"],summary:!1},{name:"mult",title:translated_labels.label_fn_multiply,valCount:2,argTitles:["","*"],acceptedFields:["number","integer"],summary:!1},{name:"div",title:translated_labels.label_fn_divide,valCount:2,argTitles:["","/"],acceptedFields:["number","integer"],summary:!1},{name:"if",title:translated_labels.label_fn_if,valCount:4,argTitles:[""," = "," then "," else "],acceptedFields:["number","txt","select","checkbox","date","datetime","integer"],summary:!1}],calcFields:ReportData.calcFields};paginationManagerOpt={isCrosstab:ReportData.options.isCrosstab,frozenColumn:ReportData.options.frozenColumn},ReportData.options.isCombined&&(s.blocks=ReportData.selectableFields,u.availableFieldsPossible=c),g=new reportFieldManager({data:s}),j=new reportGroupingManager({data:u});var A=g.get("fieldsByName"),B=[];for(var C in A)B.push(A[C]);z.availableFields=B,o=new reportCalcFieldManager({data:z}),p=new reportPaginationManager({data:jQuery.extend({},paginationManagerOpt,{positionTop:!0})}),q=new reportPaginationManager({data:paginationManagerOpt}),h=new reportFilterManager({data:r}),h.render("#ar-rv-editor-filters").then(function(){return g.render("#ar-rv-editor-fields")}).then(function(){return!!ReportData.isCombined||o.render("#ar-rv-editor-calcfields")}).then(function(){return p.render("#pagination-top")}).then(function(){return q.render("#pagination-bottom")}).then(function(){return t.availableFields=g.get("selectableFields"),i=new reportAggregateManager({data:t}),o.observe("calcFields",function(a){for(var b=[].concat(a),c=[].concat(ReportData.availableFields),d=Object.assign({},ReportData.fieldsByName),e=0;e<b.length;e++)d[b[e].name]=b[e];c.map(function(a){return"Calculated fields"==a.title&&(a.fields=b),a}),g.set({blocks:c,fieldsByName:d});var f=b.map(function(a){return a.name});g.selectFields(f),i.set("fieldsByName",d),j.set("fieldsByName",d)}),g.observe("selectableFields",function(a){var b=Object.assign({},this.get("fieldsByName"));j.set("fieldsByName",b),i.set("fieldsByName",b),i.set("availableFields",[].concat(a))}),i.render("#ar-rv-editor-agregates")}).then(function(){return j.set("aggregates",i.get("aggregates")),j.set("availableFields",g.get("selectableFields")),ReportData.options.isCombined&&j.set("availableFieldsPossible",g.get("selectableFields")),g.observe("selectableFields",function(a){j.set("availableFields",a),ReportData.options.isCombined&&j.set("availableFieldsPossible",a)},{init:!1}),i.observe("aggregates",function(a){j.set("aggregates",a)},{init:!1}),j.render("#ar-rv-editor-groupingsorting")}).then(function(){return k=new reportAccessManager({data:w}),k.render("#ar-rv-editor-access-sharing")}).then(function(){return l=new reportScheduleManager({data:x}),l.render("#ar-rv-editor-access-scheduling")}).then(function(){return templateManager=new reportTemplateManager({data:y}),templateManager.render("#ar-rv-editor-templates")}).then(function(){return v.selectableFields=g.get("selectableFields"),v.aggregates=i.get("aggregates"),labelManager=new reportLabelManager({data:v}),g.observe("selectableFields",function(a){labelManager.set("selectableFields",a);var b=Object.assign({},this.get("fieldsByName"));labelManager.set("fieldsByName",b)},{init:!1}),i.observe("aggregates",function(a){labelManager.set("aggregates",a);var b=Object.assign({},this.get("fieldsByName"));labelManager.set("fieldsByName",b)},{init:!1}),j.observe("totalAggregates",function(a){labelManager.set("totalAggregates",a)},{init:!1}),j.observe("aggregatesAsColumn",function(a){labelManager.set("aggregatesAsColumn",a)},{init:!1}),labelManager.render("#ar-rv-editor-labels")}).then(function(){var a=!0;return(0==j.get("selectedFields").length&&0==ReportData.isCombined||0==i.get("aggregates").length)&&(a=!1),!!a&&(m=new chartTypeManager({data:{chartType:ReportData.chartType}}),m.observe("chartType",function(a){var c={el:"#ar-rv-chart-editor-labels",data:{groups:j.get("selectedFields"),aggregates:i.get("aggregates"),chartTitle:ReportData.chartTitle,fieldsByName:ReportData.fieldsByName,legend:ReportData.chartLegend,xAxis:ReportData.chartAxisX,yAxis:ReportData.chartAxisY,y2Axis:ReportData.chartAxisY2,xAxisSegment:ReportData.chartAxisXSegment,valueZones:ReportData.chartValueZones,chartSize:ReportData.chartSize,chartSizes:ReportData.chartSizes,labelName:ReportData.chartLabels,showPercents:ReportData.chartShowPercents,chartTitle:ReportData.chartTitle,showLabels:ReportData.chartShowLabels,showZoneLabels:ReportData.chartShowZoneLabels,decimalDigits:ReportData.chartDecimalDigits,chartDecimals:ReportData.chartDecimals,mapType:ReportData.mapType,country:ReportData.country,state:ReportData.state,zoom:ReportData.zoom,lat:ReportData.lat,lng:ReportData.lng,marker:ReportData.marker,markerAxisX:ReportData.markerAxisX,markerAxisY:ReportData.markerAxisY,swapAxis:ReportData.chartSwapAxis,chartColors:ReportData.chartColors,reportData:ReportData}};switch(c.legend instanceof Array||(c.legend=[c.legend]),c.yAxis instanceof Array||(c.yAxis=[c.yAxis]),a){case"gauge":c.getReportMainDataPreview=G,n=new GaugeChartLegendManager(c);break;case"funnel":n=new FunnelChartLegendManager(c);break;case"bar":n=new BarChartLegendManager(c);break;case"hbar":n=new HorizontalBarChartLegendManager(c);break;case"line":n=new LineChartLegendManager(c);break;case"combined":n=new CombinedChartLegendManager(c);break;case"map":n=new MapChartLegendManager(c);break;case"area":n=new AreaChartLegendManager(c);break;case"pie":default:n=new PieChartLegendManager(c)}n.on("preview",b),n.observe("chartTitle",function(a){ReportData.chartTitle=a;var b=this.get("chartTitle");chartView&&chartView.set("title",b)},{init:!1})}),m.observe("chartTitle",function(a){var b=this.get("chartTitle");void 0!==chartView&&chartView.set("title",b),n&&n.set("chartTitle",b)}),i.observe("aggregates",function(a){n.set("aggregates",a)}),j.observe("selectedFields",function(a){n.set("groups",a)}),g.observe("selectedFields",function(a){var b=Object.assign({},this.get("fieldsByName"));n.set("fieldsByName",b)}),m.render("#ar-rv-chart-editor-type"))}).then(function(a){labelManager.on("preview",d),g.on("preview",d),h.on("preview",d),j.on("preview",d),i.on("preview",d),k.on("preview",d),o.on("preview",d),p.on("preview",d),q.on("preview",d),templateManager.on("preview",d),d(),!1===a?(jQuery("#ar-rv-chart-editor-type").append("<h3>"+translated_labels.label_chart_not_possible+"</h3>"),jQuery("#ar-rv-chart-editor-labels").append("<h3>"+translated_labels.label_chart_not_possible+"</h3>")):(m.on("preview",b),b())}).catch(function(a){console.log(a)});var D=function(){ReportData.options.frozenColumn=jQuery("#frozenColumn").val();var a={filters:h.get("groups"),columns:g.get("selectedFields"),aggregates:i.get("aggregates"),grouping:JSON.parse(JSON.stringify(j.get("selectedFields"))),options:ReportData.options,totalAggregates:j.get("totalAggregates"),labels:ReportData.labels,showTop:getLimit(j),calcFields:o.get("calcFields"),calculatedColumns:JSON.parse(JSON.stringify(j.get("calculatedColumns")))};if("undefined"!=typeof reportDebugMode&&reportDebugMode&&(a.reportDebugMode=!0),ReportData.options.isCombined&&(a.combinedSelectedFields=j.get("combinedSelectedFields.fields")),ReportData.options.isCombined){var b=j.get("combinedSelectedFields.fields"),c=j.get("combinedSelectedFields");for(var d in b){var e=b[d];if(ReportData.fieldsByName[e]){var f={name:e,sortAction:c.sortAction,dateGrouping:c.dateGrouping,sortDirection:c.sortDirection,position:c.position};a.grouping.unshift(f)}}}return ReportData.currentResult&&ReportData.currentResult.meta&&(ReportData.currentResult.meta.limit&&(a.limit=parseInt(ReportData.currentResult.meta.limit)),ReportData.currentResult.meta.currentPage&&(a.currentPage=parseInt(ReportData.currentResult.meta.currentPage))),a},E=function(){var a=D();a.reportStates=ReportData.reportStates;var b,c;return m?(b=getChartObject(m.get("chartType")),c=b.prepareData(j,a.filters,a.columns,a.aggregates,JSON.parse(JSON.stringify(a.grouping)))):c={aggregates:"[]",grouping:"[]"},a.chartSettings={chartTitle:m?m.get("chartTitle"):"",chartType:m?m.get("chartType"):"pie",chartLabels:ReportData.chartLabels,chartAxisX:ReportData.chartAxisX,chartAxisY:ReportData.chartAxisY,chartAxisY2:ReportData.chartAxisY2,chartYAxisType:ReportData.chartYAxisType,chartYAxis2Type:ReportData.chartYAxis2Type,chartBars1Stacked:ReportData.chartBars1Stacked,chartBars2Stacked:ReportData.chartBars2Stacked,chartLegend:ReportData.chartLegend,chartStacked:ReportData.chartStacked,chartCumulated:ReportData.chartCumulated,chartSortableValues:ReportData.chartSortableValues,chartAggregates:cleanAggregates(JSON.parse(c.aggregates)),chartGrouping:JSON.parse(c.grouping),chartSize:ReportData.chartSize,chartHeight:ReportData.chartHeight,chartShowPercents:ReportData.chartShowPercents,chartValueZones:ReportData.chartValueZones,chartAxisXSegment:ReportData.chartAxisXSegment,chartShowLabels:ReportData.chartShowLabels,chartShowZoneLabels:ReportData.chartShowZoneLabels,chartDecimalDigits:ReportData.chartDecimalDigits,mapType:ReportData.mapType,country:ReportData.country,state:ReportData.state,zoom:ReportData.zoom,lat:ReportData.lat,lng:ReportData.lng,marker:ReportData.marker,markerAxisX:ReportData.markerAxisX,markerAxisY:ReportData.markerAxisY,chartSwapAxis:ReportData.chartSwapAxis,chartColors:ReportData.chartColors},a.globalSharing=k.get("globalSharing"),a.globalSharingRights=k.get("globalSharingRights"),a.userSharing=k.getSelectedAccess(),a.owner=k.get("owner"),a.isScheduled=1==l.get("isScheduled")?1:0,a.interval=l.get("interval"),a.intervalH=l.get("timeH"),a.intervalM=l.get("timeM"),a.intervalOptions=l.get("intervalOptions"),a.scheduledRecipients=l.getSelectedRecipients(),a.scheduledFormats=l.get("scheduledFormats"),ReportData.options.isCombined&&(a.combinedSelectedFields=j.get("combinedSelectedFields")),a},F=function(){var a=i.get("aggregates");ReportData.errorsAgg=-1;for(var b=0;b<a.length;b++){var c,d=a[b].selectedField,e=!0;for(c in aggregatesDefinitions)a[b].value[c]&&(e=!1);if(e){var f=3;return ReportData.options.isCombined&&(f=2),jQuery("#ar-rv-editor-tabs").tabs("option","active",f),ReportData.errorsAgg=b,jQuery("body").trigger("aggregateError"),!1}}if(jQuery("body").trigger("aggregateError"),ReportData.options.includeDetails)ReportData.errors=-1,jQuery("body").trigger("totalTableError");else{for(var g=-1,h=ReportData.fieldGroupingSorting.length-1;h>-1;){if("row"==ReportData.fieldGroupingSorting[h].position||!ReportData.fieldGroupingSorting[h].position){g=h;break}h-=1}if(g>-1){var j=0;for(b=0;b<a.length;b++){var d=a[b].selectedField;ReportData.fieldGroupingSorting[g].showAggregates[d]?(a[b].value.min&&!ReportData.fieldGroupingSorting[g].showAggregates[d].min&&j++,a[b].value.max&&!ReportData.fieldGroupingSorting[g].showAggregates[d].max&&j++,a[b].value.sum&&!ReportData.fieldGroupingSorting[g].showAggregates[d].sum&&j++,a[b].value.count&&!ReportData.fieldGroupingSorting[g].showAggregates[d].count&&j++,a[b].value.avg&&!ReportData.fieldGroupingSorting[g].showAggregates[d].avg&&j++):j++}if(a.length==j){alert(translated_labels.label_select_one+" "+ReportData.fieldGroupingSorting[g].title);var f=4;return ReportData.options.isCombined&&(f=3),jQuery("#ar-rv-editor-tabs").tabs("option","active",f),ReportData.errors=g,jQuery("body").trigger("totalTableError"),!1}ReportData.errors=-1,jQuery("body").trigger("totalTableError")}else ReportData.errors=-1,jQuery("body").trigger("totalTableError")}var k=!1;if(ReportData.options.isCrosstab){for(h=ReportData.fieldGroupingSorting.length-1;h>-1;){if("column"==ReportData.fieldGroupingSorting[h].position){k=!0;break}h-=1}if("column"==ReportData.combinedSelectedFields.position&&(k=!0),!k)return alert(translated_labels.label_at_least_column),!1}return!0},G=function(){return D()};d=function(){if(F()){var a=G();jQuery(".ar-loading").show(),jQuery.post(ReportData.url+ReportData.id,reportUtils.convertToJSONPost(a),showData(i.get("aggregates"),j.get("selectedFields"),ReportData.options.includeDetails,g,j,p,q,o))}};var H=["globalSharing","globalSharingRights","owner","isScheduled","interval","intervalH","intervalM","intervalOptions","scheduledRecipients"];e=function(){if(F()){var a=E();jQuery.post(ReportData.saveUrl+ReportData.id,reportUtils.convertToJSONPost(a,H),function(a){alert(a),window.location.reload()})}},f=function(){if(F()){var a=E();a=reportUtils.convertToJSONPost(a,H),a.saveAs=1;var b='<div style="padding-top:10px;"><label>'+translated_labels.label_report_name+': <input style="width: 280px;" type="text" name="reportName" /></label><br/>';b+="<label>"+translated_labels.label_report_folder+': <select style="width: 280px;" name="reportFolder">';for(var c in report_folders)isNaN(c)||(b+="<option ",current_folder==c&&(b+='selected="selected"'),b+="value="+c+">"+report_folders[c]+"</option>");b+="</select></label><br/><br/><label>"+translated_labels.label_report_description+': <textarea style="width: 280px;" name="reportDescription"></textarea></label></div>';new SaveDataAs({data:a,partials:{modalContent:b}})}};var I=new reportButtons({el:"#reportControls",append:!0});I.on("save",e),I.on("saveAs",f),I.on("delete",function(){1==confirm(translated_labels.label_sure_to_delete)&&(window.location="index.php?module=AnalyticReporting&action=Delete&record="+ReportData.id)}),I.on("back",function(){window.location="index.php?module=AnalyticReporting&action=index"}),jQuery("#ar-rv-editor-title").click(function(){new EditTitle({data:{title:jQuery("#reportTitle").text(),description:jQuery("#reportDescription").text()},partials:{modalContent:'<div style="padding-top:10px;"><label>'+translated_labels.label_report_name+': <input style="width: 280px;" type="text" name="reportName" value="{{title}}" /></label><br/><label>'+translated_labels.label_report_description+': <textarea style="width: 280px;" name="reportDescription">{{description}}</textarea></label></div>'}})}),jQuery("#exportChartAs").live("click",function(a){a.preventDefault(),jQuery("#chart1 svg").attr("width",jQuery("#chart1 svg").width()),jQuery("#chart1 svg").attr("height",jQuery("#chart1 svg").height()),jQuery("#chart1 svg").attr("id","svg"),"map"==ReportData.chartType?jQuery(window).trigger("exportImage",jQuery(this)):saveSvgAsPng(document.getElementById("svg"),"chart.png",1)}),jQuery("#addToDashboard").live("click",function(a){a.preventDefault(),jQuery.post(ReportData.getAllowedAddToDashboardRolesUrl,{reportID:ReportData.id},function(a){var b=JSON.parse(a);if(b.length>0)new AddToDashboard({data:{availableRoles:b}});else{var a={reportID:ReportData.id,chartTitle:ReportData.chartTitle};jQuery.post(ReportData.addToDashboardUrl,a,function(){alert(translated_labels.label_chart_added_to_dashboard)})}})}),jQuery(".loadXLSX").click(function(){var a=G();return a.options.excelWithHeaders=!1,postToURL(ReportData.urlXLS+ReportData.id,reportUtils.convertToJSONPost(a)),!1}),jQuery(".loadXLSXHeaders").click(function(){var a=G();return a.options.excelWithHeaders=!0,postToURL(ReportData.urlXLS+ReportData.id,reportUtils.convertToJSONPost(a)),!1}),jQuery(".loadPDF").click(function(){var a=G();return postToURL(ReportData.urlPDF+ReportData.id,reportUtils.convertToJSONPost(a)),!1}),jQuery(".loadPDFXLS").click(function(){var a=G();return postToURL(ReportData.urlPDFXLS+ReportData.id,reportUtils.convertToJSONPost(a)),!1}),jQuery("#printReport").click(function(){var a=jQuery("#ar-rv-chart-view > h5:first > a.toggle");a.hasClass("asc")&&a.click(),setTimeout(window.print,200)}),jQuery("#printReportChart").click(function(){var a=jQuery("#ar-rv-chart-view > h5:first > a.toggle");a.hasClass("desc")&&a.click(),setTimeout(window.print,200)})}),Ractive.decorators.select2.type.filter={width:"resolve",dropdownAutoWidth:!0};var multiSelectDecorator=function(a,b){var c,d,e=a._ractive.root,f=!1,g={header:!1,selectedList:1,click:function(){window.setTimeout(function(){jQuery(a).multiselect("refresh")},0)}};if(jQuery(a).multiselect(g),e.observe("disableSelectBox",function(b){b?jQuery(a).multiselect("disable"):jQuery(a).multiselect("enable")},{init:!1}),a._ractive.binding){var h=function(){f||(f=!0,window.setTimeout(function(){jQuery(a).change(),jQuery(a).multiselect("refresh"),f=!1},0))};c=e.observe(a._ractive.binding.keypath,h),d=e.observe("optionGroups",h)}return jQuery(a).multiselect(g).on("change",function(){f||(f=!0,e.updateModel(),f=!1)}),{teardown:function(){jQuery(a).multiselect("destroy"),c&&(c.cancel(),d.cancel())}}},selectBoxCache={},selectBox=Ractive.extend({template:function(a){if(void 0===selectBoxCache[a.valueName+"|"+a.titleName+"|"+a.addDecorator]){var b="";a.addDecorator&&""!=a.addDecorator&&(b='decorator="'+a.addDecorator+'"'),selectBoxCache[a.valueName+"|"+a.titleName]=Ractive.parse("<select "+b+' value="{{selected}}" disabled="{{readOnly}}">{{#options}}<option value="{{'+a.valueName+'}}" title="{{'+a.descriptionName+'}}">{{'+a.titleName+"}}</option>{{/options}}</select>")}return selectBoxCache[a.valueName+"|"+a.titleName]},oncomplete:function(){var a=this.get();if(a.autoSelectFirst){var b=this,c=function(c){for(var d=!1,e=0;e<c.length;e++)if(c[e][a.valueName]==a.selected){d=!0;break}!d&&c.length>0&&b.set("selected",a.options[0][a.valueName])};c(a.options),this.observe("options",c,{init:!1})}},data:{selected:null,options:[],titleName:"",valueName:"",descriptionName:"",addDecorator:"",autoSelectFirst:!0,readOnly:!1},modifyArrays:!1}),selectBoxImg=Ractive.extend({template:"#selectBoxImgTemplate",oncomplete:function(){var a=!1,b=this.get("autoSelect"),c=this.get("selected"),d=this.get("options"),e=this.get("valueName");b&&""===c&&this.set("selected",d[0][e]);var f=this.find("select"),g=this;jQuery(f).ddslick({width:250,height:300,background:"transparent",imagePosition:"left",onSelected:function(b){if(a){for(var c=0,d=ReportData.selectedAggregates.length-1;d>=0;d--){var e;for(e in aggregatesDefinitions)ReportData.selectedAggregates[d].value[e]&&c++}"Combined"!=b.selectedData.text||ReportData.fieldGroupingSorting.length>0&&c>1?(g.get("selected")!=b.selectedData.value&&jQuery("#ar-rv-chart-editor-tabs").tabs("option","active",1),g.set("selected",b.selectedData.value)):alert(translated_labels.label_chart_error)}}}),setTimeout(function(){for(var b=0,c=ReportData.selectedAggregates.length-1;c>=0;c--){var d;for(d in aggregatesDefinitions)ReportData.selectedAggregates[c].value[d]&&b++}0==ReportData.fieldGroupingSorting.length||b<2?(jQuery(".dd-options").children()[3].style.backgroundColor="lightgrey;",jQuery(".dd-options").children()[3].children[0].backgroundColor="lightgrey;"):(jQuery(".dd-options").children()[3].backgroundColor="white;",jQuery(".dd-options").children()[3].children[0].backgroundColor="white;"),a=!0},3e3)},data:{options:[],selected:"",autoSelect:!0,id:""}}),multiSelectBox=Ractive.extend({template:"#multiSelectBoxTemplate",oninit:function(){},oncomplete:function(){var a=this,b=function(){var b=a.get("selected"),c=a.getDisabledValues(b),d=a.get("options"),e=a.convertData(d,"key","values","name","title",c,b),f=!1;JSON.stringify(e.options)!==JSON.stringify(a.get("optionGroups"))&&(f=!0),a.set("optionGroups",e.options).then(function(){if(JSON.stringify(e.selected)===JSON.stringify(a.get("selected")))return!0;f=!0}).then(function(){f&&setTimeout(function(){a.fire("selectChanged")},10)})};this.observe("options",b,{init:!1}),this.observe("selected",function(a){this.data.selected=a,b()},{init:!1}),b()},getDisabledValues:function(a){for(var b=this.get("aggregates"),c=this.get("groups"),d=[],e=!1,f=!1,g=0;g<a.length;g++){if(c.length>0)for(var h=0;h<c.length;h++)if(a[g]==c[h].name){e=!0;break}if(ReportData.options.isCombined&&"date_field"==a[g]){e=!0;break}if(b.length>0)for(var h=0;h<b.length;h++){var i;for(i in aggregatesDefinitions)if(b[h].value[i]&&a[g]==b[h].selectedField+aggregatesDefinitions[i].namePostfix){f=!0;break}if(f)break}}if(e){for(var g=0;g<b.length;g++){var i;for(i in aggregatesDefinitions)b[g].value[i]&&d.push(b[g].selectedField+aggregatesDefinitions[i].namePostfix)}for(var g=0;g<a.length;g++){for(var h=0;h<c.length;h++)a[g]!=c[h].name&&d.push(c[h].name);ReportData.options.isCombined&&"date_field"!=a[g]&&d.push("date_field")}}if(f){for(var g=0;g<c.length;g++)d.push(c[g].name);ReportData.options.isCombined&&d.push("date_field")}return d},convertData:function(a,b,c,d,e,f,g){for(var h=[],i=[],j=0;j<a.length;j++){for(var k=[],l=0;l<a[j][c].length;l++){var m=!1;-1!==jQuery.inArray(a[j][c][l][d],f)&&(m=!0);m||-1===jQuery.inArray(a[j][c][l][d],g)||(!0,i.push(a[j][c][l][d])),k.push({value:a[j][c][l][d],title:a[j][c][l][e],disabled:m})}h.push({title:a[j][b],items:k})}return h={options:h,selected:i}},decorators:{multiSelect:multiSelectDecorator},data:{options:[],selected:"",optionGroups:[],disabledValues:[],disabledSelectBox:!1,groups:[],aggregates:[]}}),reportUtils={appendDateGrouping:function(a,b){return void 0===a.cols[b]&&(void 0!==a.cols[b+"_year"]?b+="_year":void 0!==a.cols[b+"_quarter"]?b+="_quarter":void 0!==a.cols[b+"_quarterAndYear"]?b+="_quarterAndYear":void 0!==a.cols[b+"_month"]?b+="_month":void 0!==a.cols[b+"_monthAndYear"]?b+="_monthAndYear":void 0!==a.cols[b+"_week"]?b+="_week":void 0!==a.cols[b+"_weekAndYear"]?b+="_weekAndYear":void 0!==a.cols[b+"_day"]&&(b+="_day")),b},generateFieldsByNameFromBlocks:function(a){for(var b={},c=0;c<a.length;c++)for(var d=0;d<a[c].fields.length;d++)b[a[c].fields[d].name]=a[c].fields[d];return b},isMultiSummaryReport:function(a,b,c,d){d=d||!1;for(var e=[],f=0;f<b.length;f++){var g=b[f],h=g.showAggregates;if("column"!=g.position||!d)for(var i=0;i<a.length;i++){var j=h[a[i].selectedField];if(j){var k,l=!1;for(k in aggregatesDefinitions)j[k]&&(l=!0);l&&e.push(!0)}}}return c||e.pop(),e.length>0},convertToJSONPost:function(a,b){var c={};b=b||[];for(var d=Object.keys(a),e=0;e<d.length;e++)-1==b.indexOf(d[e])?c[d[e]]=JSON.stringify(a[d[e]]):c[d[e]]=a[d[e]];return c},getAvailableGroups:function(a,b,c){for(var d=[],e=0;e<b.length;e++)if(-1!=["group","groupsort","nogroup"].indexOf(b[e].sortAction)){var f=jQuery.extend(!0,{},b[e]),g=f.aggregate;f.title=f.fieldLabel,c[g]&&(f.title=c[g].title),f.dateGrouping&&(f.title+=" "+a.dictionary["label_"+reportUtils.toSnakeCase(f.dateGrouping)],f.name=g+"_"+f.dateGrouping),d.push(f)}return a.options.isCombined&&d.unshift({name:"date_field",title:a.dictionary.label_date,showAggregates:{},sortAction:"group",sortDirection:"DESC",aggregate:"",position:"",dateGrouping:""}),d=_.uniq(d,function(a){return a.name})},makeAvailableFields:function(a){for(var b=[],c=0;c<a.length;c++)for(var d=0;d<a[c].fields.length;d++)b.push(a[c].fields[d]);return b},makeFieldsByName:function(a){for(var b={},c=0;c<a.length;c++)for(var d=0;d<a[c].fields.length;d++)b[a[c].fields[d].name]=a[c].fields[d];return b},getAggregate:function(a,b){for(var c=!1,d=0;d<b.length;d++){var e;for(e in aggregatesDefinitions)b[d].value[e]&&b[d].selectedField+aggregatesDefinitions[e].namePostfix==a&&(c=!0);if(c)return b[d]}},getGroup:function(a,b){for(var c=0;c<b.length;c++){var d=b[c].name;if(b[c].dateGrouping&&(d+="_"+b[c].dateGrouping),d==a||b[c].name==a)return b[c]}},findKey:function(a,b){for(var c in a)if(a[c]==b)return c;return null},unique:function(a){var b=[];return jQuery.each(a,function(a,c){-1==jQuery.inArray(c,b)&&b.push(c)}),b},toSnakeCase:function(a){return a.replace(/([A-Z])/g,function(a){return"_"+a.toLowerCase()})},toTitleCase:function(a){return a.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()})},setFieldsByName:function(){if(ReportData.options.isCombined){for(var a=0;a<ReportData.availableFields.length;a++)for(var b=0;b<ReportData.availableFields[a].fields.length;b++)ReportData.availableFields[a].fields[b].moduleId=ReportData.availableFields[a].fields[b].name.split("_")[0];for(var a=0;a<ReportData.selectableFields.length;a++)for(var b=0;b<ReportData.selectableFields[a].fields.length;b++)ReportData.selectableFields[a].fields[b].moduleId=ReportData.selectableFields[a].fields[b].name.split("_")[0];ReportData.fieldGroupingSorting=ReportData.fieldGroupingSorting.filter(function(a){return void 0!==a.showAggregates})}var c=[];return void 0!==ReportData.options.isCombined&&(ReportData.options.isCombined?(c=reportUtils.makeAvailableFields(ReportData.selectableFields),ReportData.fieldsByName=reportUtils.makeFieldsByName(ReportData.selectableFields)):(c=reportUtils.makeAvailableFields(ReportData.availableFields),ReportData.fieldsByName=reportUtils.makeFieldsByName(ReportData.availableFields))),c}},NumberFormatter=function(a,b){var c=jQuery.extend({},{format:"",seperator:"'",decimal:".",numdec:currentUser.numberPreferences.currencySignificantDigits},a);this.format=c.format,this.decimal=c.decimal,this.seperator=c.seperator,this.aggregates=b,this.numdec=c.numdec,this.integerFields=this.getIntegerFields(),this.integerAggregates=this.getIntegerAggregates()};NumberFormatter.prototype.format="",NumberFormatter.prototype.decimal=".",NumberFormatter.prototype.seperator="'",NumberFormatter.prototype.makeFormatter=function(){var a=this;switch(this.format){case"123,456,789":return function(b,c,d,e,f){try{a.validateNumber(d)}catch(a){return d||""}return d=a.roundByType(d,e,f),a.by3Formatter(d)};case"12,34,56,789":return function(b,c,d,e,f){try{a.validateNumber(d)}catch(a){return d||""}return d=a.roundByType(d,e,f),a.by3then2Formatter(d)};case"123456,789":return function(b,c,d,e,f){try{a.validateNumber(d)}catch(a){return d||""}return d=a.roundByType(d,e,f),a.first3Formatter(d)};case"123456789":default:return function(b,c,d,e,f){try{a.validateNumber(d)}catch(a){return d||""}return d=a.roundByType(d,e,f),a.noFormatter(d)}}},NumberFormatter.prototype.changeDecimalSymbol=function(a){var b="";return a.length>1&&(b=this.decimal+a[1]),b},NumberFormatter.prototype.validateNumber=function(a){if(null==a)throw"";if(!this.isNumber(a))throw a;if(a.length&&!a[0].match("[0-9]"))throw a},NumberFormatter.prototype.by3Formatter=function(a){var b=a.split("."),c=this.changeDecimalSymbol(b);return b[0].length>3&&(b[0]=this.by3(b[0])),b[0]+c},NumberFormatter.prototype.by3then2Formatter=function(a){var b=a.split("."),c=this.changeDecimalSymbol(b);return b[0].length>3&&(b[0]=this.by3then2(b[0])),b[0]+c},NumberFormatter.prototype.first3Formatter=function(a){var b=a.split("."),c=this.changeDecimalSymbol(b);return b[0].length>3&&(b[0]=this.first3(b[0])),b[0]+c},NumberFormatter.prototype.noFormatter=function(a){var b=a.split("."),c=this.changeDecimalSymbol(b);return b[0].length>3&&(b[0]=this.noFormat(b[0])),b[0]+c},NumberFormatter.prototype.separator=function(){var a=this;switch(this.format){case"123,456,789":return function(b,c,d,e,f){try{a.validateNumber(d)}catch(a){return d||""}return a.by3Formatter(String(d))};case"12,34,56,789":return function(b,c,d,e,f){try{a.validateNumber(d)}catch(a){return d||""}return a.by3then2Formatter(String(d))};case"123456,789":return function(b,c,d,e,f){try{a.validateNumber(d)}catch(a){return d||""}return a.first3Formatter(String(d))};case"123456789":default:return function(b,c,d,e,f){try{a.validateNumber(d)}catch(a){return d||""}return a.noFormatter(String(d))}}},NumberFormatter.prototype.noFormat=function(a){return a},NumberFormatter.prototype.by3=function(a){for(var b=a.split("").reverse(),c=[],d=1;d<b.length;d++)c.push(b[d-1]),d%3==0&&c.push(this.seperator);return c.push(b[b.length-1]),c.reverse().join("")},NumberFormatter.prototype.by3then2=function(a){for(var b=a.split("").reverse(),c=[],d=1;d<b.length&&d<4;d++)c.push(b[d-1]),d%3==0&&c.push(this.seperator);for(var d=4;d<b.length;d++)c.push(b[d-1]),d-4&&(d-1)%2==0&&c.push(this.seperator);return c.push(b[b.length-1]),c.reverse().join("")},NumberFormatter.prototype.first3=function(a){var b=a.split(""),c=b.splice(-3,3);return b.length>0&&(c=b.join("")+this.seperator+c.join("")),c},NumberFormatter.prototype.isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},NumberFormatter.prototype.isCountAggregate=function(a,b){var c=a.substr(a.lastIndexOf("_")+1),d=["sum","min","max","avg"];if("cnt"==c||"countDistinct"==c)return!0;if(d.indexOf(c)>-1)return!1;if(void 0!==b&&ReportData.options.aggregateColumn)return!!b.aggregates&&0==b.aggregates.indexOf("Count(");for(var e=0;e<ReportData.selectedAggregates.length;e++)if(a.indexOf(ReportData.selectedAggregates[e].selectedField)>-1)return ReportData.selectedAggregates[e].value.count;return!1},NumberFormatter.prototype.getIntegerFields=function(){for(var a=[],b=0;b<ReportData.availableFields.length;b++)for(var c=0;c<ReportData.availableFields[b].fields.length;c++)"integer"==ReportData.availableFields[b].fields[c].type&&a.push(ReportData.availableFields[b].fields[c].name);return a},NumberFormatter.prototype.getIntegerAggregates=function(){for(var a=[],b=0;b<ReportData.selectedAggregates.length;b++){var c=ReportData.selectedAggregates[b];this.integerFields.indexOf(c.selectedField)>-1&&(c.value.sum&&a.push(ReportData.labels[c.selectedField+"_sum"]),c.value.max&&a.push(ReportData.labels[c.selectedField+"_max"]),c.value.min&&a.push(ReportData.labels[c.selectedField+"_min"]))}return a},NumberFormatter.prototype.isIntegerType=function(a,b){if(void 0!==b&&ReportData.options.aggregateColumn)return this.integerAggregates.indexOf(b.aggregates)>-1;for(var c=0;c<this.integerFields.length;c++)if(a.indexOf("_avg")<0&&a.indexOf(this.integerFields[c])>-1)return!0},NumberFormatter.prototype.roundByType=function(a,b,c){return void 0!==b&&(this.isCountAggregate(b.field,c)||this.isIntegerType(b.field,c))&&"avg"!=c?(Math.round(100*parseFloat(a))/100).toFixed(0):Number(Math.round(a+"e+"+this.numdec)+"e-"+this.numdec).toFixed(this.numdec)};var validateXAxis=function(a){for(var b=this.get("getAvailableGroups"),c=!1,d=0;d<b.length;d++)if(a==b[d].name){c=!0;break}var e=a;c||b.length>0&&(e=b[0].name,this.set("xAxis",e)),ReportData.chartAxisX=e};String.prototype.endsWith||(String.prototype.endsWith=function(a,b){return(void 0===b||b>this.length)&&(b=this.length),this.substring(b-a.length,b)===a});var reportBtn=Ractive.extend({template:'<a href="javascript:void(0);" class="ar-button {{className}}" on-click="clicked">{{text}}</a>',data:{text:"",className:""}}),reportBtnGC=Ractive.extend({template:'<a href="javascript:void(0);" on-click="clicked" class="tooltipX"><img src="modules/AnalyticReporting/assets/img/cross_g.png"/><span>{{text}}</span></a>',data:{text:""}}),includeDetails=Ractive.extend({template:'<label style="vertical-align:middle;"><input class="includeDetailsCheckbox" type="checkbox" on-change="changed" checked="{{checked}}" /> {{text}}</label> (<a onclick="pop_include_details();" class="tooltipX" href="#">?<span>'+translated_labels.label_tooltip_msg_1+"</span></a>)",oninit:function(){var a=this;this.observe("checked",function(a){ReportData.options.includeDetails=a,jQuery("body").trigger("includedDetails")}),jQuery("body").on("includedDetails",function(){a.set("checked",ReportData.options.includeDetails)}),this.observe("isCrosstab",function(b){1==ReportData.options.isCrosstab&&a.set("checked",!1)})},data:{text:translated_labels.label_include_details,checked:ReportData.options.includeDetails}}),isCrosstab=Ractive.extend({template:'<label style="vertical-align:middle;"><input id="isCrosstabCheckbox" type="checkbox" checked="{{val}}" /> {{text}}</label> (<a onclick="pop_crosstab();" class="tooltipX" href="#">?<span>'+translated_labels.label_tooltip_msg_2+'</span></a>) {{#val}}<label style="vertical-align:middle;"><input type="checkbox" checked="{{aggregatesAsColumnVal}}" /> {{textCol}}</label>\x3c!-- (<a onclick="pop_aggregates_as_column();" class="tooltipX" href="#">?<span>'+translated_labels.label_tooltip_msg_3+'</span></a>)--\x3e<label style="vertical-align:middle;"><input type="checkbox" checked="{{emptyAsZero}}" /> {{textZero}}</label>{{/val}}',oninit:function(){var a=this;this.observe("val",function(a){ReportData.options.isCrosstab=a,a?(ReportData.options.includeDetails=!1,jQuery("body").trigger("includedDetails")):(this.set("aggregatesAsColumnVal",!1),this.set("emptyAsZero",!1))}),this.observe("aggregatesAsColumnVal",function(a){ReportData.options.aggregateColumn=a}),this.observe("emptyAsZero",function(a){ReportData.options.emptyAsZero=a}),jQuery("body").on("includedDetails",function(){1==ReportData.options.includeDetails&&a.set("val",!1)})},data:{text:translated_labels.label_is_crosstab,textCol:translated_labels.label_aggregates_as_column,textZero:translated_labels.label_empty_as_zero,val:ReportData.options.isCrosstab,aggregatesAsColumnVal:!!ReportData.options.aggregateColumn&&ReportData.options.aggregateColumn}}),reportButtons=Ractive.extend({template:"#reportButtonsTemplate",components:{reportBtn:reportBtn}}),reportButtonPreview=Ractive.extend({template:'<reportBtn text="'+translated_labels.label_preview+'" on-clicked="preview" className="green"/> <img class="ar-loading" src="modules/AnalyticReporting/assets/css/select2-spinner.gif" alt="Loading..." />',components:{reportBtn:reportBtn}}),SaveDataAs=Ractive.extend({el:jQuery("#modalWindow"),append:!1,template:"{{>modalContent}}",data:{},oninit:function(){data=this.get(),jQuery("#modalWindow").dialog({modal:!0,draggable:!1,resizable:!1,title:translated_labels.label_save_report_as,buttons:[{text:translated_labels.label_save,click:function(){var a=this,b=jQuery(this).find("[name=reportName]").val(),c=jQuery(this).find("[name=reportDescription]").val(),d=jQuery(this).find("[name=reportFolder]").val();data.title=b,data.description=c,data.reportFolder=d,jQuery.post(ReportData.saveUrl+ReportData.id,data,function(b){b=JSON.parse(b),ReportData.id=b.id,jQuery(a).dialog("close"),window.location="index.php?module=AnalyticReporting&action=report&record="+ReportData.id})}},{text:translated_labels.label_cancel,click:function(){jQuery(this).dialog("close")}}]})}}),EditTitle=Ractive.extend({el:jQuery("#modalWindow"),append:!1,template:"{{>modalContent}}",data:{},oninit:function(){var a=this.get();jQuery("#modalWindow").dialog({modal:!0,draggable:!1,resizable:!1,title:"   ",buttons:[{text:translated_labels.label_save,click:function(){var b=jQuery(this).find("[name=reportName]").val(),c=jQuery(this).find("[name=reportDescription]").val();a.title=b,a.description=c,a.changeTitle=1,jQuery("#reportTitle").text(b),jQuery("#reportDescription").text(c),jQuery(this).dialog("close"),jQuery.post(ReportData.saveUrl+ReportData.id,a,function(){})}},{text:translated_labels.label_cancel,click:function(){jQuery(this).dialog("close")}}]})}}),AddToDashboard=Ractive.extend({el:jQuery("#modalWindow"),append:!1,template:"#addToDashboardModal",data:{},oninit:function(){jQuery("#modalWindow").dialog({minWidth:420,modal:!0,draggable:!1,resizable:!1,title:translated_labels.label_add_to_dashboard,buttons:[{text:translated_labels.label_add_to_dashboard,click:function(){var a={reportID:ReportData.id,chartTitle:ReportData.chartTitle},b=jQuery(this).find("[name=chosenRoleID]").val(),c=jQuery(this).find("[name=addType]:checked").val();a.chosenRoleID=b,a.addType=c,jQuery(this).dialog("close"),jQuery.post(ReportData.addToDashboardUrl,a,function(){alert(translated_labels.label_chart_added_to_dashboard)})}},{text:translated_labels.label_cancel,click:function(){jQuery(this).dialog("close")}}]})}}),reportLabelManager=Ractive.extend({template:"#reportLabelsTemplate",onrender:function(){var a=this;ReportData.labels&&a.set("labels",this.transformToArray(ReportData.labels)),a.observe("selectableFields",function(b){a.set("labels",a.buildLabels(b,!1,!1,!1))}),a.observe("aggregates",function(b){a.set("labels",a.buildLabels(!1,b,!1,!1))}),a.observe("totalAggregates",function(b){a.set("labels",a.buildLabels(!1,!1,b,!1))}),a.observe("aggregatesAsColumn",function(b){a.set("labels",a.buildLabels(!1,!1,!1,b))}),a.observe("labels",function(b){ReportData.labels=a.transformToObject(b)},{init:!1})},buildLabels:function(a,b,c,d){var e=this,f=[],g=e.get("fieldsByName");a=a||e.get("selectableFields"),b=b||e.get("aggregates"),c=c||e.get("totalAggregates"),d=d||e.get("aggregatesAsColumn");for(var h=0;h<a.length;h++){var i=a[h],j=i.bareTitle,k="";if("m00_ALL_assigned_user_id"!=i.name&&(k="Calculated","__virtual__"!==i.table&&(k=i.title.match(/\(([^)]+)\)/)[1])),e.get("isCombined")&&k.length>0)var j=k+" "+i.bareTitle;var l=j,m=e.findLabelsValueByKey(i.name);m&&"__virtual__"!==i.table&&(l=m);var n={key:i.name,value:l,origValue:j};f.push(n)}for(var h=0;h<b.length;h++){_aggregateTypes=[];var o;for(o in aggregatesDefinitions)_aggregateTypes.push({name:aggregatesDefinitions[o].name,label:translated_labels[aggregatesDefinitions[o].label],isSet:b[h].value[o]});for(var p=0;p<_aggregateTypes.length;p++)if(_aggregateTypes[p].isSet){var i=g[b[h].selectedField],k="Calculated";if("__virtual__"!==i.table){var q=i.title.match(/\(([^)]+)\)/);k=i.title,null!=q&&q.length>=2&&(k=i.title.match(/\(([^)]+)\)/)[1])}var r=i.bareTitle,o=b[h].selectedField+"_"+_aggregateTypes[p].name,j=_aggregateTypes[p].label+"("+r+")";e.get("isCombined")&&(j=k+" "+j);var l=j,m=e.findLabelsValueByKey(o);m&&(l=m);var n={key:o,value:l,origValue:j};f.push(n)}}var s=!1;for(_ag in c){var o,t=c[_ag];for(o in aggregatesDefinitions)if(t[o]){s=!0;break}if(s)break}if(s){var o="grandTotal",j=translated_labels.label_grand_total,l=j,m=e.findLabelsValueByKey(o);m&&(l=m);var n={key:o,value:l,origValue:j};f.push(n)}if(e.get("isCombined")){var o="date_field",j=translated_labels.label_date,l=j,m=e.findLabelsValueByKey(o);m&&(l=m);var n={key:o,value:l,origValue:j};f.push(n)}if(d){var o="aggregates",j=translated_labels.label_aggregates,l=j,m=e.findLabelsValueByKey(o);m&&(l=m);var n={key:o,value:l,origValue:j};f.push(n)}return f},findLabelsValueByKey:function(a){for(var b=this,c=b.get("labels"),d=0;d<c.length;d++)if(c[d].key==a)return c[d].value;return!1},findValueByKey:function(a){for(var b=this,c=b.get("aggregates"),d=b.get("selectableFields"),e=0;e<c.length;e++)if(c[e].selectedField==a)return c[e].bareTitle;for(var e=0;e<d.length;e++)if(d[e].fields){var f=d[e].fields.length;if(f>0)for(var g=0;g<f;g++){var h=d[e].fields[g];if(h.name==a)return h.bareTitle}}return!1},transformToObject:function(a){for(var b={},c=0;c<a.length;c++)b[a[c].key]=a[c].value;return b},transformToArray:function(a){var b=this,c=[];for(var d in a){var e=b.findValueByKey(d);e||(e=a[d]);var f={key:d,value:a[d],origValue:e};c.push(f)}return c},data:{labels:[],selectableFields:[],aggregates:[],fieldsByName:{},aggregatesAsColumn:!1,totalAggregates:[],isCombined:!1},components:{reportButtonPreview:reportButtonPreview},modifyArrays:!1}),fieldSelector=Ractive.extend({template:'<select value="{{selectedField}}" decorator="select2:filter" disabled="{{readOnly}}">{{{fieldHTML}}}</select>',data:{selectedField:"",fieldHTML:"",readOnly:!1}}),fieldConnector=Ractive.extend({template:'<selectBox selected="{{connector}}" options="{{connectors}}" titleName="title" valueName="name" readOnly="{{readOnly}}" />',data:{connectors:[{name:"AND",title:translated_labels.label_and},{name:"OR",title:translated_labels.label_or}],connector:"AND",readOnly:!1},components:{selectBox:selectBox}}),fieldCondition=Ractive.extend({template:'<selectBox class="sortGroup" selected="{{condition}}" options="{{ filterConditions (fieldType ) }}" titleName="title" valueName="type" readOnly="{{readOnly}}" />',oninit:function(){this.observe("fieldType",function(){})},conditions:[{title:translated_labels.label_is,type:"eq",fieldtype:["txt","select","number","integer","date","datetime","time","user","team","teams"]},{title:translated_labels.label_isnt,type:"neq",fieldtype:["txt","select","number","integer","date","datetime","time","user","team","teams"]},{title:translated_labels.label_contains,type:"cont",fieldtype:["txt","select"]},{title:translated_labels.label_doesnt_contain,type:"ncont",fieldtype:["txt","select"]},{title:translated_labels.label_starts_with,type:"start",fieldtype:["txt"]},{title:translated_labels.label_ends_with,type:"end",fieldtype:["txt"]},{title:translated_labels.label_is_empty,type:"empty",fieldtype:["txt","select","number","integer","date","datetime","time","user","team","teams"]},{title:translated_labels.label_isnt_empty,type:"filled",fieldtype:["txt","select","number","integer","date","datetime","time","user","team","teams"]},{title:translated_labels.label_is_before,type:"before",fieldtype:["date","datetime"]},{title:translated_labels.label_is_after,type:"after",fieldtype:["date","datetime"]},{title:translated_labels.label_between,type:"between",fieldtype:["date","datetime"]},{title:translated_labels.label_not_between,type:"nbetween",fieldtype:["date","datetime"]},{title:translated_labels.label_today,type:"today",fieldtype:["date","datetime"]},{title:translated_labels.label_tomorrow,type:"tomorrow",fieldtype:["date","datetime"]},{title:translated_labels.label_tomorrow_onwards,type:"aftert",fieldtype:["date","datetime"]},{title:translated_labels.label_yesterday,type:"yesterday",fieldtype:["date","datetime"]},{title:translated_labels.label_until_yesterday,type:"tilly",fieldtype:["date","datetime"]},{title:translated_labels.label_next_days,type:"ndays",fieldtype:["date","datetime"]},{title:translated_labels.label_passed_days,type:"pdays",fieldtype:["date","datetime"]},{title:translated_labels.label_greater_than_days,type:"gtdays",fieldtype:["date","datetime"]},{title:translated_labels.label_less_than_days,type:"ltdays",fieldtype:["date","datetime"]},{title:translated_labels.label_year,type:"year",fieldtype:["date","datetime"]},{title:translated_labels.label_quarter,type:"quarter",fieldtype:["date","datetime"]},{title:translated_labels.label_month,type:"month",fieldtype:["date","datetime"]},{title:translated_labels.label_week,type:"week",fieldtype:["date","datetime"]},{title:translated_labels.label_week_and_year,type:"weekAndYear",fieldtype:["date","datetime"]},{title:translated_labels.label_month_and_year,type:"monthAndYear",fieldtype:["date","datetime"]},{title:translated_labels.label_quarter_and_year,type:"quarterAndYear",fieldtype:["date","datetime"]},{title:translated_labels.label_day,type:"day",fieldtype:["date","datetime"]},{title:translated_labels.label_this_week,type:"tweek",fieldtype:["date","datetime"]},{title:translated_labels.label_last_week,type:"lweek",fieldtype:["date","datetime"]},{title:translated_labels.label_this_month,type:"tmonth",fieldtype:["date","datetime"]},{title:translated_labels.label_last_month,type:"lmonth",fieldtype:["date","datetime"]},{title:translated_labels.label_this_year,type:"tyear",fieldtype:["date","datetime"]},{title:translated_labels.label_last_year,type:"lyear",fieldtype:["date","datetime"]},{title:translated_labels.label_next_quarter,type:"nquarter",fieldtype:["date","datetime"]},{title:translated_labels.label_this_quarter,type:"tquarter",fieldtype:["date","datetime"]},{title:translated_labels.label_last_quarter,type:"lquarter",fieldtype:["date","datetime"]},{title:translated_labels.label_next_week,type:"nweek",fieldtype:["date","datetime"]},{title:translated_labels.label_no_last_weeks,type:"nolweeks",fieldtype:["date","datetime"]},{title:translated_labels.label_no_last_months,type:"nolmonths",fieldtype:["date","datetime"]},{title:translated_labels.label_no_last_quarters,type:"nolquarters",fieldtype:["date","datetime"]},{title:translated_labels.label_greater_than,type:"gt",fieldtype:["number","integer"]},{title:translated_labels.label_less_than,type:"lt",fieldtype:["number","integer"]},{title:translated_labels.label_eqgreater_than,type:"egt",fieldtype:["number","integer"]},{title:translated_labels.label_eqless_than,type:"elt",fieldtype:["number","integer"]},{title:translated_labels.label_checked,type:"checked",fieldtype:["checkbox"]},{title:translated_labels.label_unchecked,type:"unchecked",fieldtype:["checkbox"]},{title:translated_labels.label_currentuser,type:"assignedto",fieldtype:["user","team","teams"]},{title:translated_labels.label_role,type:"roles",fieldtype:["user"]}],data:{filterConditions:function(a){for(var b=[],c=0;c<this.conditions.length;c++)this.conditions[c].fieldtype.indexOf(a)>-1&&b.push(this.conditions[c]);return b},condition:"",fieldType:"",readOnly:!1},components:{selectBox:selectBox}}),fieldFilterValue=Ractive.extend({template:"#fieldFilterValueTemplate",oninit:function(){this.observe("fieldType",function(a,b){a!==b&&this.set("value",[])},{init:!1}),this.observe("condition",function(a,b){("ndays"==a&&"ndays"!=b||"pdays"==a&&"pdays"!=b||"gtdays"==a&&"gtdays"!=b||"ltdays"==a&&"ltdays"!=b||"ndays"!=a&&"ndays"==b||"pdays"!=a&&"pdays"==b||"gtdays"!=a&&"gtdays"==b||"ltdays"!=a&&"ltdays"==b)&&this.set("value",[])},{init:!1})},data:{fieldType:"",condition:"",value:[],timeValues:{minutes:[{name:"00"},{name:"10"},{name:"20"},{name:"30"},{name:"40"},{name:"50"}],hours:[{name:"1"},{name:"2"},{name:"3"},{name:"4"},{name:"5"},{name:"6"},{name:"7"},{name:"8"},{name:"9"},{name:"10"},{name:"11"},{name:"12"}],AmPm:[{name:"AM"},{name:"PM"}]},readOnly:!1},decorators:{datepicker:function(a){var b=this;return jQuery(a).datepicker({dateFormat:"yy-mm-dd",firstDay:1,onSelect:function(){b.set(a._ractive.binding.keypath,this.value)}}),{teardown:function(){}}}},components:{selectBox:selectBox}}),filterRule=Ractive.extend({template:"#filterRuleTemplate",onconstruct:function(a){},generateFieldsByName:reportUtils.generateFieldsByNameFromBlocks,oninit:function(){this.set("fieldsByName",this.generateFieldsByName(this.get("blocks"))),this.observe("condition fieldName",function(a){var a=this.get("fieldName"),b=this.get("fieldsByName");a&&void 0!==b[a]&&(this.set("fieldType",b[a].type),this.setAvailableValues())}),this.observe("blocks",function(){this.set("fieldsByName",this.generateFieldsByName(this.get("blocks")))}),this.observe("sequence",function(){0==this.get("sequence")&&this.set("connector","AND")}),this.on("delete",function(a,b){this.fire("deleteRule",b)});var a=this.get("readOnly"),b=this.get("selectedAccessRight");0==a&&(this.set("readOnlyPublic",!1),this.set("readOnlyPublicField",!1)),1!=a||"public"!=b&&"publicFull"!=b||this.set("readOnlyPublic",!1),1==a&&"publicFull"==b&&this.set("readOnlyPublicField",!1)},setAvailableValues:function(){var a=this.get("condition"),b=this.get("fieldName"),c=this.get("fieldsByName"),d=c[b].availableValues,e="default";a in d&&(e=a),this.set("availableValues",d[e])},data:{connector:"AND",blocks:[],fieldType:"",condition:"",fieldName:"",value:[],sequence:0,availableValues:[],commonFilter:!1,selectedAccessRight:"private",readOnlyPublic:!0,readOnlyPublicField:!0,accessRights:[{title:"Private",name:"private",description:"Filter cannot be changed, if user do not have permission to edit report"},{title:"Public limited access",name:"public",description:"Anyone can change filter attributes"},{title:"Public full access",name:"publicFull",description:"Anyone can change filter field and its attributes"}]},components:{fieldConnector:fieldConnector,fieldSelector:fieldSelector,fieldCondition:fieldCondition,fieldFilterValue:fieldFilterValue,selectBox:selectBox}}),filterRuleGroup=Ractive.extend({template:"#filterRuleGroupTemplate",oninit:function(){this.on("ruleDeleted",function(a){var b=this.get("filters");b.splice(a,1),this.set("filters",b)}),this.observe("sequence",function(){0==this.get("sequence")&&this.set("connector","AND")}),this.on("delete",function(a,b){this.fire("deleteGroup",b)})},data:{blocks:[],connector:"AND",filters:[],sequence:0,canDelete:!1,readOnly:!1},components:{filterRule:filterRule,fieldConnector:fieldConnector}}),reportFilterManager=Ractive.extend({template:"#reportFilterManagerTemplate",components:{filterRuleGroup:filterRuleGroup,reportButtons:reportButtons,reportButtonPreview:reportButtonPreview,reportBtn:reportBtn,reportBtnGC:reportBtnGC,includeDetails:includeDetails},onconstruct:function(a){var b=!0;(a.data.canEdit||a.data.canDelete)&&(b=!1),a.data.fieldHTML="";for(var c=0;c<a.data.blocks.length;c++)if(a.data.blocks[c].fields&&a.data.blocks[c].fields.length>0){a.data.fieldHTML+='<optgroup label="'+a.data.blocks[c].title+'">';for(var d=0;d<a.data.blocks[c].fields.length;d++)a.data.fieldHTML+='<option value="'+a.data.blocks[c].fields[d].name+'"> '+a.data.blocks[c].fields[d].title+"</option>";a.data.fieldHTML+="</optgroup>"}for(var c=0;c<a.data.groups.length;c++)for(var e=a.data.groups[c].filters,d=0;d<e.length;d++)a.data.groups[c].readOnly=b,a.data.groups[c].filters[d].readOnly=b,void 0===a.data.groups[c].filters[d].selectedAccessRight&&(a.data.groups[c].filters[d].selectedAccessRight="private");return a},oninit:function(){this.on("groupDeleted",function(a){var b=this.get("groups");b.splice(a,1),this.set("groups",b)}),this.on("addFilter",function(a,b){var c=this.get("groups");c[b].filters.push({selectedAccessRight:"private",connector:"AND",condition:"neq",fieldName:this.data.blocks[0].fields[0].name,value:[],commonFilter:!1}),this.set("groups",c)}),this.on("addGroup",function(){var a=this.get("groups");a.push({selectedAccessRight:"private",connector:"AND",filters:[{connector:"AND",condition:"neq",fieldName:"",value:[],commonFilter:!1}]}),this.set("groups",a)})},data:{blocks:[],groups:[],isAdmin:!1,canEdit:!1,canDelete:!1}}),reportTemplateManager=Ractive.extend({template:"#templatesManagerTemplate",oninit:function(){this.on("addReportToTemplate",function(){void 0===this.get("options.virtualReportIdsWithOptions")&&this.set("options.virtualReportIdsWithOptions",[]);var a={id:this.get("availableReports")[0].name,shiftColumns:0,shiftRows:0,sheet:1};this.get("options.virtualReportIdsWithOptions").push(a)}),this.on("removeReportFromTemplate",function(a,b){this.splice("options.virtualReportIdsWithOptions",b,1)}),this.observe("options.excelTemplateId",function(a){this.fetchAvailableWorksheets(a,this.updateAvailableWorksheets)})},fetchAvailableWorksheets:function(a,b){var c=this,d=ReportData.urlGetXLSWorksheets+a;c.set("pending",!0),c.updateAvailableWorksheets(c,[]);var e=jQuery.getJSON(d);e.success(function(a){b(c,a),c.set("pending",!1)}),e.error(function(){console.log("Available worksheet fetch failed for template id "+a),c.set("pending",!1)})},updateAvailableWorksheets:function(a,b){a.set("availableWorksheets",b)},data:{options:{},availableTemplates:[],availableReports:[],availableWorksheets:[],pending:!1,canEdit:0},components:{reportButtonPreview:reportButtonPreview,selectBox:selectBox}}),reportFieldManager=Ractive.extend({template:"#reportFieldManagerTemplate",data:{blocks:[],selectedFields:[],fieldsByName:[],filter:"",markedFields:[],markedFieldsSelected:[]},selectFields:function(a){for(var b=this.get("selectedFields"),c=0;c<a.length;c++)b.push(a[c]);var d=b.filter(function(a,b,c){return c.indexOf(a)===b});this.set({markedFields:[],selectedFields:d,markedFieldsSelected:[]})},oninit:function(){var a=this;this.on("selectField",function(b){b.original.preventDefault();for(var c=a.get("markedFields"),d=a.get("selectedFields"),e=0;e<c.length;e++)d.push(c[e]);a.set("markedFields",[]),a.set("selectedFields",d),a.set("markedFieldsSelected",c)}),this.on("removeField",function(b){b.original.preventDefault();for(var c=a.get("markedFieldsSelected"),d=a.get("selectedFields"),e=0;e<c.length;e++){var f=d.indexOf(c[e]);d.splice(f,1)}a.set("selectedFields",d)}),this.on("moveUp",function(b){b.original.preventDefault();for(var c=a.get("selectedFields"),d=a.get("markedFieldsSelected"),e=0,f=0;f<d.length;f++){var g=c.indexOf(d[f]);if(g>e){var h=c.splice(g,1);c.splice(g-1,0,h[0])}else e++}a.set("selectedFields",c)}),this.on("moveDown",function(b){b.original.preventDefault();for(var c=a.get("selectedFields"),d=a.get("markedFieldsSelected"),e=c.length-1,f=d.length-1;f>-1;f--){var g=c.indexOf(d[f]);if(g<e){var h=c.splice(g,1);c.splice(g+1,0,h[0])}else e--}a.set("selectedFields",c)}),this.on("cleanFilter",function(a){this.set("filter","")})},computed:{filteredBlocks:function(){var a=this.get("filter").toLowerCase(),b=JSON.parse(JSON.stringify(this.get("blocks"))),c=this.get("selectedFields");return b.filter(function(b){return b.fields=b.fields.filter(function(b){return(!a||b.title.toLowerCase().match(a))&&!(c.indexOf(b.name)>-1)}),!!b.fields.length})},selectableFields:function(){for(var a=this.get("fieldsByName"),b=this.get("selectedFields"),c=[],d=0;d<b.length;d++)void 0!==a[b[d]]&&c.push(a[b[d]]);return c}},modifyArrays:!1,components:{reportButtonPreview:reportButtonPreview,includeDetails:includeDetails}}),reportAggregate=Ractive.extend({template:"#reportAggregateTemplate",oninit:function(){var a=this.get("value");a.min||this.set("value.min",!1),a.max||this.set("value.max",!1),a.countDistinct||this.set("value.countDistinct",!1),this.observe("selectedField",function(a){var b=this.get("fieldsByName");if(void 0!==b[a])switch(this.set("title",b[a].title),this.set("bareTitle",b[a].bareTitle),b[a].type){case"integer":case"number":this.set("disabled",{min:!1,max:!1,sum:!1,count:!1,countDistinct:!1,avg:!1});break;case"time":case"date":case"datetime":this.set("disabled",{min:!1,max:!1,sum:!0,count:!1,countDistinct:!1,avg:!0}),this.set("value.sum",!1),this.set("value.avg",!1);break;default:this.set("disabled",{min:!0,max:!0,sum:!0,count:!1,countDistinct:!1,avg:!0}),this.set("value.min",!1),this.set("value.max",!1),this.set("value.sum",!1),this.set("value.avg",!1)}}),this.observe("fieldsByName.*.type",function(a,b,c){var d=c.split("."),e=d[0]+"."+d[1];if(this.get(e).name==this.get("selectedField"))switch(a){case"integer":case"number":this.set("disabled",aggregatesCheckBoxesNotChecked);break;case"time":case"date":case"datetime":this.set("disabled",{min:!1,max:!1,sum:!0,count:!1,countDistinct:!1,avg:!0}),this.set("value.sum",!1),this.set("value.avg",!1);break;default:this.set("disabled",{min:!0,max:!0,sum:!0,count:!1,countDistinct:!1,avg:!0}),this.set("value.min",!1),this.set("value.max",!1),this.set("value.sum",!1),this.set("value.avg",!1)}}),this.on("remove",function(a){a.original.preventDefault(),this.fire("deleteAggregate",this.get("seq"))});var b=this;jQuery("body").on("aggregateError",function(a){b.set("invalidAggregate",ReportData.errorsAgg)})},data:{availableFields:[],fieldsByName:{},selectedField:"",value:aggregatesCheckBoxesNotChecked,disabled:aggregatesCheckBoxesNotChecked,title:"",bareTitle:"",invalidAggregate:[]},components:{selectBox:selectBox},modifyArrays:!1}),reportAggregateManager=Ractive.extend({template:"#reportAggregateManagerTemplate",data:{aggregates:[],availableFields:[],fieldsByName:{}},components:{reportAggregate:reportAggregate,reportButtonPreview:reportButtonPreview,reportBtnGC:reportBtnGC,includeDetails:includeDetails},oninit:function(){this.on("addAggregate",function(a){a.original.preventDefault();var b=this.get("availableFields");this.push("aggregates",{selectedField:b?b[0].name:"",title:b?b[0].title:"",value:{min:!1,max:!1,sum:!1,count:!0,countDistinct:!1,avg:!1}})}),this.on("deleteAggregate",function(a){this.splice("aggregates",a,1)})},modifyArrays:!1}),totalTable=Ractive.extend({template:"#totalTableTemplate",oninit:function(){var a=this,b=function(){var b,c,d,e=a.get("selectedFields"),f=a.get("aggregates"),g=a.get("totalAggregates"),h=!1,i={},j=f.map(function(a){return i[a.selectedField]=a.value,a.selectedField});for(b=0;b<e.length;b++)for(e[b].showAggregates||(e[b]={}),d=Object.keys(e[b].showAggregates),c=0;c<d.length;c++)e[b].showAggregates[d[c]].constructor===Array&&(h=!0,e[b].showAggregates[d[c]]={});for(h&&a.set("selectedFields",e),d=Object.keys(g),b=0;b<d.length;b++)j.indexOf(d[b])<0&&(h=!0,delete g[d[b]]);for(d=Object.keys(g),b=0;b<j.length;b++)d.indexOf(j[b])<0&&(h=!0,g[j[b]]=aggregatesCheckBoxesNotChecked);h&&a.set("totalAggregates",g)};this.observe("aggregates",b,{init:!1}),this.observe("selectedFields",b,{init:!1}),this.observe("grandTotalBoth",function(a){ReportData.options.grandTotalBoth=a}),this.observe("grandTotalBothShow",function(a){a||this.set("grandTotalBoth",!1)}),b(),jQuery("body").on("totalTableError",function(b){a.set("errorAggregates",ReportData.errors)})},computed:{grandTotalBothShow:{get:function(){var a=this.get("aggregates");if(this.get("isCrosstab")&&a.length<=1){checked=0;for(name in a[0].value)if(a[0].value[name]&&checked++,checked>1)return!1;return!0}return!1},set:function(){}}},data:{selectedFields:[],fieldsByName:{},totalAggregates:{},aggregates:[],addonTitle:function(a,b,c){var d="";return c.dateGrouping&&(d=" ("+capitalize(c.dateGrouping)+")"),d},errorAggregates:null,grandTotalBoth:!1},decorators:{multiSelect:multiSelectDecorator},modifyArrays:!1}),arithmeticGroup=Ractive.extend({template:"#arithmeticGroupTemplate",isolated:!1,onconstruct:function(a){Array.isArray(a.data.value)||(a.data.value=[{type:"constant",connector:"none",value:"0"}])},oninit:function(){var a=this;this.on("add",function(b,c){a.push("value",{type:"constant",connector:"add",value:"0"})}),this.on("remove",function(a,b){var c=this.get("value");c.splice(b,1),this.set("value",c)})},oncomplete:function(){this.update()},data:{value:[{type:"constant",connector:"none",value:"0"}],connector:""}}),logicGroup=Ractive.extend({template:"#logicGroupTemplate",isolated:!1,onconstruct:function(a){"object"==typeof a.data.value&&void 0!==a.data.value.ifLogic||(a.data.value={ifLogic:{operand1:{type:"constant",connector:"none",value:"0"},operand2:{type:"constant",connector:"none",value:"0"},operator:"equals",result:{type:"constant",connector:"none",value:"0"}},elseLogic:{result:{type:"constant",connector:"none",value:"0"}},elseIfLogic:[]})},oninit:function(){var a=this;this.on("addElseIf",function(b,c){a.push("value.elseIfLogic",{operand1:{type:"constant",connector:"none",value:"0"},operand2:{type:"constant",connector:"none",value:"0"},operator:"notEquals",result:{type:"constant",connector:"none",value:"0"}})}),this.on("removeElseIf",function(b,c){var d=this.get("value.elseIfLogic");d.splice(c,1),a.set("value.elseIfLogic",d)})},oncomplete:function(){this.update()},data:{value:[{type:"constant",connector:"none",value:"0"}],connector:"",availableLogicActions:ReportData.calculatedColumns.types.logicOperands}}),constant=Ractive.extend({template:"#constantTemplate",isolated:!1,onconstruct:function(a){"string"!=typeof a.data.value&&(a.data.value="0")},oninit:function(){},oncomplete:function(){this.update()},data:{value:"",connector:"",type:""}}),columnField=Ractive.extend({template:"#columnFieldTemplate",isolated:!1,onconstruct:function(a){"string"!=typeof a.data.value&&(a.data.value="")},onrender:function(){var a=this,b=this.get("availableValues");if(b.length>0){var c=this.get("value");0==jQuery.grep(b,function(a){return a.id===c}).length&&(c=b[0].id,a.set("value",c))}},data:{value:"",connector:"",type:""},computed:{availableValues:function(){if("aggregate"===this.get("level")){var a=this.get("aggregates"),b=[];return jQuery.each(a,function(a,c){jQuery.each(c.value,function(a,d){!0===d&&b.push({id:c.selectedField+aggregatesDefinitions[a].namePostfix,name:c.title+" "+translated_labels[aggregatesDefinitions[a].label]})})}),b}}}}),calcColumns=Ractive.extend({template:"#calculatedColumnsTemplate",oninit:function(){this.observe(this.observers,{init:!1})},onconstruct:function(){var a=this;this.on("addCalculation",function(b,c){a.push("calculations",{name:"Calculation name",level:!1,calculation:{}})}),this.on("addFormula",function(a,b){var c=this.get("calculations");c[b].level="aggregate",c[b].calculation={type:"arithmeticGroup",connector:"none",value:[{type:"constant",connector:"none",value:"0"}]},this.set("calculations",c),this.fire("openFormulaEditor",b)}),this.on("editFormula",function(a,b){this.fire("openFormulaEditor",b)}),this.on("deleteFormula",function(a,b){var c=this.get("calculations");c[b].level=!1,this.set("calculations",c)}),this.on("deleteCalculation",function(a,b){var c=this.get("calculations");c.splice(b,1),this.set("calculations",c)}),this.on("openFormulaEditor",function(b){var c=this,d=a.get("calculations");new(Ractive.extend({el:jQuery("#modalWindow"),append:!1,template:"#calcColumnsModalTemplate",isolated:!1,data:{dialogOptions:{modal:!0,draggable:!0,resizable:!1,width:755,title:translated_labels.label_mass_schedule_title},formula:d[b],availableConnectors:ReportData.calculatedColumns.types.arithmeticOperations,nodeTypes:ReportData.calculatedColumns.types.nodes,aggregates:c.get("aggregates"),level:d[b].level},components:{selectBox:selectBox},oninit:function(){var c=this;this.observe("formula",function(a,b){c.update()}),this.observe("formula.name",function(c,d){a.set("calculations."+b+".name",c)}),c.on("cancel",function(){jQuery("#modalWindow").dialog("close")}),jQuery(this.el).dialog(this.data.dialogOptions)},onteardown:function(){this.dialog&&this.dialog.dialog("destroy")}}))})},observers:{},data:{calculations:[]},components:{}});Ractive.components.arithmeticGroup=arithmeticGroup,Ractive.components.logicGroup=logicGroup,Ractive.components.constant=constant,Ractive.components.columnField=columnField;var sortingByField=Ractive.extend({template:"#sortingByFieldTemplate",oninit:function(){var a=this;this.on("delete",function(b,c){a.fire("deleted",c)}),this.on("addRange",function(){var b=a.get("ranges");b.push({start:0,end:0,name:""}),a.set("ranges",b)}),this.on("removeRange",function(b,c){var d=a.get("ranges");d.splice(c,1),console.log(c),a.set("ranges",d)}),jQuery("body").on("includedDetails",function(){a.set("canSort",ReportData.options.includeDetails)}),this.observe("isCrosstab",function(b){a.set("canSort",ReportData.options.includeDetails)})},oncomplete:function(){var a=this;this.observe("isDate",function(b){b||a.set("dateGrouping","")}),this.observe("canSort",function(b,c,d){a.set("sortOptions",[{name:"sort",title:translated_labels.label_sort},{name:"group",title:translated_labels.label_group},{name:"groupsort",title:translated_labels.label_group_sort}])}),this.observe("canSortParam",function(b,c,d){a.set("sortOptions",[{name:"sort",title:translated_labels.label_sort},{name:"group",title:translated_labels.label_group},{name:"groupsort",title:translated_labels.label_group_sort}])}),this.observe("name",function(b,c,d){var e=a.get("fieldsByName"),f=b,g=e[f].type;void 0!==a.get("allowedShowAllTypes")[g]?a.set("allowedShowAll",!0):(a.set("allowedShowAll",!1),a.set("allowedShowAll",!1))})},data:{sortOptions:[{name:"sort",title:translated_labels.label_sort},{name:"group",title:translated_labels.label_group},{name:"groupsort",title:translated_labels.label_group_sort}],sortDirections:[{name:"ASC",title:translated_labels.label_ascending},{name:"DESC",title:translated_labels.label_descending}],isCombined:ReportData.options.isCombined,fieldsByName:{},dateOptions:[{name:"day",title:translated_labels.label_day},{name:"week",title:translated_labels.label_week},{name:"weekAndYear",title:translated_labels.label_week_and_year},{name:"month",title:translated_labels.label_month},{name:"monthAndYear",title:translated_labels.label_month_and_year},{name:"quarter",title:translated_labels.label_quarter},{name:"quarterAndYear",title:translated_labels.label_quarter_and_year},{name:"year",title:translated_labels.label_year},{name:"default",title:translated_labels.originalValue}],positions:[{name:"row",title:translated_labels.label_row},{name:"column",title:translated_labels.label_column}],canSort:ReportData.options.includeDetails,canOnlySort:!1,position:null,transform:!0,showAggregates:{},showTop:"",allowedShowAll:!1,allowedShowAllTypes:{user:!0,select:!0},ranges:[],groupByRange:!1,groupByAggregate:"originalValue",groupByAggregateType:[{name:"originalValue",title:"Original Value"},{name:"min",title:"Min"},{name:"max",title:"Max"},{name:"sum",title:"Sum"},{name:"avg",title:"Average"},{name:"count",title:"Count"}]},computed:{hasAggregates:function(){for(var a=this.get("showAggregates"),b=Object.keys(a),c=!1,d=0;d<b.length;d++){var e;for(e in aggregatesDefinitions)if(a[b[d]][e]){c=!0;break}if(1==c)break}return c},getAggregates:function(){var a=this.get("showAggregates"),b=this.get("fieldsByName"),c=this.get("name"),d=this.get("isCombined"),e=Object.keys(a),f="";b[c]&&(f=b[c].bareTitle);var g=[{name:c,title:f}];if(!d)for(var h=0;h<e.length;h++)if(b[e[h]]){var i;for(i in aggregatesDefinitions)a[e[h]][i]&&g.push({name:e[h]+"_"+i,title:translated_labels[aggregatesDefinitions[i].label]+"("+b[e[h]].bareTitle+")"})}return g},isDate:function(){var a=!1,b=this.get("fieldsByName"),c=b[this.get("name")];return!c||"date"!=c.type&&"datetime"!=c.type||(a=!0),a},isMultiSelect:function(){var a=!1,b=this.get("fieldsByName"),c=b[this.get("name")];return c&&33==c.uitype&&(a=!0),a},isNumeric:function(){var a=!1,b=this.get("fieldsByName"),c=b[this.get("name")];return void 0!==c&&(!c||"currency"!=c.uitype&&"int"!=c.uitype&&"number"!=c.type||(a=!0),a||this.set("groupByRange",!1),a)}},components:{selectBox:selectBox},modifyArrays:!1}),sortingByCombinedField=Ractive.extend({template:"#sortingByCombinedFieldTemplate",oninit:function(){var a=this;this.observe("selectedValue",function(b){var c=a.get("seq");ReportData.combinedSelectedFields.fields[c]=b})},data:{sortDirections:[{name:"ASC",title:translated_labels.label_ascending},{name:"DESC",title:translated_labels.label_descending}],dateOptions:[{name:"day",title:translated_labels.label_day},{name:"week",title:translated_labels.label_week},{name:"weekAndYear",title:translated_labels.label_week_and_year},{name:"month",title:translated_labels.label_month},{name:"monthAndYear",title:translated_labels.label_month_and_year},{name:"quarter",title:translated_labels.label_quarter},{name:"quarterAndYear",title:translated_labels.label_quarter_and_year},{name:"year",title:translated_labels.label_year},{name:"default",title:translated_labels.originalValue}],positions:[{name:"row",title:translated_labels.label_row},{name:"column",title:translated_labels.label_column}],position:null,fields:[],selectedValue:""},components:{selectBox:selectBox},modifyArrays:!1}),sortingBy=Ractive.extend({template:"#sortingByTemplate",onrender:function(){this.generateFields(),this.observe("blocks",this.generateFields),this.observe("availableFields",this.generateFields)},oninit:function(){this.set("selectedFields",this.transformFields(this.get("selectedFields"))),this.on("updateField",function(a){for(var b=this.get("fields"),c=0;c<b.length;c++)if(b[c].name==a.field){this.set("selectedFields."+a.seq+".title",b[c].title);break}}),this.on("deleteSort",function(a){var b=this.get("selectedFields");b.splice(a,1),this.set("selectedFields",b)})},transformFields:function(a){for(var b=0;b<a.length;b++)void 0===a[b].transform&&(a[b].transform=null);return a},generateFields:function(){var a=this.get("availableFields");this.set("fields",a)},data:{blocks:[],sortOptions:[{name:"sort",title:translated_labels.label_sort},{name:"group",title:translated_labels.label_group},{name:"groupsort",title:translated_labels.label_group_sort}],fields:[],availableFields:[],aggregates:[],selectedFields:[],canSort:ReportData.options.includeDetails,isCrosstab:ReportData.options.isCrosstab,isCombined:ReportData.options.isCombined,excluded:[]},components:{sortingByField:sortingByField},modifyArrays:!1}),sortingByCombined=Ractive.extend({template:"#sortingByCombinedTemplate",onrender:function(){var a=this;this.set("combinedModulesCount",ReportData.combinedModules.length);var b=function(){for(var b={},c=a.get("availableFields"),d=!0,e=0;e<c.length;e++){var f=c[e];("datetime"==f.type||"date"==f.type)&&ReportData.combinedModules.indexOf(parseInt(f.moduleId))>-1&&(void 0===b[f.moduleId]&&(b[f.moduleId]=[]),d&&(b[f.moduleId].isFirst=!0),b[f.moduleId].push(f),d=!1)}a.set("combinedFields",b)};b(),this.observe("combinedSelectedFields.sortDirection",function(a){this._parent.set("combinedSelectedFields.sortDirection",a)}),this.observe("availableFields",b,{init:!1}),this.observe("combinedSelectedFields.sortAction",function(a){this.set("combinedSelectedFields.sortAction",a),this._parent.set("combinedSelectedFields.sortAction",a)}),this.observe("combinedSelectedFields",function(a){ReportData.combinedSelectedFields=a})},data:{isCombined:ReportData.options.isCombined,combinedModules:ReportData.combinedModules,combinedFields:[],availableFields:[],combinedSelectedFields:ReportData.combinedSelectedFields,sortOptions:[{name:"groupsort",title:translated_labels.label_group_sort},{name:"group",title:translated_labels.label_group},{name:"nogroup",title:translated_labels.label_dont_group}],sortDirections:[{name:"ASC",title:translated_labels.label_ascending},{name:"DESC",title:translated_labels.label_descending}],dateOptions:ReportData.options.isCombined?[{name:"day",title:translated_labels.label_day},{name:"weekAndYear",title:translated_labels.label_week_and_year},{name:"monthAndYear",title:translated_labels.label_month_and_year},{name:"quarterAndYear",title:translated_labels.label_quarter_and_year},{name:"year",title:translated_labels.label_year}]:[{name:"day",title:translated_labels.label_day},{name:"week",title:translated_labels.label_week},{name:"weekAndYear",title:translated_labels.label_week_and_year},{name:"month",title:translated_labels.label_month},{name:"monthAndYear",title:translated_labels.label_month_and_year},{name:"quarter",title:translated_labels.label_quarter},{name:"quarterAndYear",title:translated_labels.label_quarter_and_year},{name:"year",title:translated_labels.label_year}],positions:[{name:"row",title:translated_labels.label_row},{name:"column",title:translated_labels.label_column}],position:null},components:{sortingByCombinedField:sortingByCombinedField,selectBox:selectBox},modifyArrays:!1}),reportGroupingManager=Ractive.extend({template:"#reportGroupingManagerTemplate",oninit:function(){var a=this;jQuery("body").on("includedDetails",function(){a.set("includeDetails",ReportData.options.includeDetails)}),this.get("isCombined")&&(this.set("availableFieldsPossible",this.get("availableFields")),this.observe("availableFields",function(b){for(var c=[],d=0;d<b.length;d++)ReportData.commonModules.indexOf(b[d].moduleId)>-1&&c.push(b[d]);a.set("availableFieldsPossible",c)},{init:!1})),this.observe("aggregatesAsColumn",function(b,c){if(b&&void 0!==c){for(var d=this.get("aggregates"),e=this.get("totalAggregates"),f=0;f<d.length;f++){void 0===e[d[f].selectedField]&&(e[d[f].selectedField]=aggregatesCheckBoxesNotChecked);var g;for(g in aggregatesDefinitions)d[f].value[g]&&(e[d[f].selectedField][g]=!0)}a.set("totalAggregates",e)}}),this.get("isCombined")&&this.observe("availableFieldsPossible",function(a){for(var b=[],c=this.get("combinedModules"),d=0;d<a.length;d++)-1==c.indexOf(parseInt(a[d].moduleId))&&b.push(a[d]);b.length<a.length&&this.set("availableFieldsPossible",b)}),this.on("addItem",function(){for(var a=this.get(),b={name:a.availableFields[0].name,showAggregates:{},sortAction:"groupsort",sortDirection:"ASC",aggregate:"",position:"",ranges:[],groupByRange:!1,groupByAggregate:"originalValue"},c=this.get("aggregates"),d=c.length,e=0;e<d;e++)b.showAggregates[c[e].selectedField]=c[e].value;a.selectedFields.length>0&&"sort"==a.selectedFields[a.selectedFields.length-1].sortAction&&(b.sortOptions=[{name:"sort",title:translated_labels.label_sort}]),this.get("isCrosstab")&&(b.position="row"),this.push("selectedFields",b)})},data:{blocks:[],selectedFields:[],aggregates:[],totalAggregates:{},combinedSelectedFields:[],combinedModules:[],isCombined:!1,includeDetails:!1,canSort:!1,showAllValues:!1,aggregatesAsColumn:!1,options:{},calculatedColumns:ReportData.calculatedColumns.value},components:{sortingByCombined:sortingByCombined,totalTable:totalTable,calcColumns:calcColumns,sortingBy:sortingBy,reportButtons:reportButtons,reportButtonPreview:reportButtonPreview,reportBtn:reportBtn,reportBtnGC:reportBtnGC,includeDetails:includeDetails,isCrosstab:isCrosstab},modifyArrays:!1}),reportAccessRights=Ractive.extend({template:'<selectBox selected="{{level}}" options="{{rights}}" titleName="title" valueName="name" />',data:{rights:[{name:"VIEW",title:translated_labels.label_can_view},{name:"EDIT",title:translated_labels.label_can_edit},{name:"DELETE",title:translated_labels.label_can_delete}],level:"VIEW"},components:{selectBox:selectBox}}),reportAccessManager=Ractive.extend({template:"#reportAccessTemplate",onconstruct:function(a){for(var b={},c=[],d=0;d<a.data.users.length;d++)b[a.data.users[d].id]=a.data.users[d],void 0!==a.data.accessRights[a.data.users[d].id]?(b[a.data.users[d].id].accessRights=a.data.accessRights[a.data.users[d].id],b[a.data.users[d].id].selected=!0,c.push(a.data.users[d].id)):b[a.data.users[d].id].accessRights="VIEW";a.data.selectedUsers=c,a.data.usersById=b},oninit:function(){var a=this;this.on("selectUsers",function(b,c){for(var d=a.get("selectedUsers"),e=0;e<c.length;e++)d.push(c[e]),a.set("usersById."+c[e]+".selected",!0);a.set("selectedUsers",d),a.set("updatePermissions",!0)}),this.on("removeUser",function(b,c){var d=a.get("selectedUsers"),e=d.indexOf(c);d.splice(e,1),a.set("usersById."+c+".selected",!1),a.set("selectedUsers",d)}),this.on("cleanFilter",function(a){a.original.preventDefault(),this.set("filter","")}),this.observe("globalSharing",function(b){if("PUB"===b){for(var c=a.get("selectedUsers"),d=0;d<c.length;d++)a.set("usersById."+c[d]+".selected",!1);a.set("selectedUsers",c)}},{init:!1}),this.observe("allowDrilldownReadOnly",function(a){ReportData.options.allowDrilldownReadOnly=a}),this.observe("allowExportReadOnly",function(a){ReportData.options.allowExportReadOnly=a})},data:{users:[],selectedUsers:[],usersById:{},filter:"",accessRights:{},globalSharing:"PRIV",availableOwners:[],updatePermissions:!1,owner:0,canEdit:!1,canDelete:!1,allowDrilldownReadOnly:!0,allowExportReadOnly:!0},getSelectedAccess:function(){for(var a=this.get("selectedUsers"),b=this.get("usersById"),c={},d=0;d<a.length;d++)void 0!==typeof b[a[d]].selected&&b[a[d]].selected&&(c[a[d]]=b[a[d]].accessRights);return c},computed:{filteredUsers:function(){var a=this.get("filter").toLowerCase(),b=this.get("usersById"),c={};for(key in b)b.hasOwnProperty(key)&&b[key].name.toLowerCase().match(a)&&(c[key]=b[key]);return c}},components:{reportAccessRights:reportAccessRights,reportButtons:reportButtons,reportButtonPreview:reportButtonPreview,selectBox:selectBox}}),reportScheduleManager=Ractive.extend({template:"#reportSchedulingTemplate",onconstruct:function(a){for(var b={},c=0;c<a.data.users.length;c++)b[a.data.users[c].id]=a.data.users[c],a.data.selectedUsers.indexOf(a.data.users[c].id)>-1?(b[a.data.users[c].id].selected=!0,"e"==a.data.users[c].id.charAt(0)&&(this.data.emails[a.data.users[c].id]=a.data.users[c].name.replace(translated_labels.label_email+"::",""))):b[a.data.users[c].id].selected=!1;a.data.usersById=b},oninit:function(){var a=this;this.on("selectUsers",function(b,c){b.original.preventDefault();for(var d=a.get("selectedUsers"),e=0;e<c.length;e++)d.push(c[e]),a.set("usersById."+c[e]+".selected",!0);a.set("selectedUsers",d),a.set("isScheduled",!0)}),this.on("addCustomEmail",function(b,c){if(b.original.preventDefault(),/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(c)){for(var d=a.get("selectedUsers"),e=a.get("usersById");"e_"+this.data.emailcounter in this.data.emails;)this.data.emailcounter++;var f={id:"e_"+this.data.emailcounter++,name:"Email::"+c,selected:!0};this.data.emails[f.id]=c,e[f.id]=f,d.push(f.id),a.set("usersById",e),a.set("selectedUsers",d),a.set("isScheduled",!0)}else alert(translated_labels.label_invalid_email)}),this.on("removeUser",function(b,c){b.original.preventDefault();var d=a.get("selectedUsers"),e=d.indexOf(c);if(d.splice(e,1),"e"==c.charAt(0)){var f=a.get("usersById");delete f[c],a.set("usersById",f),delete a.data.emails[c]}else a.set("usersById."+c+".selected",!1);a.set("selectedUsers",d)}),this.on("cleanFilter",function(a){a.original.preventDefault(),this.set("filter","")});var b=function(b){var c=a.get("interval"),d=["02","04","06","09","11"];4==c&&(d.indexOf(b)>-1?"02"==b?a.set("days",[{val:"01",title:"1"},{val:"02",title:"2"},{val:"03",title:"3"},{val:"04",title:"4"},{val:"05",title:"5"},{val:"06",title:"6"},{val:"07",title:"7"},{val:"08",title:"8"},{val:"09",title:"9"},{val:"10",title:"10"},{val:"11",title:"11"},{val:"12",title:"12"},{val:"13",title:"13"},{val:"14",title:"14"},{val:"15",title:"15"},{val:"16",title:"16"},{val:"17",title:"17"},{val:"18",title:"18"},{val:"19",title:"19"},{val:"20",title:"20"},{val:"21",title:"21"},{val:"22",title:"22"},{val:"23",title:"23"},{val:"24",title:"24"},{val:"25",title:"25"},{val:"26",title:"26"},{val:"27",title:"27"},{val:"28",title:"28"}]):a.set("days",[{val:"01",title:"1"},{val:"02",title:"2"},{val:"03",title:"3"},{val:"04",title:"4"},{val:"05",title:"5"},{val:"06",title:"6"},{val:"07",title:"7"},{val:"08",title:"8"},{val:"09",title:"9"},{val:"10",title:"10"},{val:"11",title:"11"},{val:"12",title:"12"},{val:"13",title:"13"},{val:"14",title:"14"},{val:"15",title:"15"},{val:"16",title:"16"},{val:"17",title:"17"},{val:"18",title:"18"},{val:"19",title:"19"},{val:"20",title:"20"},{val:"21",title:"21"},{val:"22",title:"22"},{val:"23",title:"23"},{val:"24",title:"24"},{val:"25",title:"25"},{val:"26",title:"26"},{val:"27",title:"27"},{val:"28",title:"28"},{val:"29",title:"29"},{val:"30",title:"30"}]):a.set("days",[{val:"01",title:"1"},{val:"02",title:"2"},{val:"03",title:"3"},{val:"04",title:"4"},{val:"05",title:"5"},{val:"06",title:"6"},{val:"07",title:"7"},{val:"08",title:"8"},{val:"09",title:"9"},{val:"10",title:"10"},{val:"11",title:"11"},{val:"12",title:"12"},{val:"13",title:"13"},{val:"14",title:"14"},{val:"15",title:"15"},{val:"16",title:"16"},{val:"17",title:"17"},{val:"18",title:"18"},{val:"19",title:"19"},{val:"20",title:"20"},{val:"21",title:"21"},{val:"22",title:"22"},{val:"23",title:"23"},{val:"24",title:"24"},{val:"25",title:"25"},{val:"26",title:"26"},{val:"27",title:"27"},{val:"28",title:"28"},{val:"29",title:"29"},{val:"30",title:"30"},{val:"31",title:"31"}]))};this.observe("intervalOptions.0",b),this.observe("interval",function(a){4==a?b(this.get("intervalOptions.0")):3==a&&b("01")})},getSelectedRecipients:function(){for(var a=this.get("selectedUsers"),b=this.get("usersById"),c=[],d=0;d<a.length;d++)b[a[d]]&&void 0!==typeof b[a[d]].selected&&b[a[d]].selected&&c.push(a[d]);return c.push(this.data.emails),c},computed:{filteredUsers:function(){var a=this.get("filter").toLowerCase(),b=this.get("usersById"),c={};for(key in b)b.hasOwnProperty(key)&&b[key].name.toLowerCase().match(a)&&(c[key]=b[key]);return c}},data:{users:[],selectedUsers:[],usersById:{},filter:"",emails:{},emailcounter:0,emailpermission:"undefined"!=typeof current_user&&(1==current_user.is_admin||ReportData.owner==current_user.id),isScheduled:!1,interval:0,intervalOptions:[],timeM:"00",timeH:"00",minutes:[{m:"00"},{m:"05"},{m:"10"},{m:"15"},{m:"20"},{m:"25"},{m:"30"},{m:"35"},{m:"40"},{m:"45"},{m:"50"},{m:"55"}],hours:[{h:"00"},{h:"01"},{h:"02"},{h:"03"},{h:"04"},{h:"05"},{h:"06"},{h:"07"},{h:"08"},{h:"09"},{h:"10"},{h:"11"},{h:"12"},{h:"13"},{h:"14"},{h:"15"},{h:"16"},{h:"17"},{h:"18"},{h:"19"},{h:"20"},{h:"21"},{h:"22"},{h:"23"}],weekdays:[{val:"0",title:translated_labels.label_monday},{val:"1",title:translated_labels.label_tuesday},{val:"2",title:translated_labels.label_wednesday},{val:"3",title:translated_labels.label_thursday},{val:"4",title:translated_labels.label_friday},{val:"5",title:translated_labels.label_saturday},{val:"6",title:translated_labels.label_sunday}],monthweeks:[{val:0,title:translated_labels.label_week_first_third},{val:1,title:translated_labels.label_week_second_fourth}],months:[{val:"01",title:"1"},{val:"02",title:"2"},{val:"03",title:"3"},{val:"04",title:"4"},{val:"05",title:"5"},{val:"06",title:"6"},{val:"07",title:"7"},{val:"08",title:"8"},{val:"09",title:"9"},{val:"10",title:"10"},{val:"11",title:"11"},{val:"12",title:"12"}],days:[{val:"01",title:"1"},{val:"02",title:"2"},{val:"03",title:"3"},{val:"04",title:"4"},{val:"05",title:"5"},{val:"06",title:"6"},{val:"07",title:"7"},{val:"08",title:"8"},{val:"09",title:"9"},{val:"10",title:"10"},{val:"11",title:"11"},{val:"12",title:"12"},{val:"13",title:"13"},{val:"14",title:"14"},{val:"15",title:"15"},{val:"16",title:"16"},{val:"17",title:"17"},{val:"18",title:"18"},{val:"19",title:"19"},{val:"20",title:"20"},{val:"21",title:"21"},{val:"22",title:"22"},{val:"23",title:"23"},{val:"24",title:"24"},{val:"25",title:"25"},{val:"26",title:"26"},{val:"27",title:"27"},{val:"28",title:"28"},{val:"29",title:"29"},{val:"30",title:"30"},{val:"31",title:"31"}],intervalAvailableValues:[{value:0,title:translated_labels.label_daily},{value:1,title:translated_labels.label_weekly},{value:2,title:translated_labels.label_biweekly},{value:3,title:translated_labels.label_monthly},{value:4,title:translated_labels.label_yearly}],scheduledFormats:{xlsx:!1,pdf:!1,url:!1}},components:{selectBox:selectBox}}),calcFieldDefaults={op:"sum",cond:"nempt",fieldtype:"txt",fullOP:{op:"sum",valType:["c"],val:["0.01"]},selectedFn:function(){return{name:"sum",title:translated_labels.label_fn_sum,valCount:1,argTitles:[""],acceptedFields:["number"]}},selectedCond:function(){return{name:"nempt",title:"Isn`t empty",acceptedFields:["txt","select","number","date","datetime","time"]}},selectedFieldType:function(){return{name:"txt",title:"Text"}},valType:"c",val:"0.01",fullField:function(a){return{val:{op:this.op,cond:this.cond,fieldtype:this.fieldtype,valType:[this.valType],val:[this.val]},name:"X_Calculated_calField"+a,availableValues:[],title:"Untitled field "+a,bareTitle:"Calculated field "+a,column:"calcField_"+a,type:"number",table:"__virtual__",uitype:"71"}},findSelectedFn:function(a,b){for(var c=calcFieldDefaults.selectedFn(),d=0;d<a.length;d++)if(a[d].name==b){c=a[d];break}return c||b==calcFieldDefaults.op||(c=this.findSelectdFn(a,calcFieldDefaults.op)),c},findSelectedCond:function(a,b){if(void 0!==a){for(var c=calcFieldDefaults.selectedCond(),d=0;d<a.length;d++)if(a[d].name==b){c=a[d];break}return c||b==calcFieldDefaults.cond||(c=this.findSelectedCond(a,calcFieldDefaults.cond)),c}return!1},findSelectedFieldType:function(a,b){if(void 0!==a){for(var c=calcFieldDefaults.selectedFieldType(),d=0;d<a.length;d++)if(a[d].name==b){c=a[d];break}return c||b==calcFieldDefaults.fieldtype||(c=this.findSelectedFieldType(a,calcFieldDefaults.fieldtype)),c}return!1},filterFieldsByType:function(a,b){if(void 0!==b){for(var c=[],d=0;d<a.length;d++)"__virtual__"!=a[d].table&&b.indexOf(a[d].type)>-1&&c.push(a[d]);return c}return!1}},calcField=Ractive.extend({template:"#reportCalcFieldTemplate",onconstruct:function(a){a.data.val=a.data.val||calcFieldDefaults.fullOP,a.data.val.op=a.data.val.op||calcFieldDefaults.op,a.data.val.cond=a.data.val.cond||calcFieldDefaults.cond,a.data.val.fieldtype=a.data.val.fieldtype||calcFieldDefaults.fieldtype,a.data.selectedFn=calcFieldDefaults.findSelectedFn(a.data.fns,a.data.val.op),a.data.selectedCond=calcFieldDefaults.findSelectedCond(this.data.condTypes,a.data.val.cond),a.data.selectedFieldType=calcFieldDefaults.findSelectedFieldType(a.data.fieldTypes,a.data.val.fieldtype),a.data.availableFieldsFiltered=calcFieldDefaults.filterFieldsByType(a.data.availableFields,a.data.selectedFn.acceptedFields);try{a.data.selectedCond.acceptedFields=["txt","select","number","date","datetime","time"]}catch(a){console.log(a)}return a.data.availableFieldsFilteredIF=calcFieldDefaults.filterFieldsByType(a.data.availableFields,a.data.selectedCond.acceptedFields),a},oninit:function(){if(this.observe(this.observers,{init:!1}),"if"==this.get("val.op")){var a=this.get("val.valType");if(void 0!==a[0]&&"f"==a[0]&&void 0!==a[1]&&"c"==a[1]&&this.data.availableFieldValues(this.get("val.val[0]"),this.get("availableFields")).length>0){var b=this.get("val.val[1]");"string"==typeof b&&(b=[b],this.set("val.val[1]",b))}}},observers:{"selectedFn.valCount":function(a,b){var c=a-b;if(c>0)for(var d=0;d<c;d++)this.push("val.val",calcFieldDefaults.val),this.push("val.valType",calcFieldDefaults.valType);else if(c<0)for(var d=0;d<-c;d++){var e=this.get("val.valType");void 0!==e&&this.pop("val.valType");var f=this.get("val.val");void 0!==f&&this.pop("val.val")}},"val.op":function(a){a||(a="plus"),this.set("selectedFn",calcFieldDefaults.findSelectedFn(this.get("fns"),a)),this.set("availableFieldsFiltered",calcFieldDefaults.filterFieldsByType(this.data.availableFields,this.data.selectedFn.acceptedFields)),"addDate"==a?(this.set("val.fieldtype","datetime"),void 0!==this.get("type")&&this.set("type","datetime")):"subtractDate"==a&&"c"==this.data.val.valType[1]?(this.set("val.fieldtype","datetime"),void 0!==this.get("type")&&this.set("type","datetime")):(this.set("val.fieldtype","number"),void 0!==this.get("type")&&this.set("type","number"))},"val.valType.*":function(a,b,c,d){var e=c.split(".")[2];"op"==a?this.set("val.val."+e,{op:"sum",valType:["c"],val:["0.01"]}):this.set("val.val."+e,""),1==d&&"subtractDate"==this.data.selectedFn.name&&("c"==a?(this.set("val.fieldtype","datetime"),void 0!==this.get("type")&&this.set("type","datetime")):(this.set("val.fieldtype","number"),void 0!==this.get("type")&&this.set("type","number")))},availableFields:function(a){var b=calcFieldDefaults.filterFieldsByType(a,this.get("selectedFn.acceptedFields"));this.set("availableFieldsFiltered",b);var c=calcFieldDefaults.filterFieldsByType(a,this.get("selectedCond.acceptedFields"));this.set("availableFieldsFilteredIF",c)},"val.fieldtype":function(a,b,c){void 0!==this.get("type")&&this.set("type",a)},"val.val.*":function(a,b,c,d){if("if"==this.get("val.op")){var e=this.get("val.valType");if(void 0!==e[0]&&"f"==e[0]&&void 0!==e[1]&&"c"==e[1]&&a.length>0){var f=this.data.availableFieldValues(a,this.get("availableFields"));f.length>0&&this.set("val.val[1]",f[0].val)}}}},data:{fns:[],val:{op:"",cond:"",fieldtype:"",valType:["c"],val:["0.01"]},opTypes:[{name:"c",title:translated_labels.label_op_const},{name:"f",title:translated_labels.label_op_field},{name:"op",title:translated_labels.label_op_sub_op}],opTypesCAndFAndToday:[{name:"c",title:translated_labels.label_op_const},{name:"f",title:translated_labels.label_op_field},{name:"today",title:translated_labels.label_today}],opTypesFAndToday:[{name:"f",title:translated_labels.label_op_field},{name:"today",title:translated_labels.label_today}],opTypesC:[{name:"c",title:translated_labels.label_op_const}],dateTimeTypes:[{name:"year",title:translated_labels.label_year},{name:"month",title:translated_labels.label_month},{name:"week",title:translated_labels.label_week},{name:"day",title:translated_labels.label_day},{name:"hour",title:translated_labels.label_hour},{name:"minute",title:translated_labels.label_minute}],condTypes:[{name:"empt",title:translated_labels.label_fn_empty},{name:"nempt",title:translated_labels.label_fn_nempty},{name:"equal",title:translated_labels.label_fn_equal},{name:"nequal",title:translated_labels.label_fn_nequal}],fieldTypes:[{name:"txt",title:translated_labels.label_fn_text},{name:"date",title:translated_labels.label_fn_date},{name:"datetime",title:translated_labels.label_fn_datetime},{name:"number",title:translated_labels.label_fn_number}],conditionLabel:translated_labels.label_fn_cond,thenLabel:translated_labels.label_fn_then,otherLabel:translated_labels.label_fn_else,lessOpTypes:[{name:"c",title:translated_labels.label_op_const},{name:"f",title:translated_labels.label_op_field}],selectedFn:calcFieldDefaults.selectedFn(),selectedCond:calcFieldDefaults.selectedCond(),selectedFieldType:calcFieldDefaults.selectedFieldType(),availableFields:[],availableFieldsFiltered:[],availableFieldsFilteredIF:[],fieldsByName:{},level:0,enableCustomSQL:!0,availableFieldValues:function(a,b){for(var c=0,d=b.length;c<d;c++)if(b[c].name==a)return"checkbox"==b[c].type?[{title:translated_labels.label_checked,val:1},{title:translated_labels.label_unchecked,val:0}]:void 0!==b[c].availableValues.default&&b[c].availableValues.default.length>0?b[c].availableValues.default:[];return[]}},components:{calcField:calcField,selectBox:selectBox},decorators:{}});calcField.components.calcField=calcField;var calcFieldDisplay=Ractive.extend({template:"#reportCalcFieldDisplayTemplate",oninit:function(){this.observe("val.op",function(a){var b=calcFieldDefaults.findSelectedFn(this.get("fns"),a);this.set("fnName",b.title),this.set("fnArgs",b.argTitles)}),this.observe("val.cond",function(a){var b=calcFieldDefaults.findSelectedCond(this.get("condTypes"),a);this.set("condName",b.title)}),this.observe("val.fieldtype",function(a){var b=calcFieldDefaults.findSelectedFieldType(this.get("fieldTypes"),a);this.set("fieldTypeName",b.title)})},data:{fns:[],condTypes:[],fieldTypes:[],val:{},condName:"",fieldTypeName:"",fnName:"",fnArgs:[]}});calcFieldDisplay.components.calcFieldDisplay=calcFieldDisplay;var reportCalcFieldManager=Ractive.extend({template:"#reportCalcFieldManagerTemplate",onconstruct:function(){},oninit:function(){this.on("addField",function(){for(var a=this.get("calcFields").length,b=0,c=this.get("calcFields"),d=0;d<a;d++){var e=c[d].column,f=parseInt(e.substr(e.indexOf("_")+1));f>b&&(b=f)}b+=1,this.push("calcFields",calcFieldDefaults.fullField(b))}),this.on("removeItem",function(a,b){this.splice("calcFields",b,1)}),this.on("editSQL",function(a,b){var c=this;new(Ractive.extend({el:jQuery("#modalWindow"),append:!1,template:"#calcFieldCustomSQLTemplate",data:{fieldSQL:"Loading...",customSQL:"",availableFields:c.get("availableFields"),selectedField:"",dialogOptions:{modal:!0,draggable:!0,resizable:!1,width:755,title:translated_labels.label_mass_schedule_title}},components:{selectBox:selectBox},init:function(){var a=this,d={calcField:c.get("calcFields."+b)},e=c.get("calcFields."+b+".customSQL");void 0===e&&(e=""),e=e.replace(/&#039;/g,"'"),a.set("customSQL",e),jQuery.post(urls.withoutAction+"calculatedFieldSQL",d,function(b){a.set("fieldSQL",b)}),a.on("saveCustomSQL",function(){c.set("calcFields."+b+".customSQL",a.get("customSQL")),c.set("calcFields."+b+".enableCustomSQL",!0),jQuery("#modalWindow").dialog("close")}),a.on("cancelCustomSQL",function(){jQuery("#modalWindow").dialog("close")}),jQuery(this.el).dialog(this.data.dialogOptions)},onteardown:function(){this.dialog&&this.dialog.dialog("destroy")}}))}),this.observe("calcFields.*.title",function(a,b,c,d){this.set("calcFields."+d+".bareTitle",a)})},data:{calcFields:[],fields:[],fns:[],condTypes:[],fieldTypes:[]},components:{reportBtnGC:reportBtnGC,calcField:calcField,calcFieldDisplay:calcFieldDisplay,reportButtonPreview:reportButtonPreview,selectBox:selectBox}}),reportPaginationManager=Ractive.extend({template:"#reportPaginationTemplate",append:!1,oninit:function(){var a=this;this.initPagination(),this.observe("isCrosstab",function(a){this.set("showLimitInput",!a)}),this.observe("meta",function(){a.initPagination()}),this.observe("meta.limit",function(a){ReportData.options.limit=a},{init:!1}),this.observe("frozenColumn",function(a){ReportData.options.frozenColumn=a},{init:!1})},changePage:function(a){ReportData.currentResult.meta.currentPage=a,this.fire("preview")},initPagination:function(){var a=this.get("meta"),b=[],c=!1,d=a.currentPage,e=3,f=a.pages,g=f-1,h="...";if(f>1)if(f<7+2*e)for(var i=1;i<a.pages+1;i++)b=push_page(i,a.currentPage,b);else if(d<1+2*e){for(i=1;i<4+2*e;i++)b=push_page(i,a.currentPage,b);b=push_separator(h,b),b=push_page(g,a.currentPage,b),b=push_page(f,a.currentPage,b)}else if(f-2*e>d&&d>2*e){for(b=push_page(1,a.currentPage,b),b=push_page(2,a.currentPage,b),b=push_separator(h,b),i=d-e;i<=d+e;i++)b=push_page(i,a.currentPage,b);b=push_separator(h,b),b=push_page(g,a.currentPage,b),b=push_page(f,a.currentPage,b)}else for(b=push_page(1,a.currentPage,b),b=push_page(2,a.currentPage,b),b=push_separator(h,b),i=f-(1+3*e);i<=f;i++)b=push_page(i,a.currentPage,b);b.length>0&&(c=!0),this.set("isPagination",c),this.set("pagination",b)},data:{meta:[],pagination:[],positionTop:!1,frozenColumn:0,isPagination:!1,showLimitInput:!0,isCrosstab:!1}}),numberFormat=null;DetailGrid={gridElement:"#ar-rv-data-grid",gridOptions:{explicitInitialization:!0,enableColumnReorder:!1,forceFitColumns:!1,autoHeight:!0,enableColumnReorder:!0,enableTextSelectionOnCells:!0},dataViewOptions:{groupItemMetadataProvider:null,inlineFilters:!0},columnOptions:{focusable:!1},grid:null,dataView:null,multiSummaryReport:!1,columns:[],data:[],grandTotalRow:!1,grandTotalColumn:!1,grandTotalCross:!1,grandTotalCalculated:[],pageTotalCalculated:[],calcFields:[],init:function(a,b,c,d){var e=this;this.multiSummaryReport=d,this.groupingManager=b;var f=b.get("selectedFields"),g=jQuery.extend(!0,[],b.get("aggregates"));this.calcFields=c.get("calcFields"),f=parseRangesGroups(f),parseGroupPercent(f,g),this.columns=ReportData.currentResult.cols,this.data=ReportData.currentResult.data,this.grandTotalCalculated=ReportData.currentResult.grandTotal,this.pageTotalCalculated=ReportData.currentResult.pageTotal,this.data=this.setTotals(this),this.columns=this.makeGridColumns(this,f),this.handleColumnStates(this.columns),this.gridOptions.frozenColumn=-1,ReportData.options.frozenColumn>0&&(this.gridOptions.frozenColumn=ReportData.options.frozenColumn-1);var h=parseDateGroups(f),i=new Slick.Data.GroupItemMetadataProvider({groups:h,columns:this.columns,groupingManager:b,groupFocusable:!1,grandTotalLabel:translated_labels.page+" "+translated_labels.total,multiSummaryReport:this.multiSummaryReport,isCrosstab:ReportData.options.isCrosstab});this.dataViewOptions.groupItemMetadataProvider=i,this.dataView=new Slick.Data.DataView(this.dataViewOptions),this.grid=new Slick.Grid(this.gridElement,this.dataView,this.columns,this.gridOptions),this.grid.registerPlugin(this.dataViewOptions.groupItemMetadataProvider),e.dataView.onRowCountChanged.subscribe(function(a,b){e.handleGroupingState(this,e.dataView),e.grid.updateRowCount(),e.grid.render()}),e.dataView.onRowsChanged.subscribe(function(a,b){e.grid.invalidateRows(b.rows),e.grid.render()}),e.grid.onColumnsReordered.subscribe(function(a,b){e.handleColumnStates(e.grid.getColumns())}),e.grid.onColumnsResized.subscribe(function(a,b){e.handleColumnStates(e.grid.getColumns())}),this.data.length>0?(this.grid.init(),this.dataView.beginUpdate(),this.dataView.setItems(this.data),this.setGrouping(g,f),this.dataView.endUpdate(),this.grid.invalidate()):(this.grid.invalidateAllRows(),DetailGrid.showNoDataMessage()),jQuery(document).trigger("slickRenderCompleted"),jQuery(document).on("slickRenderRequest",function(){e.grid.resizeCanvas()})},showNoDataMessage:function(){jQuery(this.gridElement).html('<div style="padding:20px;font-weight:bold;font-size:14px;text-align:left;">No Data</div>')},makeGridColumns:function(a,b){var c=a.columns,d=a.data,e=this,f=[],g=0,h=reportUtils.generateFieldsByNameFromBlocks(ReportData.availableFields),i=this.groupingManager.get("aggregates"),j=new NumberFormatter(jQuery.extend({},{},ReportData.numberFormat),i);numberFormat=j.makeFormatter();var k=parseDateGroups(b);if(_.each(c,function(a,b){var c=!1,i=0,j="",m=k.length;e.multiSummaryReport&&!ReportData.options.includeDetails&&m--;for(var n=0,o=0;o<m;o++)if("column"==k[o].position&&ReportData.options.isCrosstab)n++;else if(k[o].name==b&&"sort"!=k[o].sortAction){c=!0,i=o-n,j+='<span class="slick-group-toggle expanded" level="'+i+'"></span>',j+='<span class="slick-group-toggle collapsed" level="'+i+'"></span>';break}var p=getColumnWidth({data:d,label:a,name:b,grouped:c,groupedLevel:i}),q=DetailGrid.getStateByName(b);q.width&&(p=q.width);var r={id:g++,field:b,name:j+a,nameName:a,focusable:!1,groupTotalsFormatter:DetailGrid.sumTotalsFormatter,formatter:DetailGrid.linkToEntityFormatter,width:p};if(void 0===h[r.field]&&r.field.match(/_min$|_max$|_cnt$|_sum$|_avg$|(v[0-9]{1,}_){1,}$/g)||void 0!==h[r.field]&&("number"===h[r.field].type||"integer"===h[r.field].type))r.formatter=numberFormat;else if(r.field.startsWith("X_Calculated"))for(o=0,l=e.calcFields.length;o<l;o++)if(e.calcFields[o].name==r.field&&"number"==e.calcFields[o].type){r.formatter=numberFormat;break}f.push(r)}),a.grandTotalColumn){var m="grandTotal",n=translated_labels.page+" "+translated_labels.total,o={id:m,name:n,field:m,focusable:!1,cssClass:"bold-column",formatter:j.separator()};grandTotalState=DetailGrid.getStateByName("grandTotal"),grandTotalState&&(o.width=grandTotalState.width),f.push(o)}return f},makeFormatter:function(a){return function(a){return a.value+" <span style='color:green'>("+a.count+")</span>"}},isLastGroupingLevel:function(a,b,c){for(var d=!1,e=c;e<b.length;e++)if("groupsort"==b[e].sortAction||"group"==b[e].sortAction){d=e;break}return d},getSubSorting:function(a,b,c){var d=DetailGrid.isLastGroupingLevel(a,b,c),e=[];if(d===c)return e;if(!1===d)for(var f=c;f<b.length;f++){for(var g={},h=!1,i=0;i<a.length;i++)if(void 0!==b[f].showAggregates[a[i].selectedField]&&b[f].name==a[i].selectedField&&"sort"==b[f].sortAction&&void 0!==b[f].aggregate){g={direction:"ASC"==b[f].sortDirection?1:-1,aggregate:b[f].aggregate,name:a[i].selectedField},h=!0;break}h||(g={direction:"ASC"==b[f].sortDirection?1:-1,aggregate:null,name:b[f].name}),e.push(g)}else for(var f=c;f<d;f++)for(var i=0;i<a.length;i++)if(void 0!==b[f].showAggregates[a[i].selectedField]&&b[f].name==a[i].selectedField&&"sort"==b[f].sortAction&&void 0!==b[f].aggregate){var g={direction:"ASC"==b[f].sortDirection?1:-1,aggregate:b[f].aggregate,name:a[i].selectedField};e.push(g);break}return e},getGroupSorting:function(a,b){for(var c=[],d=0;d<b.length;d++)if("groupsort"==b[d].sortAction){var e,f=b[d].aggregate.split("_"),g=f.shift();f=f.join("_"),e=1==DetailGrid.multiSummaryReport&&d==b.length-1?[{aggregate:"none",direction:"ASC"==b[d].sortDirection?1:-1,name:f+"_"+g}]:[{direction:"ASC"==b[d].sortDirection?1:-1,aggregate:"count"==g?"cnt":g,name:f}],c.push(e)}else if("group"==b[d].sortAction){var e=DetailGrid.getSubSorting(a,b,d+1);c.push(e)}return c},getFieldAggregator:function(a,b){for(var c=[{key:b+"_min",aggregate:"min"},{key:b+"_max",aggregate:"max"},{key:b+"_sum",aggregate:"sum"},{key:b+"_cnt",aggregate:"sum"},{key:b+"_countDistinct",aggregate:"sum"},{key:b+"_avg",aggregate:"avg"}],d=0;d<c.length;d++){var e=a.replace(c[d].key,""),f=e.match(/v[0-9]+_$/);if(e!==a&&f)return{field:f[0]+c[d].key,aggregate:c[d].aggregate}}return!1},setGrouping:function(a,b){var c=[],d=DetailGrid.getGroupSorting(a,b),e=function(a){var b=a;return function(a,c){for(var d=0,e=0;e<b.length;e++)if("none"!==b[e].aggregate&&("min"==b[e].aggregate||"max"==b[e].aggregate||"sum"==b[e].aggregate||"cnt"==b[e].aggregate||"count"==b[e].aggregate||"countDistinct"==b[e].aggregate||"avg"==b[e].aggregate)&&null!==a.totals){var f=void 0===a.totals[b[e].aggregate]||void 0===a.totals[b[e].aggregate][b[e].name]?void 0===a.totals.sum||void 0===a.totals.sum[b[e].name+"_"+b[e].aggregate]?0:a.totals.sum[b[e].name+"_"+b[e].aggregate]:a.totals[b[e].aggregate][b[e].name],g=void 0===c.totals[b[e].aggregate]||void 0===c.totals[b[e].aggregate][b[e].name]?void 0===c.totals.sum||void 0===c.totals.sum[b[e].name+"_"+b[e].aggregate]?0:c.totals.sum[b[e].name+"_"+b[e].aggregate]:c.totals[b[e].aggregate][b[e].name];if(0!=(d=b[e].direction*(f-g)))break}return 0===d&&(d=a.rows[0].id>=c.rows[0].id?1:-1),d}},f=parseDateGroups(b);if(ReportData.options.isCrosstab)for(var g=0;g<f.length;g++)"column"==f[g].position&&f.splice(g,1);if(this.multiSummaryReport&&!ReportData.options.includeDetails){var h=f.pop();h&&1==h.groupByRange&&"originalValue"!=h.groupByAggregate&&(f.unshift(h),f.pop())}for(var i=(f.length,-1),g=0;g<f.length;g++)if("sort"!=f[g].sortAction){i++,columnStates=DetailGrid.getStateByName(f[g].name);var j=!1;if(columnStates.collapsed)var j=columnStates.collapsed;for(var k=f[g].title,l={getter:f[g].name,aggregators:[],formatter:DetailGrid.makeFormatter(k),aggregateCollapsed:!0,lazyTotalsCalculation:!1,displayTotalsRow:!1,comparer:e(d[i]),collapsed:j},m=0;m<a.length;m++)if(f[g].showAggregates){var n=a[m].selectedField;if(ReportData.options.isCrosstab){for(column in ReportData.currentResult.cols)if(ReportData.currentResult.cols.hasOwnProperty(column)){var o=this.getFieldAggregator(column,n);o&&("min"==o.aggregate&&l.aggregators.push(new Slick.Data.Aggregators.Min(o.field)),"max"==o.aggregate&&l.aggregators.push(new Slick.Data.Aggregators.Max(o.field)),"sum"==o.aggregate&&l.aggregators.push(new Slick.Data.Aggregators.Sum(o.field)),"cnt"==o.aggregate&&l.aggregators.push(new Slick.Data.Aggregators.Sum(o.field)),"countDistinct"==o.aggregate&&l.aggregators.push(new Slick.Data.Aggregators.Sum(o.field)),"avg"==o.aggregate&&l.aggregators.push(new Slick.Data.Aggregators.Avg(o.field)))}}else void 0!==f[g].showAggregates[a[m].selectedField]&&(a[m].value.min&&f[g].showAggregates[a[m].selectedField].min&&(_fieldName=n,this.multiSummaryReport&&(_fieldName+="_min"),l.aggregators.push(new Slick.Data.Aggregators.Min(_fieldName))),a[m].value.max&&f[g].showAggregates[a[m].selectedField].max&&(_fieldName=n,this.multiSummaryReport&&(_fieldName+="_max"),l.aggregators.push(new Slick.Data.Aggregators.Max(_fieldName))),a[m].value.sum&&f[g].showAggregates[a[m].selectedField].sum&&(_fieldName=n,this.multiSummaryReport&&(_fieldName+="_sum"),l.aggregators.push(new Slick.Data.Aggregators.Sum(_fieldName))),a[m].value.count&&f[g].showAggregates[a[m].selectedField].count&&(_fieldName=n,this.multiSummaryReport?(_fieldName+="_cnt",l.aggregators.push(new Slick.Data.Aggregators.Sum(_fieldName))):l.aggregators.push(new Slick.Data.Aggregators.Cnt(_fieldName))),a[m].value.countDistinct&&f[g].showAggregates[a[m].selectedField].countDistinct&&(_fieldName=n,this.multiSummaryReport?(_fieldName+="_cnt",l.aggregators.push(new Slick.Data.Aggregators.Sum(_fieldName))):l.aggregators.push(new Slick.Data.Aggregators.CountDistinct(_fieldName))),a[m].value.avg&&f[g].showAggregates[a[m].selectedField].avg&&(_fieldName=n,this.multiSummaryReport&&(_fieldName+="_avg"),l.aggregators.push(new Slick.Data.Aggregators.Avg(_fieldName))))}c.push(l)}this.dataView.setGrouping(c)},sumTotalsFormatter:function(a,b){var c="";if(!a)return"";var d="";return-1!==b.field.indexOf("total_percent")&&(d="%"),a.grandTotals&&a.grandTotals[b.field]?(val=a.grandTotals[b.field],"<b>"+numberFormat(null,null,val,b,"grandTotal")+"</b>"):(a.min&&a.min[b.field]?(val=a.min&&a.min[b.field],c+="<b>"+numberFormat(null,null,val,b,"min")+"</b>"):a.max&&a.max[b.field]?(val=a.max&&a.max[b.field],c+="<b>"+numberFormat(null,null,val,b,"max")+"</b>"):a.sum&&a.sum[b.field]?(val=a.sum&&a.sum[b.field],c+="<b>"+numberFormat(null,null,val,b,"sum")+d+"</b>"):a.cnt&&a.cnt[b.field]?(val=a.cnt[b.field],c+="<b>"+numberFormat(null,null,val,b,"count")+"</b>"):a.countDistinct&&a.countDistinct[b.field]?(val=a.countDistinct[b.field],c+="<b>"+numberFormat(null,null,val,b,"countDistinct")+"</b>"):a.avg&&a.avg[b.field]&&(val=a.avg[b.field],c+="<b>"+numberFormat(null,null,val,b,"avg")+"</b>"),c)},linkToEntityFormatter:function(a,b,c,d,e){var f=e[d.field+"_id"],g=e[d.field+"_setype"];if(f&&g){var h="index.php?module="+g+"&action=DetailView&record="+f;return 1==$isSidecar&&(h=$site_url+"/#"+g+"/"+f),'<a href="'+h+'" class="link-cell" target="_blank">'+c+"</a>"}return c},makeTotals:function(a,b){var c=a.groupingManager.get("totalAggregates"),d=a.groupingManager.get("aggregates"),e={},f=ReportData.options.isCrosstab;jQuery.each(d,function(b,d){if((f||a.multiSummaryReport)&&c[d.selectedField]){if(c[d.selectedField].min){var g=d.selectedField+"_min";e[g]=0}if(c[d.selectedField].max){var g=d.selectedField+"_max";e[g]=0}if(c[d.selectedField].sum){var g=d.selectedField+"_sum";e[g]=0}if(c[d.selectedField].count){var g=d.selectedField+"_cnt";e[g]=0}if(c[d.selectedField].countDistinct){var g=d.selectedField+"_countDistinct";e[g]=0}if(c[d.selectedField].avg){var g=d.selectedField+"_avg";e[g]=0}}else c[d.selectedField]&&(c[d.selectedField].min&&(e[d.selectedField]=0),c[d.selectedField].max&&(e[d.selectedField]=0),c[d.selectedField].avg&&(e[d.selectedField]=0),c[d.selectedField].sum&&(e[d.selectedField]=0),c[d.selectedField].count&&(e[d.selectedField]=0),c[d.selectedField].countDistinct&&(e[d.selectedField]=0))});for(field in e)if(e.hasOwnProperty(field))for(column in b)if(b.hasOwnProperty(column)){var g=column.replace(field,""),h=g.match(/v[0-9]+_/);h&&(e[column]=0)}return e},setTotals:function(a){gHasTotals=!1;var b=a.groupingManager.get("totalAggregates"),c=jQuery.extend(!0,[],a.data),d=ReportData.options.isCrosstab,e=currentUser.numberPreferences.currencySignificantDigits,f=DetailGrid.makeTotals(a,a.columns),g=jQuery.extend(!0,{},f);if(jQuery.isEmptyObject(f))return c;a.grandTotalRow=!1,ReportData.options.aggregateColumn||(a.grandTotalRow=!0),a.grandTotalColumn=!1,d&&ReportData.options.aggregateColumn&&(a.grandTotalColumn=!0),d&&ReportData.options.grandTotalBoth?(a.grandTotalRow=!0,a.grandTotalColumn=!0,a.grandTotalCross=!0):a.grandTotalCross=!1,jQuery.each(c,function(a,c){for(field in f)if(f.hasOwnProperty(field)){var d=null===this[field]||"-"==this[field]&&void 0!==this[field+"_setype"],e=!ReportData.options.includeDetails||d&&DetailGrid.multiSummaryReport||b[field]&&b[field].sum?parseFloat(this[field]):1;e&&(f[field]+=e)}});for(field in f)f.hasOwnProperty(field)&&(DetailGrid.isDateTimeField(field,a)?f[field]="":field.endsWith("_cnt")||(f[field]=(+f[field]).toFixed(e)));if(a.grandTotalColumn)for(var h=0,i=0;i<c.length;i++){var j=c[i],k=0;for(column in j)if(g.hasOwnProperty(column)){var l=!1;(""+j[column]).match(/^[\-]{0,}[0-9]+[.0-9]*$/)&&(l=!0),l&&(k+=parseFloat(j[column]))}h+=k,j.grandTotal=k}if(a.grandTotalCross&&(f.grandTotal=h),a.grandTotalRow){var m=a.columns,n=[];for(field in f)f.hasOwnProperty(field)&&n.push(field);var o=!1;for(columnName in m)if(-1==n.indexOf(columnName)){o=columnName;break}f[o]="<strong>"+translated_labels.page+" "+translated_labels.total+"</strong>",c.length>0&&(f.id=c[c.length-1].id,f.id++,f.noGrouping=!0);var p=jQuery.extend(!0,{},f);p.id++,p[o]="<strong>"+translated_labels.label_grand_total+"</strong>";for(columnName in p){if(!a.grandTotalCalculated)break;if(void 0!==a.grandTotalCalculated[columnName])for(aggregate in a.grandTotalCalculated[columnName]){p[columnName]=a.grandTotalCalculated[columnName][aggregate];break}}if(!d&&a.pageTotalCalculated)for(columnName in f)if(void 0!==a.pageTotalCalculated[columnName])for(aggregate in a.pageTotalCalculated[columnName]){f[columnName]=a.pageTotalCalculated[columnName][aggregate];break}c.push(f),d||c.push(p),a.grandTotalId=f.id,gHasTotals=!0}return c},isDateTimeField:function(a,b){var c=b.groupingManager.get("fieldsByName"),d=[];for(_field in c)c.hasOwnProperty(_field)&&("time"!=c[_field].type&&"date"!=c[_field].type&&"datetime"!=c[_field].type||d.push(c[_field].name));for(var e=0;e<d.length;e++)for(var f=d[e],g=["min","max","sum","cnt","avg","countDistinct"],h=0;h<g.length;h++)if(a==f+"_"+g[h])return!0;return!1},handleColumnStates:function(a){for(var b=ReportData.reportStates.columnStates,c=[],d=0;d<a.length;d++){for(var e={name:a[d].field,width:a[d].width},f=0;f<b.length;f++)b[f].name==e.name&&(b[f].collapsed&&(e.collapsed=b[f].collapsed),b.splice(f,1));c.push(e)}c=c.concat(b),ReportData.reportStates.columnStates=c,jQuery(window).trigger("resize.doubleScroll")},handleGroupingState:function(a,b){for(var c=ReportData.reportStates.columnStates,d=a.getGrouping(),e=0;e<c.length;e++)for(var f=0;f<d.length;f++)if(c[e].name==d[f].getter){c[e].collapsed=d[f].collapsed;break}ReportData.reportStates.columnStates=c},getStateByName:function(a){for(var b=ReportData.reportStates.columnStates,c=0;c<b.length;c++)if(b[c].name==a)return b[c];return!1}},SummaryGrid={gridElement:"#ar-rv-data-grid",gridOptions:{explicitInitialization:!0,enableColumnReorder:!1,forceFitColumns:!1,autoHeight:!0,enableColumnReorder:!0,enableTextSelectionOnCells:!0},dataViewOptions:{groupItemMetadataProvider:null,inlineFilters:!0},columnOptions:{focusable:!1},grid:null,grandTotalId:null,dataView:null,multiSummaryReport:!0,columns:[],data:[],grandTotalRow:!1,grandTotalColumn:!1,grandTotalCross:!1,grandTotalCalculated:[],pageTotalCalculated:[],init:function(a,b,c){var d=this;this.groupingManager=b,this.columns=ReportData.currentResult.cols,this.data=ReportData.currentResult.data,this.grandTotalCalculated=ReportData.currentResult.grandTotal,this.pageTotalCalculated=ReportData.currentResult.pageTotal,this.data=DetailGrid.setTotals(this),this.columns=this.makeGridColumns(this,!0),DetailGrid.handleColumnStates(this.columns),this.gridOptions.frozenColumn=-1,ReportData.options.frozenColumn>0&&(this.gridOptions.frozenColumn=ReportData.options.frozenColumn-1),this.dataView=new Slick.Data.DataView(this.dataViewOptions),this.grid=new Slick.Grid(this.gridElement,this.dataView,this.columns,this.gridOptions),d.grid.onColumnsReordered.subscribe(function(a,b){DetailGrid.handleColumnStates(d.grid.getColumns())}),d.grid.onColumnsResized.subscribe(function(a,b){DetailGrid.handleColumnStates(d.grid.getColumns())}),this.data.length>0?(this.grid.init(),this.dataView.beginUpdate(),this.dataView.setItems(this.data),this.dataView.endUpdate(),this.grid.invalidate()):(this.grid.invalidateAllRows(),DetailGrid.showNoDataMessage());var e="id",f=function(a,b){var c=void 0===a[e]?"":a[e],d=void 0===b[e]?"":b[e],f=parseFloat(c),g=parseFloat(d);return isNaN(f)||isNaN(g)||(c=f,d=g),c==d?0:c>d?1:-1};this.grid.onSort.subscribe(function(a,b){e=b.sortCol.field;var c;if(d.grandTotalId){var c=d.dataView.getItemById(d.grandTotalId);d.dataView.deleteItem(d.grandTotalId)}d.dataView.sort(f,b.sortAsc),d.grandTotalId&&d.dataView.addItem(c),d.grid.invalidate(),d.grid.render(),d.highlightGrandTotal()}),this.highlightGrandTotal(),jQuery(document).trigger("slickRenderCompleted"),jQuery(document).on("slickRenderRequest",function(){d.grid.resizeCanvas()})},highlightGrandTotal:function(){if(null!==this.grandTotalId&&!ReportData.options.aggregateColumn){jQuery(this.grid.getCanvasNode()).children().last().children().wrapInner("<strong>")}},makeGridColumns:function(a,b){var c=a.columns,d=a.data;b=b||!1;var e=[],f=0,g=reportUtils.generateFieldsByNameFromBlocks(ReportData.availableFields),h=this.groupingManager.get("aggregates");if(numberFormat=new NumberFormatter(jQuery.extend({},{},ReportData.numberFormat),h).makeFormatter(),_.each(c,function(a,c){var h=getColumnWidth({data:d,label:a,name:c,grouped:!1}),i=DetailGrid.getStateByName(c);i.width&&(h=i.width);var j={id:f++,field:c,name:a,focusable:!1,sortable:b,formatter:DetailGrid.linkToEntityFormatter,width:h};(void 0===g[j.field]&&j.field.match(/_min$|_max$|_cnt$|_countDistinct$|_sum$|_avg$|(v[0-9]{1,}_){1,}$/g)||"X_Calculated_N"==j.field.substring(0,14)||void 0!==g[j.field]&&("number"===g[j.field].type||"integer"===g[j.field].type))&&(j.formatter=numberFormat),e.push(j)}),a.grandTotalColumn){var i="grandTotal",j=translated_labels.page+" "+translated_labels.total,k={id:i,name:j,field:i,focusable:!1,cssClass:"bold-column",formatter:numberFormat};grandTotalState=DetailGrid.getStateByName("grandTotal"),grandTotalState&&(k.width=grandTotalState.width),e.push(k)}return e}};var chartButtons=Ractive.extend({template:'<reportBtn text="'+translated_labels.label_preview+'" on-clicked="preview" className="green" />',data:{className:""},components:{reportBtn:reportBtn}}),chartTypeManager=Ractive.extend({template:"#chartTypeTemplate",oninit:function(){this.observe("chartSize",function(a){ReportData.chartSize=a}),this.observe("chartType",function(a){ReportData.chartType=a})},data:{chartTypes:[{name:"pie",title:translated_labels.label_pie_chart},{name:"bar",title:translated_labels.label_column_chart},{name:"hbar",title:translated_labels.label_horizontal_bar_chart},{name:"line",title:translated_labels.label_line_chart},{name:"combined",title:translated_labels.label_combined_chart},{name:"funnel",title:translated_labels.label_funnel_chart},{name:"gauge",title:translated_labels.label_gauge_chart},{name:"map",title:translated_labels.label_map_chart},{name:"area",title:translated_labels.label_area_chart}],chartType:ReportData.chartType,chartTitle:ReportData.chartTitle,chartSizes:ReportData.chartSizes,chartSize:ReportData.chartSize},components:{chartButtons:chartButtons,selectBoxImg:selectBoxImg,selectBox:selectBox}}),BaseChartComponent=Ractive.extend({isolated:!1,chartHeight:600,chartHeightModifier:1.2,bigValues:!1,parentInit:function(){var a=this;this.get("isWidget")||((ReportData.chartHeight||ReportData.chartHeight>0)&&(this.chartHeight=ReportData.chartHeight),this.on("increaseHeight",function(){a.chartIncreaseHeight()}),this.on("decreaseHeight",function(){a.chartDecreaseHeight()}),this.on("changeColor",function(b){a.changeColor(b)}),jQuery(document).on("d3RenderRequest",function(){a.chartUpdate()})),a.chart&&setTimeout(function(){console.log("chart update now ",a.chart)},300)},chartUpdate:function(){this.chart&&this.chart.update&&this.chart.update()},chartIncreaseHeight:function(){this.chartHeight=Math.round(this.chartHeight*this.chartHeightModifier),jQuery("#chart1").css({height:this.chartHeight}),ReportData.chartHeight=this.chartHeight,this.chartUpdate()},chartDecreaseHeight:function(){this.chartHeight=Math.round(this.chartHeight/this.chartHeightModifier),jQuery("#chart1").css({height:this.chartHeight}),ReportData.chartHeight=this.chartHeight,this.chartUpdate()},changeColor:function(a){this.chartColors=jQuery.extend({},ReportData.chartColors,a),ReportData.chartColors=this.chartColors,this.updateData()},parseGroups:function(a,b,c,d){for(var c=[].concat(c),d=[].concat(d),e=[],f=[],g=this.get("chartColors"),h={},i=this.get("reportData"),j=0;j<a.data.length;j++){for(var k=0;k<d.length;k++){var l=d[k],m=l+"_raw",n=a.data[j][m];n||(n="-"),e.push(a.data[j][m]),h[a.data[j][m]]=a.data[j][l]}a.data[j][b]||(a.data[j][b]="-"),f.push(a.data[j][b])}var o=this.getTopLefLegendFieldOrdering(d[0],i.chartGrouping);e=reportUtils.unique(e).sort(function(a,b){return"ASC"==o?a-b:b-a}),f=reportUtils.unique(f),this.axisKeys=f;for(var p=[],j=0;j<e.length;j++){var q=h[e[j]];p[j]={key:q,values:[]};var r=d3.scale.category10().range();g&&g[q]?p[j].color=g[q]:p[j].color=r[j];for(var k=0;k<f.length;k++)p[j].values[k]={x:k,y:0},p[j].values[k].meta=this.parseMetaDrilldown([{fieldName:d[0],value:this.parseMetaValue(a.data[j],d[0]),type:"legend"},{fieldName:b,value:this.parseMetaValue(a.data[j],b),type:"xAxis"}])}var s=[];for(var t in h)s.push(h[t]);for(var j=0;j<a.data.length;j++)for(var u=f.indexOf(a.data[j][b]),k=0;k<d.length;k++){var v=s.indexOf(a.data[j][d[k]]);a.data[j][c]||(a.data[j][c]=0),p[v].values[u].y+=parseFloat(a.data[j][c]),parseFloat(a.data[j][c])>=5&&(this.bigValues=!0),p[v].values[u].meta=this.parseMetaDrilldown([{fieldName:d[k],value:this.parseMetaValue(a.data[j],d[k]),type:"legend"},{fieldName:b,value:this.parseMetaValue(a.data[j],b),type:"xAxis"}])}return p},parseAggregatesSwap:function(a,b,c,d){for(var e=[],f=[],g=[],h=0;h<d.length;h++)e.push(d[h]);for(var f=[].concat(c),i=[],j=0;j<f.length;j++)i.push(a.cols[f[j]]);this.axisKeys=i;var k=a.cols[b];g[0]={key:k,values:[]};for(var h=0;h<f.length;h++)g[0].values[h]={x:h,y:0};for(var j=0;j<a.data.length;j++)for(var h=0;h<f.length;h++)for(var l=f[h],m=0;m<g.length;m++)g[m].values[h].y+=parseFloat(a.data[j][l]);return g},parseAggregates:function(a,b,c,d){for(var e=[],f=[],g=this.get("chartColors"),h=0;h<d.length;h++)e.push(d[h]);for(var i=0;i<a.data.length;i++)a.data[i][b]||(a.data[i][b]="-"),f.push(a.data[i][b]);e=reportUtils.unique(e),f=reportUtils.unique(f),this.axisKeys=f;for(var j=[],i=0;i<e.length;i++){j[i]={key:e[i],values:[]};for(var h=0;h<f.length;h++)j[i].values[h]={x:h,y:0}}for(var i=0;i<a.data.length;i++)for(var k=f.indexOf(a.data[i][b]),h=0;h<d.length;h++)for(var l=0;l<j.length;l++)j[l].key==d[h]&&(a.data[i][d[h]]||(a.data[i][d[h]]=0),this.bigValues=!0,j[l].values[k].y+=parseFloat(a.data[i][d[h]]),j[l].values[k].meta=this.parseMetaDrilldown([{fieldName:d[h],value:this.parseMetaValue(a.data[i],d[h]),type:"legend"},{fieldName:b,value:this.parseMetaValue(a.data[i],[b]),type:"xAxis"}]));for(var i=0;i<j.length;i++)j[i].key=a.cols[j[i].key],g&&g[j[i].key]&&(j[i].color=g[j[i].key]);return j},parseMetaDrilldown:function(a){var b=this.get("aggregates"),c=reportUtils.getAvailableGroups(this.get("reportData"),this.get("groups"),this.get("fieldsByName"));if(c.length<1)return!1;a=_.uniq(a,function(a){return a.fieldName});for(var d=0;d<a.length;d++){reportUtils.getAggregate(a[d].fieldName,b)&&a.splice(d,1),a[d].condition="eq";var e=this.findGroupingWithDate(c,a[d].fieldName);e&&(a[d].fieldName=e.aggregate,a[d].condition=e.dateGrouping),"-"!=a[d].value&&""!=a[d].value||(a[d].condition="empty")}return a},parseMetaValue:function(a,b){if(a){if(void 0!==a[b+"_setype"]){if(0==["Users"].indexOf(a[b+"_setype"]))return a[b+"_id"]}return a[b+"_value"]?a[b+"_value"]:a[b]}},findGroupingWithDate:function(a,b){for(var c=0;c<a.length;c++)if(a[c].dateGrouping){var d=b+"_"+a[c].dateGrouping;if(a[c].name==b||a[c].name==d)return a[c]}return!1},findByKeyValue:function(a,b,c){for(var d={},e=0;e<a.length;e++)if(a[e][b]==c){d=a[e];break}return d},colorPickerCallback:function(a){d3.selectAll(".nvtooltip").style("opacity",0),a.get("isWidget")||(a.spectrumContainer&&jQuery(a.spectrumContainer).remove(),jQuery("#drilldownpopup").spectrum({clickoutFiresChange:!1,preferredFormat:"hex",change:function(b){var c=b.toHexString(),d=jQuery("#colorForField").val(),e={};e[d]=c,a.changeColor(e),jQuery(".d3-context-menu").hide()}}),a.spectrumContainer=jQuery("#drilldownpopup").spectrum("container"))},getTopLefLegendFieldOrdering:function(a,b){for(var c="ASC",d=0;d<b.length;++d){var e=b[d],f=e.name;if(e.dateGrouping.length&&"default"!=e.dateGrouping&&(f+="_"+e.dateGrouping),f==a&&"DESC"==e.sortDirection){c="DESC";break}}return c}}),ChartView=Ractive.extend({isolated:!1,template:'<chartComponent data="{{data}}" title="{{title}}" isWidget="{{isWidget}}" xAxis="{{xAxis}}" yAxis="{{yAxis}}" yAxis2="{{yAxis2}}" yAxisType="{{yAxisType}}" yAxis2Type="{{yAxis2Type}}" legend="{{legend}}" bars1Stacked="{{bars1Stacked}}" bars2Stacked="{{bars2Stacked}}" aggregates="{{aggregates}}" groups="{{groups}}" cumulated="{{cumulated}}" sortableValues="{{sortableValues}}" showPercents="{{showPercents}}" showLabels="{{showLabels}}" showZoneLabels="{{showZoneLabels}}" valueZones="{{valueZones}}" xAxisSegment="{{xAxisSegment}}" svg="{{svg}}" decimalDigits={{decimalDigits}} type="{{type}}" mapType="{{mapType}}" country="{{country}}" state="{{state}}" zoom="{{zoom}}" lat="{{lat}}" lng="{{lng}}" labels="{{labels}}" getAvailableGroups="{{getAvailableGroups}}" marker="{{marker}}" markerAxisX="{{markerAxisX}}" markerAxisY="{{markerAxisY}}" drilldownEnabled="{{drilldownEnabled}}" swapAxis="{{swapAxis}}" chartColors="{{chartColors}}" d3="{{d3}}" nv="{{nv}}"/>',computed:{drilldownEnabled:function(){var a=this.get("options");return!a.isCombined&&!(!this.get("canEdit")&&!this.get("canDelete")&&!a.allowDrilldownReadOnly)}},data:{d3:"undefined"!=typeof ard3?ard3:d3,nv:"undefined"!=typeof arnv?arnv:nv,title:"",type:!1,xAxisSegment:!1,valueZones:[],showPercents:!1,showLabels:!0,showZoneLabels:!0,cumulated:!0,sortableValues:[],isWidget:!1,aggregates:[],groups:[],xAxis:[],yAxis:[],yAxis2:[],legend:[],yAxisType:[],yAxis2Type:[],svg:"",numberFormat:{},decimalDigits:0,mapType:!1,country:!1,state:!1,zoom:2,lat:51.505,lng:-.09,labels:{},fieldsByName:{},options:{},chartOptions:{},combinedSelectedFields:[],availableFields:[],columns:[],calcFields:[],getAvailableGroups:[],filters:[],margin:{},stacked:!1,reportData:{},marker:!1,markerAxisX:!1,markerAxisY:!1,canEdit:!1,canDelete:!1,swapAxis:!1,chartColors:{}}}),BarChartLegendManager=Ractive.extend({template:"#barChartLegendTemplate",oninit:function(){var a=this;this.get("yAxis")instanceof String&&this.set("yAxis",[this.get("yAxis")]),this.get("legend")instanceof String&&this.set("legend",[this.get("legend")]);var b=function(){for(var b=[],c=(a.get("groups"),a.get("aggregates")),d=a.get("fieldsByName"),e=0;e<c.length;e++){var f,g=d[c[e].selectedField].title,h=c[e].selectedField;for(f in aggregatesDefinitions)c[e].value[f]&&b.push({name:h+aggregatesDefinitions[f].namePostfix,title:g+" "+translated_labels[aggregatesDefinitions[f].label]})}b=_.uniq(b,function(a){return a.name});var i=[{key:translated_labels.label_groups,values:a.get("getAvailableGroups")},{key:translated_labels.label_aggregates,values:b}],b=[{key:translated_labels.label_aggregates,values:b}];a.set("availableAxis",b),a.set("availableGroups",a.get("getAvailableGroups")),a.set("availableLegends",i)};this.observe("groups",b),this.observe("aggregates",b,{init:!1}),this.observe("xAxis",validateXAxis,{init:!1}),this.observe("yAxis",function(b){1==b.length?a.set("legend",[this.get("xAxis")]):a.set("legend",b),ReportData.chartAxisY=b},{init:!1}),this.observe("xAxis",function(b){1==a.get("yAxis").length&&a.set("legend",[this.get("xAxis")])},{init:!1}),this.observe("y2Axis",function(a){ReportData.chartAxisY2=a},{init:!1}),0==this.get("legend").length&&this.set("legend",[this.get("xAxis")]),this.observe("legend",function(b){ReportData.chartLegend=b;for(var c=a.get("aggregates"),d=!1,e=0;e<b.length;e++)if(reportUtils.getAggregate(b[e],c)){d=!0;break}d&&a.set("yAxis",b)}),this.observe("chartSize",function(a){ReportData.chartSize=a}),this.observe("decimalDigits",function(a){ReportData.chartDecimalDigits=a}),this.observe("showPercents",function(a){ReportData.chartShowPercents=a}),this.observe("swapAxis",function(a){ReportData.chartSwapAxis=a})},computed:{getAvailableGroups:function(){return reportUtils.getAvailableGroups(this.get("reportData"),this.get("groups"),this.get("fieldsByName"))}},data:{xAxis:ReportData.chartAxisX,yAxis:ReportData.chartAxisY,y2Axis:ReportData.chartAxisY2,chartTitle:ReportData.chartTitle,legend:ReportData.chartLegend,availableLegends:[],labelName:ReportData.chartLabels,groups:[],aggregates:[],availableAxis:[],availableGroups:[],chartSizes:ReportData.chartSizes,chartSize:ReportData.chartSize,chartDecimals:[],decimalDigits:0,showPercents:ReportData.chartShowPercents,swapAxis:!1},components:{chartButtons:chartButtons,selectBox:selectBox,multiSelectBox:multiSelectBox}}),ReportBarChart={parseDataItems:function(a,b,c,d,e){for(var f=0;f<a.length;f++){if("string"==typeof a[f]){var g=reportUtils.getAggregate(a[f],b),h=reportUtils.getGroup(a[f],c);g&&e.push(g),h&&d.push(h)}"object"==typeof a[f]&&this.parseDataItems(a[f],b,c,d,e)}},prepareData:function(a,b,c,d,e){var f=ReportData.chartAxisX,g=ReportData.chartAxisY,h=ReportData.chartLegend,i=[],j=[],k=[];if(k.push(f),k.push(g),k.push(h),this.parseDataItems(k,d,e,j,i),j=_.uniq(j,function(a){return a.name+"_"+a.dateGrouping}),ReportData.options.isCombined){var l=a.get("combinedSelectedFields.fields");for(moduleId in l)for(var m=l[moduleId],n=0;n<ReportData.availableFields.length;n++)for(var o=0;o<ReportData.availableFields[n].fields.length;o++)if(m==ReportData.availableFields[n].fields[o].name){var p=jQuery.extend(!0,{},ReportData.availableFields[n].fields[o]);p={name:m},p.sortAction="date_field"==ReportData.chartAxisX?"nogroup"!==ReportData.combinedSelectedFields.sortAction?ReportData.combinedSelectedFields.sortAction:"group":"nogroup",p.dateGrouping=ReportData.combinedSelectedFields.dateGrouping,p.sortDirection=ReportData.combinedSelectedFields.sortDirection,p.position=ReportData.combinedSelectedFields.position,j.unshift(p)}}for(var q=[],n=0;n<i.length;n++)q.indexOf(i[n].selectedField)>-1?(i.splice(n,1),n--):q.push(i[n].selectedField);var r={chartShowPercents:ReportData.chartShowPercents,type:"bar",chartAggregates:d};return{filters:JSON.stringify(b),columns:JSON.stringify(c),options:JSON.stringify(ReportData.chartOptions),labels:JSON.stringify(ReportData.labels),aggregates:JSON.stringify(i),grouping:JSON.stringify(j),calcFields:JSON.stringify(ReportData.calcFields),chartSettings:r}},init:function(a,b,c,d,e){loadChart("bar",this.prepareData(a,b,c,d,e),d,e)}},BarChartComponent=BaseChartComponent.extend({template:function(a){return a.isWidget?"<svg></svg>":"#chartViewTemplate"},oninit:function(){this.parentInit()},onrender:function(){var a=this,b=a.get("data"),c=a.get("title"),d=a.get("svg"),e=a.get("isWidget"),f={top:50,right:50,bottom:120,left:70};!e&&a.get("margin")&&(f=a.get("margin"));var g=this.get("d3"),h=this.get("nv");h.addGraph(function(){var i=h.models.discreteBarChart().options({reduceXTicks:!1}).x(function(a){return a.label}).y(function(a){return a.value}).staggerLabels(!1).showValues(!0).margin(f).color(g.scale.category10().range()).valueFormat(function(a){return chartView.get("numberFormat")(null,null,a)});return i.xAxis.rotateLabels(-30),a.bigValues&&i.yAxis.tickFormat(function(a){return chartView.get("numberFormat")(null,null,a)}),i.forceY(0),g.select(d).datum(a.normalise(b)).call(i),e||g.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),h.utils.windowResize(i.update),a.chartUpdate(),a.get("drilldownEnabled")&&i.discretebar.dispatch.on("elementClick",g.contextMenu(getContextMenuElements(a.get("reportData")),function(){a.colorPickerCallback(a)})),a.chart=i,i})},updateData:function(){var a=this,b=a.get("data"),c=a.get("svg");a.set("chartColors",ReportData.chartColors),d3.select(c).datum(a.normalise(b)).call(a.chart)},normalise:function(a){var b=this,c=this.get("xAxis"),d=this.get("yAxis");c=reportUtils.appendDateGrouping(a,c);var e=[];return _.each(a.data,function(a){a[d]||(a[d]=0),this.bigValues=!0;var f={label:a[c],value:parseFloat(a[d]),meta:b.parseMetaDrilldown([{fieldName:c,value:b.parseMetaValue(a,c),type:"legend"}])},g=b.get("chartColors");g&&g[a[c]]&&(f.color=g[a[c]]),e.push(f)}),[{values:e}]},data:{data:[],title:"",xAxis:"",yAxis:"",swapAxis:!1,svg:""}});MultiBarChartComponent=BaseChartComponent.extend({template:function(a){return a.isWidget?"<svg></svg>":"#chartViewTemplate"},oninit:function(){this.parentInit()},onrender:function(){var a=this,b=a.get("data"),c=a.get("title"),d=a.get("svg"),e=a.get("isWidget"),f=a.get("stacked"),g={top:50,right:150,bottom:120,left:70},h=this.get("d3"),i=this.get("nv");!e&&a.get("margin")&&(g=a.get("margin"));var h=this.get("d3"),i=this.get("nv");i.addGraph(function(){var j=i.models.multiBarChart().reduceXTicks(!1).margin(g).stacked(f).color(h.scale.category10().range());j.xAxis.tickFormat(function(b){return void 0!==a.axisKeys[b]?a.axisKeys[b]:""}),j.xAxis.rotateLabels(-30),a.bigValues&&j.yAxis.tickFormat(function(a){return chartView.get("numberFormat")(null,null,a)}),e||j.legend.margin({top:20,bottom:20});var k=a.normalise(b);return h.select(d).datum(k).call(j),j.dispatch.on("stateChange",function(a){e||(ReportData.chartStacked=a.stacked)}),e||h.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),i.utils.windowResize(j.update),a.chartUpdate(),a.get("drilldownEnabled")&&j.multibar.dispatch.on("elementClick",h.contextMenu(getContextMenuElements(a.get("reportData")),function(){a.colorPickerCallback(a)})),a.chart=j,j})},updateData:function(){var a=this,b=a.get("data"),c=a.get("svg");a.set("chartColors",ReportData.chartColors);var d=a.normalise(b);d3.select(c).datum(d).call(a.chart)},normalise:function(a){var b=this.get("legend"),c=this.get("xAxis"),d=this.get("yAxis");c=reportUtils.appendDateGrouping(a,c);for(var e=this.get("aggregates"),f=!1,g=0;g<b.length;g++){if(reportUtils.getAggregate(b[g],e)){f=!0;break}}return f?this.get("swapAxis")?this.parseAggregatesSwap(a,c,d,b):this.parseAggregates(a,c,d,b):this.parseGroups(a,c,d,b)},data:{data:[],title:"",xAxis:"",yAxis:"",swapAxis:!1,legend:"",svg:""}});var PieChartLegendManager=Ractive.extend({template:"#pieChartLegendTemplate",oninit:function(){var a=this,b=function(){for(var b=[],c=[],d=(a.get("groups"),a.get("aggregates")),e=a.get("fieldsByName"),f=0;f<d.length;f++){var g,h=e[d[f].selectedField].title,i=d[f].selectedField;for(g in aggregatesDefinitions)d[f].value[g]&&c.push({name:i+aggregatesDefinitions[g].namePostfix,title:h+" "+translated_labels[aggregatesDefinitions[g].label]})}c=_.uniq(c,function(a){return a.name}),a.set("availableAxis",c),a.set("availableGroups",a.get("getAvailableGroups")),a.set("availableLegends",b)};this.observe("groups",b),this.observe("aggregates",b),this.observe("xAxis",validateXAxis),this.observe("yAxis",function(a){ReportData.chartAxisY=a}),this.observe("y2Axis",function(a){ReportData.chartAxisY2=a}),this.observe("chartSize",function(a){ReportData.chartSize=a}),this.observe("showPercents",function(a){ReportData.chartShowPercents=a}),this.observe("decimalDigits",function(a){ReportData.chartDecimalDigits=a})},computed:{getAvailableGroups:function(){return reportUtils.getAvailableGroups(this.get("reportData"),this.get("groups"),this.get("fieldsByName"))}},data:{xAxis:ReportData.chartAxisX,yAxis:ReportData.chartAxisY,y2Axis:ReportData.chartAxisY2,chartTitle:ReportData.chartTitle,showPercents:ReportData.chartShowPercents,labelName:ReportData.chartLabels,groups:[],aggregates:[],chartSizes:ReportData.chartSizes,chartSize:ReportData.chartSize,availableAxis:[],availableGroups:[],availableLegends:[],chartDecimals:[],decimalDigits:0,chartColors:{}},components:{chartButtons:chartButtons,selectBox:selectBox}}),ReportPieChart={prepareData:function(a,b,c,d,e){var f=ReportData.chartAxisX,g=ReportData.chartAxisY,h=[];_.each(d,function(a){var b;for(b in aggregatesDefinitions)if(a.selectedField+aggregatesDefinitions[b].namePostfix==g){h.push(a);break}a.selectedField==g&&h.push(a)});var i=[];if(_.each(e,function(a){var b=a.name;a.dateGrouping&&(b+="_"+a.dateGrouping),b==f&&i.push(a)}),i=_.uniq(i,function(a){return a.name+"_"+a.dateGrouping}),ReportData.options.isCombined){var j=a.get("combinedSelectedFields.fields");for(moduleId in j)for(var k=j[moduleId],l=0;l<ReportData.availableFields.length;l++)for(var m=0;m<ReportData.availableFields[l].fields.length;m++)if(k==ReportData.availableFields[l].fields[m].name){var n=jQuery.extend(!0,{},ReportData.availableFields[l].fields[m]);n={name:k},n.sortAction="date_field"==ReportData.chartAxisX?"nogroup"!==ReportData.combinedSelectedFields.sortAction?ReportData.combinedSelectedFields.sortAction:"group":"nogroup",n.dateGrouping=ReportData.combinedSelectedFields.dateGrouping,n.sortDirection=ReportData.combinedSelectedFields.sortDirection,n.position=ReportData.combinedSelectedFields.position,i.unshift(n)}}return{filters:JSON.stringify(b),columns:JSON.stringify(c),options:JSON.stringify(ReportData.chartOptions),labels:JSON.stringify(ReportData.labels),aggregates:JSON.stringify(h),grouping:JSON.stringify(i),calcFields:JSON.stringify(ReportData.calcFields)}},init:function(a,b,c,d,e){loadChart("pie",this.prepareData(a,b,c,d,e),d,e)}},PieChartComponent=BaseChartComponent.extend({template:function(a){return a.isWidget?"<svg></svg>":"#chartViewTemplate"},oninit:function(){this.parentInit()},onrender:function(){var a=this,b=a.get("data"),c=a.get("title"),d=a.get("svg"),e=a.get("isWidget"),f=a.get("showPercents"),g=(this.get("options"),{top:10,right:10,bottom:10,left:10});!e&&a.get("margin")&&(g=a.get("margin"));var h=this.get("d3"),i=this.get("nv");i.addGraph(function(){var j=i.models.pieChart().x(function(a){return a.label}).y(function(a){return a.value}).margin(g).showLabels(!0).color(h.scale.category10().range());return j.pie.labelsOutside(!0).labelType("value").showPercents(f),j.pie.valueFormat(function(a){return chartView.get("numberFormat")(null,null,a)}),e||j.legend.margin({top:20,bottom:20}),h.select(d).datum(a.normalise(b)).transition().duration(350).call(j),e||h.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),i.utils.windowResize(j.update),a.chartUpdate(),a.get("drilldownEnabled")&&j.pie.dispatch.on("elementClick",h.contextMenu(getContextMenuElements(a.get("reportData")),function(){a.colorPickerCallback(a)})),a.chart=j,j})},updateData:function(){var a=this,b=a.get("data"),c=a.get("svg");a.set("chartColors",ReportData.chartColors),d3.select(c).datum(a.normalise(b)).transition().duration(350).call(a.chart)},normalise:function(a){var b=this,c=this.get("xAxis"),d=this.get("yAxis");c=reportUtils.appendDateGrouping(a,c);var e=[];return _.each(a.data,function(a){if(a[c]||a[d]){var f={label:a[c],value:parseFloat(a[d]),meta:b.parseMetaDrilldown([{fieldName:c,value:b.parseMetaValue(a,c),type:"legend"}])},g=b.get("chartColors");g&&g[a[c]]&&(f.color=g[a[c]]),e.push(f)}}),e},data:{data:[],title:"",xAxis:"",yAxis:"",chartColors:{},showPercents:!1}}),LineChartLegendManager=Ractive.extend({template:"#lineChartLegendTemplate",oninit:function(){var a=this,b=function(){for(var b=[],c=(a.get("groups"),a.get("aggregates")),d=a.get("fieldsByName"),e=0;e<c.length;e++){var f,g=d[c[e].selectedField].title,h=c[e].selectedField;for(f in aggregatesDefinitions)c[e].value[f]&&b.push({name:h+aggregatesDefinitions[f].namePostfix,title:g+" "+translated_labels[aggregatesDefinitions[f].label]})}b=_.uniq(b,function(a){return a.name});var i=[{key:translated_labels.label_groups,values:a.get("getAvailableGroups")},{key:translated_labels.label_aggregates,values:b}];b=[{key:translated_labels.label_aggregates,values:b}],a.set("availableAxis",b),a.set("availableGroups",a.get("getAvailableGroups")),a.set("availableLegends",i)};this.observe("groups",b,{init:!1}),this.observe("aggregates",b,{init:!1}),b(),this.observe("xAxis",validateXAxis,{init:!1}),this.observe("yAxis",function(b){1==b.length?a.set("legend",[this.get("xAxis")]):a.set("legend",b),ReportData.chartAxisY=b},{init:!1}),this.observe("xAxis",function(b){1==a.get("yAxis").length&&a.set("legend",[this.get("xAxis")])},{init:!1}),0==this.get("legend").length&&this.set("legend",[this.get("xAxis")]),this.observe("y2Axis",function(a){ReportData.chartAxisY2=a},{init:!1}),this.observe("legend",function(b){ReportData.chartLegend=b;for(var c=a.get("aggregates"),d=!1,e=0;e<b.length;e++)if(reportUtils.getAggregate(b[e],c)){d=!0;break}if(d){a.get("yAxis");a.merge("yAxis",b)}},{init:!1}),this.observe("chartSize",function(a){ReportData.chartSize=a}),this.observe("decimalDigits",function(a){ReportData.chartDecimalDigits=a})},computed:{getAvailableGroups:function(){return reportUtils.getAvailableGroups(this.get("reportData"),this.get("groups"),this.get("fieldsByName"))}},data:{xAxis:"",yAxis:[],y2Axis:[],chartTitle:"",legend:!1,availableLegends:[],labelName:"",groups:[],aggregates:[],availableAxis:[],availableGroups:[],chartSizes:[],chartSize:0,chartDecimals:[],decimalDigits:0},components:{chartButtons:chartButtons,selectBox:selectBox,multiSelectBox:multiSelectBox}}),ReportLineChart={parseDataItems:function(a,b,c,d,e){for(var f=0;f<a.length;f++){if("string"==typeof a[f]){var g=reportUtils.getAggregate(a[f],b),h=reportUtils.getGroup(a[f],c);g&&e.push(g),h&&d.push(h)}"object"==typeof a[f]&&this.parseDataItems(a[f],b,c,d,e)}},prepareData:function(a,b,c,d,e){var f=ReportData.chartAxisX,g=ReportData.chartAxisY,h=ReportData.chartLegend,i=[],j=[],k=[];if(k.push(f),k.push(g),k.push(h),this.parseDataItems(k,d,e,j,i),j=_.uniq(j,function(a){return a.name+"_"+a.dateGrouping}),ReportData.options.isCombined){var l=a.get("combinedSelectedFields.fields");for(moduleId in l)for(var m=l[moduleId],n=0;n<ReportData.availableFields.length;n++)for(var o=0;o<ReportData.availableFields[n].fields.length;o++)if(m==ReportData.availableFields[n].fields[o].name){var p=jQuery.extend(!0,{},ReportData.availableFields[n].fields[o]);p={name:m},p.sortAction=ReportData.combinedSelectedFields.sortAction,p.dateGrouping=ReportData.combinedSelectedFields.dateGrouping,p.sortDirection=ReportData.combinedSelectedFields.sortDirection,p.position=ReportData.combinedSelectedFields.position,j.unshift(p)}}for(var q=[],n=0;n<i.length;n++)q.indexOf(i[n].selectedField)>-1?(i.splice(n,1),n--):q.push(i[n].selectedField);return{filters:JSON.stringify(b),columns:JSON.stringify(c),options:JSON.stringify(ReportData.chartOptions),labels:JSON.stringify(ReportData.labels),aggregates:JSON.stringify(i),grouping:JSON.stringify(j),calcFields:JSON.stringify(ReportData.calcFields)}},init:function(a,b,c,d,e){loadChart("line",this.prepareData(a,b,c,d,e),d,e)}},LineChartComponent=BaseChartComponent.extend({template:function(a){return a.isWidget?"<svg></svg>":"#chartViewTemplate"},axisKeys:[],oninit:function(){this.parentInit()},onrender:function(){var a=this,b=a.get("data"),c=a.get("title"),d=a.get("svg"),e=this.get("xAxis"),f=a.get("isWidget"),g=this.get("getAvailableGroups"),h=this.get("options"),i={top:50,right:50,bottom:120,left:100};!f&&a.get("margin")&&(i=a.get("margin"));for(var j=this.get("d3"),k=this.get("nv"),l=0;l<g.length;l++)if(g[l].dateGrouping){var m=e+"_"+g[l].dateGrouping;if(m==g[l].name){e=m;break}}k.addGraph(function(){var l=k.models.lineChart().options({reduceXTicks:!1}).margin(i).useInteractiveGuideline(!1).showLegend(!0).color(j.scale.category10().range());e=jQuery.grep(g,function(a){return a.name==e}),h.isCombined&&"date_field"==a.get("xAxis")?e="Date":(e="",e[0]&&(e=e[0].title)),l.xAxis.axisLabel(e).tickFormat(function(b){return void 0!==a.axisKeys[b]?a.axisKeys[b]:""}),l.xAxis.rotateLabels(-30);var m=a.normalise(b);return a.bigValues&&l.yAxis.tickFormat(function(a){return chartView.get("numberFormat")(null,null,a)}),f||l.legend.margin({top:20,bottom:30}),l.forceY(0),j.select(d).datum(m).call(l),f||j.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),k.utils.windowResize(l.update),a.chartUpdate(),a.get("drilldownEnabled")&&l.lines.dispatch.on("elementClick",j.contextMenu(getContextMenuElements(a.get("reportData")),function(){a.colorPickerCallback(a)})),a.chart=l,l})},updateData:function(){var a=this,b=a.get("data"),c=a.get("svg");a.set("chartColors",ReportData.chartColors);var d=a.normalise(b);d3.select(c).datum(d).call(a.chart)},normalise:function(a){var b=this.get("legend"),c=this.get("xAxis"),d=this.get("yAxis"),e=this.get("aggregates");c=reportUtils.appendDateGrouping(a,c);for(var f=!1,g=0;g<b.length;g++){if(reportUtils.getAggregate(b[g],e)){f=!0;break}}return f?this.parseAggregates(a,c,d,b):(b=reportUtils.appendDateGrouping(a,b),this.parseGroups(a,c,d,b))},data:{data:[],title:"",xAxis:"",yAxis:""}}),CombinedChartLegendManager=Ractive.extend({template:"#combinedChartLegendTemplate",oninit:function(){var a=this;this.get("yAxis")instanceof String&&this.set("yAxis",[this.get("yAxis")]),this.get("yAxis2")instanceof String&&this.set("yAxis2",[this.get("yAxis2")]),this.get("legend")instanceof String&&this.set("legend",[this.get("legend")]);var b=function(){for(var b=[],c=[],d=[],e=[],f=a.get("groups"),g=a.get("aggregates"),h=a.get("legend"),i=a.get("fieldsByName"),j=0;j<h.length;j++)for(var k=0;k<f.length;k++)f[k].name==h[j]&&h.splice(j,1);for(var l=a.get("yAxis"),m=a.get("yAxis2"),n=l.length-1,o=m.length-1,j=0;j<g.length;j++){var p,q,r=i[g[j].selectedField].title,s=g[j].selectedField;for(q in aggregatesDefinitions)if(g[j].value[q]){var t=aggregatesDefinitions[q].namePostfix,u=translated_labels[aggregatesDefinitions[q].label];b.push({name:s+t,title:r+" "+u}),p=!0;for(var v=n;v>=0;v--)l[v]==s+t&&(p=!1);p&&d.push({name:s+t,title:r+" "+u}),p=!0;for(var v=o;v>=0;v--)m[v]==s+t&&(p=!1);p&&c.push({name:s+t,title:r+" "+u}),e.push({name:s+t,title:r+" "+u})}}b=_.uniq(b,function(a){return a.name}),c=_.uniq(c,function(a){return a.name}),d=_.uniq(d,function(a){return a.name}),w=e.length>0?e:b;var w=[{key:translated_labels.label_aggregates,values:w}],b=[{key:translated_labels.label_aggregates,values:b}],c=[{key:translated_labels.label_aggregates,values:c}],d=[{key:translated_labels.label_aggregates,values:d}],x=[{name:"line",title:translated_labels.label_line},{name:"bar",title:translated_labels.label_column}];a.set("availableAxis",b),a.set("availableAxis1",b),a.set("availableAxis2",b),a.set("availableGroups",a.get("getAvailableGroups")),a.set("availableLegends",w),a.set("availableTypes",x)};this.observe("groups",b,{init:!1}),this.observe("aggregates",b,{init:!1}),b(),this.observe("xAxis",validateXAxis),this.observe("yAxis",function(b){for(var c=a.get("yAxis2"),d=[],e=c.length-1,f=e;f>=0;f--)-1==jQuery.inArray(c[f],b)&&d.push(c[f]);a.set("legend",a.get("yAxis").concat(a.get("yAxis2"))),ReportData.chartAxisY=b},{init:!1}),this.observe("yAxis2",function(b){for(var c=a.get("yAxis"),d=[],e=c.length-1,f=e;f>=0;f--)-1==jQuery.inArray(c[f],b)&&d.push(c[f]);a.set("legend",a.get("yAxis").concat(a.get("yAxis2"))),ReportData.chartAxisY2=b},{init:!1}),this.observe("bars1Stacked",function(a){ReportData.chartBars1Stacked=a},{init:!1}),this.observe("bars2Stacked",function(a){ReportData.chartBars2Stacked=a},{init:!1}),this.observe("yAxisType",function(b){ReportData.chartYAxisType=b,"bar"!==b&&a.set("bars1Stacked",!1)},{init:!1}),this.observe("yAxis2Type",function(b){ReportData.chartYAxis2Type=b,"bar"!==b&&a.set("bars2Stacked",!1)},{init:!1}),this.observe("legend",function(a){ReportData.chartLegend=a},{init:!1}),this.observe("chartSize",function(a){ReportData.chartSize=a}),this.observe("decimalDigits",function(a){ReportData.chartDecimalDigits=a})},computed:{getAvailableGroups:function(){return reportUtils.getAvailableGroups(this.get("reportData"),this.get("groups"),this.get("fieldsByName"))}},data:{xAxis:ReportData.chartAxisX,yAxis:ReportData.chartAxisY,yAxis2:ReportData.chartAxisY2,chartTitle:ReportData.chartTitle,yAxisType:ReportData.chartYAxisType,yAxis2Type:ReportData.chartYAxis2Type,bars1Stacked:ReportData.chartBars1Stacked,bars2Stacked:ReportData.chartBars2Stacked,legend:ReportData.chartLegend,availableLegends:[],availableTypes:[],labelName:ReportData.chartLabels,groups:[],aggregates:[],availableAxis:[],availableGroups:[],chartSizes:ReportData.chartSizes,chartSize:ReportData.chartSize,availableAxis1:[],availableAxis2:[],chartDecimals:[],decimalDigits:0},components:{chartButtons:chartButtons,selectBox:selectBox,multiSelectBox:multiSelectBox}}),ReportCombinedChart={parseDataItems:function(a,b,c,d,e){for(var f=0;f<a.length;f++){if("string"==typeof a[f]){var g=reportUtils.getAggregate(a[f],b),h=reportUtils.getGroup(a[f],c);g&&e.push(g),h&&d.push(h)}"object"==typeof a[f]&&this.parseDataItems(a[f],b,c,d,e)}},prepareData:function(a,b,c,d,e){var f=ReportData.chartAxisX,g=ReportData.chartAxisY,h=ReportData.chartAxisY2,i=(ReportData.chartYAxisType,ReportData.chartYAxis2Type,ReportData.chartLegend),j=[],k=[],l=[];if(l.push(f),l.push(g),l.push(h),l.push(i),this.parseDataItems(l,d,e,k,j),k=_.uniq(k,function(a){return a.name+"_"+a.dateGrouping}),ReportData.options.isCombined){var m=a.get("combinedSelectedFields.fields");for(moduleId in m)for(var n=m[moduleId],o=0;o<ReportData.availableFields.length;o++)for(var p=0;p<ReportData.availableFields[o].fields.length;p++)if(n==ReportData.availableFields[o].fields[p].name){var q=jQuery.extend(!0,{},ReportData.availableFields[o].fields[p]);q={name:n},q.sortAction="date_field"==ReportData.chartAxisX?"nogroup"!==ReportData.combinedSelectedFields.sortAction?ReportData.combinedSelectedFields.sortAction:"group":"nogroup",q.dateGrouping=ReportData.combinedSelectedFields.dateGrouping,q.sortDirection=ReportData.combinedSelectedFields.sortDirection,q.position=ReportData.combinedSelectedFields.position,k.unshift(q)}}for(var r=[],o=0;o<j.length;o++)r.indexOf(j[o].selectedField)>-1?(j.splice(o,1),o--):r.push(j[o].selectedField);return{filters:JSON.stringify(b),columns:JSON.stringify(c),options:JSON.stringify(ReportData.chartOptions),labels:JSON.stringify(ReportData.labels),aggregates:JSON.stringify(j),grouping:JSON.stringify(k),calcFields:JSON.stringify(ReportData.calcFields)}},init:function(a,b,c,d,e){loadChart("combined",this.prepareData(a,b,c,d,e),d,e)}};CombinedChartComponent=BaseChartComponent.extend({template:function(a){return a.isWidget?"<svg></svg>":"#chartViewTemplate"},oninit:function(){this.parentInit()},onrender:function(){var a=this,b=a.get("data"),c=a.get("title"),d=a.get("svg"),e=a.get("isWidget"),f={top:50,right:50,bottom:120,left:70};!e&&a.get("margin")&&(f=a.get("margin"));var g=this.get("d3"),h=this.get("nv"),i=a.get("bars1Stacked"),j=a.get("bars2Stacked");h.addGraph(function(){var k=h.models.multiChart().options({reduceXTicks:!1}).margin(f).color(g.scale.category10().range()).bars1stacked(i).bars2stacked(j);k.tooltip.headerFormatter(function(b){return void 0!==a.axisKeys[b]?a.axisKeys[b]:""}),k.xAxis.tickFormat(function(b){return void 0!==a.axisKeys[b]?a.axisKeys[b]:""}),k.xAxis.rotateLabels(-30),a.bigValues&&(k.yAxis1.tickFormat(function(a){return chartView.get("numberFormat")(null,null,a)}),k.yAxis2.tickFormat(function(a){return chartView.get("numberFormat")(null,null,a)}));for(var l=a.normalise(b),m=0,n=0,o=0,p=0,q=0;q<l.length;q++)for(var r=l[q].yAxis,s=l[q].values,t=0;t<s.length;t++)1==r&&s[t].y>o&&(o=s[t].y),2==r&&s[t].y>p&&(p=s[t].y);return k.yDomain1([m,o]),k.yDomain2([n,p]),g.select(d).datum(l).call(k),e||g.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),h.utils.windowResize(k.update),a.get("drilldownEnabled")&&(k.bars1.dispatch.on("elementClick",g.contextMenu(getContextMenuElements(a.get("reportData")),function(){a.colorPickerCallback(a)})),k.bars2.dispatch.on("elementClick",g.contextMenu(getContextMenuElements(a.get("reportData")),function(){a.colorPickerCallback(a)})),k.lines1.dispatch.on("elementClick",g.contextMenu(getContextMenuElements(a.get("reportData")),function(){a.colorPickerCallback(a)})),k.lines2.dispatch.on("elementClick",g.contextMenu(getContextMenuElements(a.get("reportData")),function(){a.colorPickerCallback(a)}))),a.chart=k,k})},updateData:function(){var a=this,b=a.get("data"),c=a.get("svg");a.set("chartColors",ReportData.chartColors);var d=a.normalise(b);d3.select(c).datum(d).call(a.chart)},normalise:function(a){var b=this.get("legend"),c=this.get("xAxis"),d=this.get("yAxis"),e=this.get("yAxis2"),f=(this.get("aggregates"),this.get("yAxisType")),g=this.get("yAxis2Type"),h=this.get("chartColors");c=reportUtils.appendDateGrouping(a,c);for(var i=[],j=[],k=0;k<b.length;k++)i.push(b[k]);for(var l=0;l<a.data.length;l++)a.data[l][c]||(a.data[l][c]="-"),j.push(a.data[l][c]);i=reportUtils.unique(i),j=reportUtils.unique(j),this.axisKeys=j,"string"==typeof d&&(d=[d],this.set("yAxis",d)),"string"==typeof e&&(e=[e],this.set("yAxis2",e)),!f&&d.length>0&&(f="line",this.set("yAxisType",f)),!g&&e.length>0&&(g="line",this.set("yAxis2Type",g));var m=[];m.push({keys:d,type:f,position:1}),m.push({keys:e,type:g,position:2});for(var n=[],o=0,l=0;l<m.length;l++)for(var p=m[l].type,q=m[l].position,k=0;k<m[l].keys.length;k++){var r=m[l].keys[k];n[o]={key:r,type:p,yAxis:q,values:[]};for(var s=0;s<j.length;s++)n[o].values[s]={x:s,y:0};o++}for(var l=0;l<a.data.length;l++)for(var t=j.indexOf(a.data[l][c]),k=0;k<b.length;k++)for(var s=0;s<n.length;s++)if(n[s].key==b[k]){var u=parseFloat(a.data[l][b[k]]);u||(u=0),this.bigValues=!0,n[s].values[t].y=u,n[s].values[t].meta=this.parseMetaDrilldown([{fieldName:b[k],value:this.parseMetaValue(a.data[l],b[k]),type:"legend"},{fieldName:c,value:this.parseMetaValue(a.data[l],c),type:"xAxis"}])}for(var l=0;l<n.length;l++)n[l].key=a.cols[n[l].key],h&&(h[n[l].key]||h[n[l].key+" (right axis)"])&&(n[l].color=h[n[l].key]||h[n[l].key+" (right axis)"]);return n},data:{data:[],title:"",xAxis:"",yAxis:[],yAxis2:[],yAxisType:"",yAxis2Type:"",bars1Stacked:!1,bars2Stacked:!1,legend:[]}});var FunnelChartLegendManager=Ractive.extend({template:"#funnelChartLegendTemplate",oninit:function(){var a=this,b=function(){for(var b=[],c=(a.get("groups"),a.get("aggregates")),d=a.get("fieldsByName"),e=0;e<c.length;e++){var f,g=d[c[e].selectedField].title,h=c[e].selectedField;for(f in aggregatesDefinitions)c[e].value[f]&&b.push({name:h+aggregatesDefinitions[f].namePostfix,title:g+" "+translated_labels[aggregatesDefinitions[f].label]})}b=_.uniq(b,function(a){return a.name}),a.set("availableAxis",b),a.set("availableGroups",a.get("getAvailableGroups")),a.set("availableLegends",a.get("getAvailableGroups"))};this.observe("groups",b),this.observe("aggregates",b),this.observe("xAxis",validateXAxis),this.observe("xAxis",function(){a.loadSortingValues(ReportData.chartAxisX)}),this.observe("yAxis",function(a){ReportData.chartAxisY=a}),this.observe("y2Axis",function(a){ReportData.chartAxisY2=a}),this.observe("chartSize",function(a){ReportData.chartSize=a}),this.observe("showPercents",function(a){ReportData.chartShowPercents=a}),this.observe("sortableValues",function(a){ReportData.chartSortableValues=a}),this.observe("cumulated",function(a){ReportData.chartCumulated=a}),this.observe("decimalDigits",function(a){ReportData.chartDecimalDigits=a})},loadSortingValues:function(a){var b=this,c={fieldName:a};jQuery.post(ReportData.urlLoadPicklists,c,function(a){var c;try{c=JSON.parse(a)}catch(a){console.log("Error loading sorting values: "+a)}var d=[];c.length>0&&(d=b.mergeSortingValues(c)),b.set("sortableValues",d)})},mergeSortingValues:function(a){var b=this,c=[],d=b.get("sortableValues");d||(d=[]);for(var e=0;e<d.length;e++){for(var f=!1,g=0;g<a.length;g++)if(d[e].key==a[g].key){null==d[e].value&&(d[e].value=d[e].key),f=!0;break}f&&c.push(d[e])}for(var e=0;e<a.length;e++){for(var f=!1,g=0;g<c.length;g++)if(a[e].key==c[g].key){f=!0;break}f||c.push(a[e])}return c},computed:{getAvailableGroups:function(){return reportUtils.getAvailableGroups(this.get("reportData"),this.get("groups"),this.get("fieldsByName"))}},data:{xAxis:ReportData.chartAxisX,yAxis:ReportData.chartAxisY,y2Axis:ReportData.chartAxisY2,chartTitle:ReportData.chartTitle,cumulated:ReportData.chartCumulated,sortableValues:ReportData.chartSortableValues,showPercents:ReportData.chartShowPercents,labelName:ReportData.chartLabels,groups:[],aggregates:[],chartSizes:ReportData.chartSizes,chartSize:ReportData.chartSize,availableAxis:[],availableGroups:[],availableLegends:[],chartDecimals:[],decimalDigits:0},components:{chartButtons:chartButtons,selectBox:selectBox}}),ReportFunnelChart={prepareData:function(a,b,c,d,e){var f=ReportData.chartAxisX,g=ReportData.chartAxisY,h=[];_.each(d,function(a){var b;for(b in aggregatesDefinitions)if(a.selectedField+aggregatesDefinitions[b].namePostfix==g){h.push(a);break}a.selectedField==g&&h.push(a)});var i=[];if(_.each(e,function(a){var b=a.name;a.dateGrouping&&(b+="_"+a.dateGrouping),b==f&&i.push(a)}),i=_.uniq(i,function(a){return a.name+"_"+a.dateGrouping}),ReportData.options.isCombined){var j=a.get("combinedSelectedFields.fields");for(moduleId in j)for(var k=j[moduleId],l=0;l<ReportData.availableFields.length;l++)for(var m=0;m<ReportData.availableFields[l].fields.length;m++)if(k==ReportData.availableFields[l].fields[m].name){var n=jQuery.extend(!0,{},ReportData.availableFields[l].fields[m]);n={name:k},n.sortAction="date_field"==ReportData.chartAxisX?"nogroup"!==ReportData.combinedSelectedFields.sortAction?ReportData.combinedSelectedFields.sortAction:"group":"nogroup",n.dateGrouping=ReportData.combinedSelectedFields.dateGrouping,n.sortDirection=ReportData.combinedSelectedFields.sortDirection,n.position=ReportData.combinedSelectedFields.position,i.unshift(n)}}return{filters:JSON.stringify(b),columns:JSON.stringify(c),options:JSON.stringify(ReportData.chartOptions),labels:JSON.stringify(ReportData.labels),aggregates:JSON.stringify(h),grouping:JSON.stringify(i),calcFields:JSON.stringify(ReportData.calcFields)}},init:function(a,b,c,d,e){loadChart("funnel",this.prepareData(a,b,c,d,e),d,e)}},FunnelChartComponent=BaseChartComponent.extend({template:function(a){return a.isWidget?"<svg></svg>":"#chartViewTemplate"},oninit:function(){this.parentInit()},onrender:function(){function a(){jQuery(e).empty();var g=new D3Funnel(e);g.update=function(){a()};try{g.draw(b.normalise(c),k),jQuery(e+" text").attr("style","font-size:14px;fill: #fff !important")}catch(a){console.log(a)}return f||i.select(e).attr("class","nvd3-svg").append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(d),b.chart=g,g}var b=this,c=b.get("data"),d=b.get("title"),e=b.get("svg"),f=b.get("isWidget"),g=b.get("showPercents"),h=b.get("reportData");!f&&b.get("margin")&&b.get("margin");var i=this.get("d3"),j=b.getTotal(c.data,this.get("yAxis")),k={block:{dynamicHeight:!0,highlight:!0,fill:{type:"gradient"}},label:{format:function(a,c){return g&&(a+=" ("+b.getPercents(j,c).toFixed(2)+"%)"),a+": "+new NumberFormatter(jQuery.extend({},{numdec:h.chartDecimalDigits},h.numberFormat),null).makeFormatter()(null,null,c)}}};b.get("drilldownEnabled")&&(k.events={click:{block:function(a){var c=[{title:function(a){var c=b.get("xAxis"),d=a.label.raw,e=b.findByKeyValue(b.get("data").data,c,d),f=b.parseMetaDrilldown([{fieldName:c,value:b.parseMetaValue(e,c),type:"xAxis"}]),g=a.label.raw,i=a.fill.raw;return'<a href="'+(h.urlDrilldown+h.id)+"&drilldown="+encodeURI(JSON.stringify(f))+'" target="_blank">Drill-down to detailed data</a><input type="hidden" value="'+g+'" id="colorForField"><input type="hidden" value="'+i+'" id="drilldownpopup" />'},action:function(a,b,c){}}];i.contextMenu(c,function(){b.colorPickerCallback(b)}).call(this,a)}}}),f||(k.chart={margin:{left:0,right:0,top:30,bottom:0}}),a(),b.chartUpdate()},getTotal:function(a,b){for(var c=0,d=0;d<a.length;d++)a[d][b]&&(c+=parseFloat(a[d][b]));return c},getPercents:function(a,b){var c=0;return a>0&&b>0&&(c=b/a*100),c},updateData:function(){var a=that.get("reportData");this.set("chartColors",a.chartColors),this.chart.update()},normalise:function(a){for(var b=this.get("xAxis"),c=this.get("yAxis"),d=this.get("cumulated"),e=this.get("groups"),f=0;f<e.length;f++)e[f].name==b&&e[f].dateGrouping&&(b=b+"_"+e[f].dateGrouping);return d?this.normaliseCumulated(a,b,c):this.normaliseNonCumulated(a,b,c)},normaliseCumulated:function(a,b,c,d){var e=this,f=this.get("sortableValues"),g=[],h=[],i=e.get("chartColors");if(_.each(a.data,function(a){if(a[b]||a[c]){var d={key:a[b],val:parseFloat(a[c])};g.push(d)}}),0==f.length&&(g=g.sort(function(a,b){return a.val-b.val}),g=this.cumulateValues(g),g=g.sort(function(a,b){return b.val-a.val})),f.length>0){for(var j=[],k=0;k<f.length;k++)for(var l=f[k].value,m=0;m<g.length;m++)l==g[m].key&&j.push(g[m]);g=this.cumulateValues(j)}for(var k=0;k<g.length;k++){var n=g[k].key,o=g[k].val,p=[n,+o.toFixed(2)];i&&i[n]&&p.push(i[n]),h.push(p)}return h},cumulateValues:function(a){for(var b=0,c=!1,a=a.reverse(),d=0;d<a.length;d++){if(a[d].val>0)c=!0;else if(!c){a.splice(d,1);continue}c&&(a[d].val=a[d].val+b,b=a[d].val)}return a.reverse()},normaliseNonCumulated:function(a,b,c){var d=this,e=[],f=[],g=d.get("chartColors");_.each(a.data,function(a){if(a[b]||a[c]){var d=a[b],f=parseFloat(a[c]),g={key:d,val:f};e.push(g)}}),e=e.sort(function(a,b){return b.val-a.val});for(var e=e.reverse(),h=!1,i=0;i<e.length;i++)if(e[i].val>0)h=!0;else if(!h){e.splice(i,1);continue}for(var i=0;i<e.length;i++){var j=[e[i].key,+e[i].val.toFixed(2)];g&&g[key]&&j.push(g[key]),f.push(j)}return f.reverse()},data:{cumulated:!0,sortableValues:[],data:[],title:"",xAxis:"",yAxis:"",showPercents:!1}}),GaugeChartLegendManager=Ractive.extend({template:"#gaugeChartLegendTemplate",oninit:function(){var a=this,b=a.get("valueZones");b&&0!=b.length||a.addValueZone();var c=function(){for(var b=[],c=(a.get("groups"),a.get("aggregates")),d=a.get("fieldsByName"),e=0;e<c.length;e++){var f,g=d[c[e].selectedField].title,h=c[e].selectedField;for(f in aggregatesDefinitions)c[e].value[f]&&b.push({name:h+aggregatesDefinitions[f].namePostfix,title:g+" "+translated_labels[aggregatesDefinitions[f].label]})}b=_.uniq(b,function(a){return a.name}),a.set("availableAxis",b),a.set("availableGroups",a.get("getAvailableGroups")),a.set("availableLegends",a.get("getAvailableGroups"))};this.on("addValueZone",function(b){b.original.preventDefault(),a.addValueZone()}),this.on("removeValueZone",function(b,c){b.original.preventDefault(),a.removeValueZone(c)}),this.observe("groups",c),this.observe("aggregates",c),this.observe("yAxis",function(a){ReportData.chartAxisY=a}),this.observe("xAxis",function(b){ReportData.chartAxisX=b,a.loadGroupingSegments(ReportData.chartAxisX)}),this.observe("xAxisSegment",function(a){ReportData.chartAxisXSegment=a}),this.observe("valueZones",function(a){ReportData.chartValueZones=a}),this.observe("showLabels",function(a){ReportData.chartShowLabels=a}),this.observe("showZoneLabels",function(a){ReportData.chartShowZoneLabels=a}),this.observe("decimalDigits",function(a){ReportData.chartDecimalDigits=a})},loadGroupingSegments:function(a){"date"==a&&(a="date_field");var b=this,c=ReportData.url+ReportData.id+"&distinct="+a,d=b.getReportMainDataPreview();d=reportUtils.convertToJSONPost(d),jQuery.post(c,d,function(a){var c;try{c=JSON.parse(a)}catch(a){console.log("Error loading grouping segments: "+a)}var d=[];d.push({name:"",title:translated_labels.label_all}),c.length>0&&(d=jQuery.merge(d,c)),b.set("availableGroupSegments",d)})},addValueZone:function(){var a=this.get("valueZones");a||(a=[]);var b={clazz:"green-zone",from:0,to:100};a.push(b),this.set("valueZones",a)},removeValueZone:function(a){var b=this.get("valueZones");b.splice(a,1),this.set("valueZones",b)},computed:{getAvailableGroups:function(){return reportUtils.getAvailableGroups(this.get("reportData"),this.get("groups"),this.get("fieldsByName"))}},data:{xAxis:!1,yAxis:!1,y2Axis:!1,chartTitle:"",showPercents:!1,showLabels:ReportData.chartShowLabels,showZoneLabels:ReportData.chartShowZoneLabels,labelName:"",groups:[],aggregates:[],chartSizes:[],chartSize:!1,availableAxis:[],availableGroups:[],availableLegends:[],valueZones:[],availableValueZones:[{title:translated_labels.label_color_light_blue,name:"light-blue-zone"},{title:translated_labels.label_color_blue,name:"blue-zone"},{title:translated_labels.label_color_light_green,name:"light-green-zone"},{title:translated_labels.label_color_green,name:"green-zone"},{title:translated_labels.label_color_yellow,name:"yellow-zone"},{title:translated_labels.label_color_orange,name:"orange-zone"},{title:translated_labels.label_color_brown,name:"brown-zone"},{title:translated_labels.label_color_gray,name:"gray-zone"},{title:translated_labels.label_color_red,name:"red-zone"},{title:translated_labels.label_color_pink,name:"pink-zone"},{title:translated_labels.label_color_violet,name:"violet-zone"}],xAxisSegment:!1,chartDecimals:[],decimalDigits:0},components:{chartButtons:chartButtons,selectBox:selectBox}}),ReportGaugeChart={prepareData:function(a,b,c,d,e){var f=ReportData.chartAxisX,g=ReportData.chartAxisY,h=[];_.each(d,function(a){var b;for(b in aggregatesDefinitions)if(a.selectedField+aggregatesDefinitions[b].namePostfix==g){h.push(a);break}a.selectedField==g&&h.push(a)});var i=[];if(_.each(e,function(a){var b=a.name;a.dateGrouping&&(b+="_"+a.dateGrouping),b==f&&i.push(a)}),i=_.uniq(i,function(a){return a.name+"_"+a.dateGrouping}),ReportData.options.isCombined){var j=a.get("combinedSelectedFields.fields");for(moduleId in j)for(var k=j[moduleId],l=0;l<ReportData.availableFields.length;l++)for(var m=0;m<ReportData.availableFields[l].fields.length;m++)if(k==ReportData.availableFields[l].fields[m].name){var n=jQuery.extend(!0,{},ReportData.availableFields[l].fields[m]);n={name:k},n.sortAction="date_field"==ReportData.chartAxisX?"nogroup"!==ReportData.combinedSelectedFields.sortAction?ReportData.combinedSelectedFields.sortAction:"group":"nogroup",n.dateGrouping=ReportData.combinedSelectedFields.dateGrouping,n.sortDirection=ReportData.combinedSelectedFields.sortDirection,n.position=ReportData.combinedSelectedFields.position,i.unshift(n)}}var o={filters:b,columns:c,options:ReportData.chartOptions,labels:ReportData.labels,aggregates:d,grouping:i,calcFields:ReportData.calcFields};return ReportData.options.isCombined&&(o.combinedSelectedFields=a.get("combinedSelectedFields.fields")),o=reportUtils.convertToJSONPost(o)},init:function(a,b,c,d,e){loadChart("gauge",this.prepareData(a,b,c,d,e),d,e)}},GaugeChartComponent=BaseChartComponent.extend({template:function(a){return a.isWidget?"<svg></svg>":"#chartViewTemplate"},oninit:function(){this.parentInit()},onrender:function(){function a(){var g=jQuery(b.get("svg")).height();k.margin&&(g=g-k.margin.top-k.margin.bottom),k.size=g,jQuery(e).empty();var h=new D3Gauge(e,k);return h.update=function(){a()},h.write(b.normalise(c)),f||j.select(e).attr("class","nvd3-svg").append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(d),b.chart=h,h}var b=this,c=b.get("data"),d=b.get("title"),e=b.get("svg"),f=b.get("isWidget"),g=b.get("valueZones"),h=b.get("showLabels"),i=b.get("showZoneLabels");!f&&b.get("margin")&&b.get("margin");var j=this.get("d3"),k={min:b.getValueZonesMin(),max:b.getValueZonesMax(),transitionDuration:900,label:"",minorTicks:5,majorTicks:10,needleWidthRatio:.6,needleContainerRadiusRatio:.7,clazz:"small",zones:g,showLabels:h,showZoneLabels:i};f||(k.margin={left:100,right:0,top:30,bottom:0}),a(),b.chartUpdate()},getValueZonesMin:function(){for(var a=this.get("valueZones"),b=0,c=0;c<a.length;c++)a[c].from<b&&(b=parseFloat(a[c].from));return b},getValueZonesMax:function(){for(var a=this.get("data"),b=this.get("valueZones"),c=0,d=0;d<b.length;d++)b[d].to>c&&(c=parseFloat(b[d].to));var e=this.normalise(a);return e>c?e:c},normalise:function(a){var b=this.get("xAxis"),c=this.get("xAxisSegment"),d=this.get("yAxis");b=reportUtils.appendDateGrouping(a,b);var e=0;return _.each(a.data,function(a){if(c){if(a[b]&&a[b]==c){var f=parseFloat(a[d]);f&&(e+=f)}}else{var f=parseFloat(a[d]);f&&(e+=f)}}),e||(e=0),e},data:{data:[],title:"",xAxis:"",yAxis:"",showPercents:!1,valueZones:[],xAxisSegment:!1,showLabels:!1,showZoneLabels:!1}}),MapChartLegendManager=Ractive.extend({template:"#mapChartLegendTemplate",oninit:function(){var a=this,b=function(){for(var b=[],c=[],d=(a.get("groups"),a.get("aggregates")),e=a.get("fieldsByName"),f=0;f<d.length;f++){var g,h=e[d[f].selectedField].title,i=d[f].selectedField;for(g in aggregatesDefinitions)d[f].value[g]&&c.push({name:i+aggregatesDefinitions[g].namePostfix,title:h+" "+translated_labels[aggregatesDefinitions[g].label]})}c=_.uniq(c,function(a){return a.name}),a.set("availableAxis",c),a.set("availableGroups",a.get("getAvailableGroups")),a.set("availableLegends",b)};this.observe("groups",b),this.observe("aggregates",b),this.observe("xAxis",validateXAxis),this.observe("yAxis",function(a){ReportData.chartAxisY=a}),this.observe("country",function(a){ReportData.country=a}),this.observe("state",function(a){ReportData.state=a}),this.observe("mapType",function(a){ReportData.mapType=a}),this.observe("marker",function(a){ReportData.marker=a}),this.observe("markerAxisX",function(a){ReportData.markerAxisX=a}),this.observe("markerAxisY",function(a){ReportData.markerAxisY=a})},computed:{getAvailableGroups:function(){return reportUtils.getAvailableGroups(this.get("reportData"),this.get("groups"),this.get("fieldsByName"))}},data:{xAxis:ReportData.chartAxisX,yAxis:ReportData.chartAxisY,y2Axis:ReportData.chartAxisY2,chartTitle:ReportData.chartTitle,showPercents:ReportData.chartShowPercents,labelName:ReportData.chartLabels,groups:[],aggregates:[],chartSizes:ReportData.chartSizes,chartSize:ReportData.chartSize,availableAxis:[],availableGroups:[],availableLegends:[],chartDecimals:[],decimalDigits:0,mapType:"country",country:!1,availableMaps:[{name:"country",title:translated_labels.label_country},{name:"state",title:translated_labels.label_state},{name:"city",title:translated_labels.label_city}],marker:!1,markerAxisX:!1,markerAxisY:!1},components:{chartButtons:chartButtons,selectBox:selectBox}}),ReportMapChart={parseDataItems:function(a,b,c,d,e){for(var f=0;f<a.length;f++){if("string"==typeof a[f]){var g=reportUtils.getAggregate(a[f],b),h=reportUtils.getGroup(a[f],c);g&&e.push(g),h&&d.push(h)}"object"==typeof a[f]&&this.parseDataItems(a[f],b,c,d,e)}},prepareData:function(a,b,c,d,e){var f=ReportData.country,g=ReportData.state,h=ReportData.chartAxisX,i=ReportData.chartAxisY,j=(ReportData.chartYAxisType,ReportData.chartYAxis2Type,ReportData.chartLegend),k=[],l=[],m=[];if(m.push(f),m.push(g),m.push(h),m.push(i),m.push(j),ReportData.marker&&(m.push(ReportData.markerAxisX),m.push(ReportData.markerAxisY)),this.parseDataItems(m,d,e,l,k),l=_.uniq(l,function(a){return a.name+"_"+a.dateGrouping}),ReportData.options.isCombined){var n=a.get("combinedSelectedFields.fields");for(moduleId in n)for(var o=n[moduleId],p=0;p<ReportData.availableFields.length;p++)for(var q=0;q<ReportData.availableFields[p].fields.length;q++)if(o==ReportData.availableFields[p].fields[q].name){var r=jQuery.extend(!0,{},ReportData.availableFields[p].fields[q]);r={name:o},r.sortAction="date_field"==ReportData.chartAxisX?"nogroup"!==ReportData.combinedSelectedFields.sortAction?ReportData.combinedSelectedFields.sortAction:"group":"nogroup",r.dateGrouping=ReportData.combinedSelectedFields.dateGrouping,r.sortDirection=ReportData.combinedSelectedFields.sortDirection,r.position=ReportData.combinedSelectedFields.position,l.unshift(r)}}for(var s=[],p=0;p<k.length;p++)s.indexOf(k[p].selectedField)>-1?(k.splice(p,1),p--):s.push(k[p].selectedField);return{filters:JSON.stringify(b),columns:JSON.stringify(c),options:JSON.stringify(ReportData.chartOptions),labels:JSON.stringify(ReportData.labels),aggregates:JSON.stringify(k),grouping:JSON.stringify(l),calcFields:JSON.stringify(ReportData.calcFields)}},init:function(a,b,c,d,e){loadChart("map",this.prepareData(a,b,c,d,e),d,e)}};MapChartComponent=BaseChartComponent.extend({template:function(a){return a.isWidget?'<div id="{{elementId}}" style="height:100%;"></div>':"#chartViewTemplate"},oninit:function(){this.parentInit(),this.set("elementId","id_"+reportUtils.uniqueId())},onrender:function(){var a=this,b=(a.get("title"),a.get("isWidget")),c="choropleth";b&&(c=this.get("elementId"));var d=L.map(c).setView([a.get("lat"),a.get("lng")],a.get("zoom")),e=new L.LatLng(85,-180),f=new L.LatLng(-85,180),g=new L.LatLngBounds(e,f);d.setMaxBounds(g),(new L.Control.Legend).addTo(d),L.tileLayer.provider("Stamen.TonerLite",{minZoom:2}).addTo(d);var h=this.normalise(this.get("data"),this.get("country"),this.get("state"),this.get("xAxis"),this.get("yAxis"),this.get("markerAxisX"),this.get("markerAxisY")),i=this.getOptions(),j=this.getData(h,i);if(new L.ChoroplethDataLayer(j,i).addTo(d),this.get("marker")){var k=this.getMarkerLayer(j,i);d.addLayer(k)}d.on("zoomend",function(a){b||(ReportData.zoom=d.getZoom())}),d.on("dragend",function(a){if(!b){var c=d.getCenter();ReportData.lat=c.lat,ReportData.lng=c.lng}}),b||jQuery(window).on("exportImage",function(a,b){b&&(b=jQuery(b),b.data("initialText",b.text()),b.text("Loading..."));var c=[];leafletImage(d,function(a,d){c.push(d.toDataURL());var e=jQuery("svg")[0],f=jQuery(".leaflet-map-pane").css("transform"),g=parseInt(f.split(",")[4]),h=parseInt(f.split(",")[5]);saveSvgAsPng(e,"chart.png",1,function(a){c.push(a);try{jQuery.post("index.php?entryPoint=combineMapTiles",{sources:c},function(a){window.location="index.php?entryPoint=analyticReportBouncer&img="+a+"&nobase=true"})}catch(a){console.log(a),alery("There was problems with generating map chart image on server.")}finally{b&&b.text(b.data("initialText"))}},g,h)})}),a.chart={update:function(){d.invalidateSize()}}},getChartOptions:function(a,b){var c={};for(key in a)for(chartKey in a[key].data){var d="data."+chartKey;c[d]={displayName:chartKey,fillColor:null}}var e=0;for(option in c){var f=this.get("chartColors"),g=f[e];c[option].fillColor=g,e++}return c},getMarkerLayer:function(a,b){var c={chartOptions:{},layerOptions:{fillOpacity:1,opacity:1,weight:1,radius:15,barThickness:10,gradient:!0},legendOptions:{title:"Chart legend"}},d=this.getChartOptions(a,b);c.chartOptions=d;var e=jQuery.extend(!0,b,c);return new L.PieChartDataLayer(a,e)},getData:function(a,b){for(var c={},d=0;d<a.length;d++){var e=a[d].key,f=a[d].val,g=a[d].title,h={};a[d].data&&(h=a[d].data),c[e]={name:e,val:f,title:g,data:h},c[e][b.codeField]=e}return c},colorize:function(a,b,c){return new L.CustomColorFunction(a,b,c,{interpolate:!0})},getLocationMode:function(){var a;switch(this.get("mapType")){case"state":for(state in LSTATES)L.states=jQuery.extend({},L.states,LSTATES[state]);var b=L.GeometryUtils.loadCentroids(L.states);L.stateCentroids=jQuery.extend({},L.stateCentroids,b),a=L.LocationModes.STATE;break;case"city":a=L.LocationModes.LOOKUP;break;case"country":default:a=L.LocationModes.COUNTRY}return a},getOptions:function(a){var b=this,c=this.get("yAxis"),d=this.get("aggregates"),e=this.get("labels"),f={recordsField:null,locationMode:this.getLocationMode(),codeField:"abbr",displayOptions:{},layerOptions:{fillOpacity:.8,opacity:1,weight:1,stroke:!1},tooltipOptions:{iconSize:new L.Point(100,70),iconAnchor:new L.Point(-5,55)},getIndexKey:function(a,b){return a.text}},g={};switch(this.get("mapType")){case"city":var h={type:"FeatureCollection",features:[]};for(country in LCITIES)jQuery.merge(h.features,LCITIES[country].features);var g=jQuery.extend({},g,{locationLookup:h,locationIndexField:"id",locationTextField:"title"})}f=jQuery.extend(f,g);var i=reportUtils.getAggregate(c,d),j=e[c]?e[c]:i.title,k=this.get("marker")?this.get("colors"):this.get("heatcolors");return f.displayOptions.val={displayName:j,fillColor:b.colorize(this.min,this.max,k)},f},getKeyPath:function(a,b,c,d){var e="";switch(this.get("mapType")){case"state":var f=this.getCountryCode(a[b]);e=f+"."+this.getStateCode(f,a[d]);break;case"city":var g=["GB","FR","AT","BE","DK","IE","IT","NL","SE","PL","ES","MX","IS","NO","CH","GR","CZ","IN","CN","LV","EE","LT"],f=this.getCountryCode(a[b]);return e=f,-1==jQuery.inArray(f,g)&&(e+="."+this.getStateCode(f,a[c])),a[d]&&(e+="."+a[d].replace(/[. ]/g,"")),e;case"country":default:e=this.getCountryCode(a[d])}return e},_normalise:function(a,b,c,d,e,f,g){for(var h={},i=[],j={},k=0;k<a.data.length;k++){var l=a.data[k][d],m=this.getKeyPath(a.data[k],b,c,d);j[m]=l;var n=a.data[k][e];i[m]=l,f&&g&&a.data[k][f]!=g||m&&(n=parseFloat(n)||0,h[m]=h[m]||0,h[m]+=n)}var o=[];for(m in h){var p={};p.keyPath=m,p.key=j[p.keyPath],p.title=i[p.keyPath],p.value=h[m],o.push(p)}return o},_normaliseMarkers:function(a,b,c,d,e,f,g){for(var h={},i=0;i<a.data.length;i++){var j=a.data[i][d],k=a.data[i][e];f&&g&&a.data[i][f]!=g||j&&(k=parseFloat(k)||0,h[j]=h[j]||0,h[j]+=k)}return h},normalise:function(a,b,c,d,e,f,g){b=reportUtils.appendDateGrouping(a,b),c=reportUtils.appendDateGrouping(a,c),d=reportUtils.appendDateGrouping(a,d);var h=this._normalise(a,b,c,d,e);this.max=0,this.min=0;for(var i=[],j=0;j<h.length;j++){h[j].value>this.max&&(this.max=h[j].value),h[j].value<this.min&&(this.min=h[j].value);var k=this._normaliseMarkers(a,b,c,f,g,d,h[j].key),l={key:h[j].keyPath,val:h[j].value,title:h[j].title,data:k};i.push(l)}return i},getCountryNameSynonym:function(a){var b=[{key:"Russia",value:"Russian Federation"},{key:"England",value:"United Kingdom"},{key:"USA",value:"United States"},{key:"US",value:"United States"},{key:"UAE",value:"United Arab Emirates"},{key:"RSA",value:"South Africa"}],c=b.filter(function(b){return b.key==a})[0];return!!c&&c.value},getCountryCode:function(a){if(!a)return!1;if(a.length>2&&L.fullLookup){var b=reportUtils.toTitleCase(a);a.length<=3&&(b=b.toUpperCase());var c=this.getCountryNameSynonym(b);c&&(b=c);var d=reportUtils.findKey(L.fullLookup,b);d&&(a=d)}return a},getStateCode:function(a,b){if(!a||!b)return!1;if(b.length>2&&L.stateAlpha2Lookup&&L.stateAlpha2Lookup[a]){var c=reportUtils.findKey(L.stateAlpha2Lookup[a],b);c&&(b=c)}return b},data:{data:[],title:"",xAxis:"",yAxis:[],yAxis2:[],yAxisType:"",yAxis2Type:"",bars1Stacked:!1,bars2Stacked:!1,legend:[],mapType:"country",zoom:2,lat:0,lng:0,heatcolors:["#2e539c","#8aed4a","#f2e51a","#f41e36"],colors:["#d3e0ba","#bdd097","#a7c074","#91b152","#7ba12f"],chartColors:["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928"]}});var AreaChartLegendManager=Ractive.extend({template:"#areaChartLegendTemplate",oninit:function(){var a=this,b=function(){for(var b=[],c=(a.get("groups"),a.get("aggregates")),d=a.get("fieldsByName"),e=0;e<c.length;e++){var f,g=d[c[e].selectedField].title,h=c[e].selectedField;for(f in aggregatesDefinitions)c[e].value[f]&&b.push({name:h+aggregatesDefinitions[f].namePostfix,title:g+" "+translated_labels[aggregatesDefinitions[f].label]})}b=_.uniq(b,function(a){return a.name});var i=[{key:translated_labels.label_groups,values:a.get("getAvailableGroups")},{key:translated_labels.label_aggregates,values:b}];b=[{key:translated_labels.label_aggregates,values:b}],a.set("availableAxis",b),a.set("availableGroups",a.get("getAvailableGroups")),a.set("availableLegends",i)};this.observe("groups",b,{init:!1}),this.observe("aggregates",b,{init:!1}),b(),this.observe("xAxis",validateXAxis),this.observe("yAxis",function(b){1==b.length?a.set("legend",[this.get("xAxis")]):a.set("legend",b),ReportData.chartAxisY=b},{init:!1}),this.observe("xAxis",function(b){1==a.get("yAxis").length&&a.set("legend",[this.get("xAxis")])},{init:!1}),0==this.get("legend").length&&this.set("legend",[this.get("xAxis")]),this.observe("y2Axis",function(a){ReportData.chartAxisY2=a},{init:!1}),this.observe("legend",function(b){ReportData.chartLegend=b;for(var c=a.get("aggregates"),d=!1,e=0;e<b.length;e++)if(reportUtils.getAggregate(b[e],c)){d=!0;break}if(d){a.get("yAxis");a.merge("yAxis",b)}},{init:!1}),this.observe("legend",function(b){a.loadSortingValues(b[0])}),this.observe("chartSize",function(a){ReportData.chartSize=a}),this.observe("sortableValues",function(a){ReportData.chartSortableValues=a}),this.observe("decimalDigits",function(a){ReportData.chartDecimalDigits=a})},loadSortingValues:function(a){var b=this,c={fieldName:a};jQuery.post(ReportData.urlLoadPicklists,c,function(a){var c;try{c=JSON.parse(a)}catch(a){console.log("Error loading sorting values: "+a)}var d=[];c.length>0&&(d=b.mergeSortingValues(c)),b.set("sortableValues",d)})},mergeSortingValues:function(a){var b=this,c=[],d=b.get("sortableValues");d||(d=[]);for(var e=0;e<d.length;e++){for(var f=!1,g=0;g<a.length;g++)if(d[e].key==a[g].key){f=!0;break}f&&c.push(d[e])}for(var e=0;e<a.length;e++){for(var f=!1,g=0;g<c.length;g++)if(a[e].key==c[g].key){f=!0;break}f||c.push(a[e])}return c},computed:{getAvailableGroups:function(){return reportUtils.getAvailableGroups(this.get("reportData"),this.get("groups"),this.get("fieldsByName"))}},data:{xAxis:"",yAxis:[],y2Axis:[],chartTitle:"",sortableValues:[],legend:!1,availableLegends:[],labelName:"",groups:[],aggregates:[],availableAxis:[],availableGroups:[],chartSizes:[],chartSize:0,chartDecimals:[],decimalDigits:0},components:{chartButtons:chartButtons,selectBox:selectBox,multiSelectBox:multiSelectBox}}),ReportAreaChart={parseDataItems:function(a,b,c,d,e){for(var f=0;f<a.length;f++){if("string"==typeof a[f]){var g=reportUtils.getAggregate(a[f],b),h=reportUtils.getGroup(a[f],c);g&&e.push(g),h&&d.push(h)}"object"==typeof a[f]&&this.parseDataItems(a[f],b,c,d,e)}},prepareData:function(a,b,c,d,e){var f=ReportData.chartAxisX,g=ReportData.chartAxisY,h=ReportData.chartLegend,i=[],j=[],k=[];if(k.push(f),k.push(g),k.push(h),this.parseDataItems(k,d,e,j,i),j=_.uniq(j,function(a){return a.name+"_"+a.dateGrouping}),ReportData.options.isCombined){var l=a.get("combinedSelectedFields.fields");for(moduleId in l)for(var m=l[moduleId],n=0;n<ReportData.availableFields.length;n++)for(var o=0;o<ReportData.availableFields[n].fields.length;o++)if(m==ReportData.availableFields[n].fields[o].name){var p=jQuery.extend(!0,{},ReportData.availableFields[n].fields[o]);p={name:m},p.sortAction=ReportData.combinedSelectedFields.sortAction,p.dateGrouping=ReportData.combinedSelectedFields.dateGrouping,p.sortDirection=ReportData.combinedSelectedFields.sortDirection,p.position=ReportData.combinedSelectedFields.position,j.unshift(p)}}for(var q=[],n=0;n<i.length;n++)q.indexOf(i[n].selectedField)>-1?(i.splice(n,1),n--):q.push(i[n].selectedField);return{filters:JSON.stringify(b),columns:JSON.stringify(c),options:JSON.stringify(ReportData.chartOptions),labels:JSON.stringify(ReportData.labels),aggregates:JSON.stringify(i),grouping:JSON.stringify(j),calcFields:JSON.stringify(ReportData.calcFields)}},init:function(a,b,c,d,e){loadChart("area",this.prepareData(a,b,c,d,e),d,e)}},AreaChartComponent=BaseChartComponent.extend({template:function(a){return a.isWidget?"<svg></svg>":"#chartViewTemplate"},axisKeys:[],oninit:function(){this.parentInit()},onrender:function(){var a=this,b=a.get("data"),c=a.get("title"),d=a.get("svg"),e=this.get("xAxis"),f=a.get("isWidget"),g=this.get("getAvailableGroups"),h=this.get("options"),i={top:50,right:50,bottom:120,left:100};!f&&a.get("margin")&&(i=a.get("margin"));for(var j=this.get("d3"),k=this.get("nv"),l=0;l<g.length;l++)if(g[l].dateGrouping){var m=e+"_"+g[l].dateGrouping;if(m==g[l].name){e=m;break}}k.addGraph(function(){var l=k.models.stackedAreaChart().options({reduceXTicks:!1}).margin(i).useInteractiveGuideline(!1).showLegend(!0).showControls(!0).color(j.scale.category10().range()).x(function(a){return a[0]}).y(function(a){return a[1]});e=jQuery.grep(g,function(a){return a.name==e}),h.isCombined&&"date_field"==a.get("xAxis")?e="Date":(e="",e[0]&&(e=e[0].title)),l.xAxis.axisLabel(e).tickFormat(function(b){return void 0!==a.axisKeys[b]?a.axisKeys[b]:""}),l.xAxis.rotateLabels(-30),a.bigValues,f||(l.legend.margin({top:20,bottom:30}),l.controls.margin({top:20,bottom:30})),l.forceY(0);var m=a.normalise(b);return j.select(d).datum(m).call(l),f||j.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),k.utils.windowResize(l.update),a.get("drilldownEnabled")&&l.stacked.dispatch.on("elementClick",j.contextMenu(getContextMenuElements(a.get("reportData")),function(){a.colorPickerCallback(a)})),a.chart=l,l})},updateData:function(){var a=this,b=a.get("data"),c=a.get("svg");a.set("chartColors",ReportData.chartColors);var d=a.normalise(b);console.log(d),d3.select(c).datum(d).call(a.chart)},normalise:function(a){var b=this.get("legend"),c=this.get("xAxis"),d=this.get("yAxis"),e=this.get("aggregates"),f=this.get("sortableValues");c=reportUtils.appendDateGrouping(a,c);for(var g=!1,h=0;h<b.length;h++){if(reportUtils.getAggregate(b[h],e)){g=!0;break}}var i=[];if(g?i=this.parseAggregates(a,c,d,b):(b=reportUtils.appendDateGrouping(a,b),i=this.parseGroups(a,c,d,b)),i=i.map(function(a){return a.values=a.values.map(function(a,b){return[a.x,a.y,a.meta]}),a}),f.length>0){for(var j=[],h=0;h<f.length;h++)for(var k=f[h].key,l=0;l<i.length;l++)k==i[l].key&&j.push(i[l]);i=j}return i},data:{data:[],sortableValues:[],title:"",xAxis:"",yAxis:""}}),HorizontalBarChartLegendManager=Ractive.extend({template:"#horizontalBarChartLegendTemplate",oninit:function(){var a=this;this.get("yAxis")instanceof String&&this.set("yAxis",[this.get("yAxis")]),this.get("legend")instanceof String&&this.set("legend",[this.get("legend")]);var b=function(){for(var b=[],c=(a.get("groups"),a.get("aggregates")),d=a.get("fieldsByName"),e=0;e<c.length;e++){var f,g=d[c[e].selectedField].title,h=c[e].selectedField;for(f in aggregatesDefinitions)c[e].value[f]&&b.push({name:h+aggregatesDefinitions[f].namePostfix,title:g+" "+translated_labels[aggregatesDefinitions[f].label]})}b=_.uniq(b,function(a){return a.name});var i=[{key:translated_labels.label_groups,values:a.get("getAvailableGroups")},{key:translated_labels.label_aggregates,values:b}],b=[{key:translated_labels.label_aggregates,values:b}];a.set("availableAxis",b),a.set("availableGroups",a.get("getAvailableGroups")),a.set("availableLegends",i)};this.observe("groups",b),this.observe("aggregates",b,{init:!1}),this.observe("xAxis",validateXAxis,{init:!1}),this.observe("yAxis",function(b){1==b.length?a.set("legend",[this.get("xAxis")]):a.set("legend",b),ReportData.chartAxisY=b},{init:!1}),this.observe("xAxis",function(b){1==a.get("yAxis").length&&a.set("legend",[this.get("xAxis")])},{init:!1}),this.observe("y2Axis",function(a){ReportData.chartAxisY2=a},{init:!1}),0==this.get("legend").length&&this.set("legend",[this.get("xAxis")]),this.observe("legend",function(b){ReportData.chartLegend=b;for(var c=a.get("aggregates"),d=!1,e=0;e<b.length;e++)if(reportUtils.getAggregate(b[e],c)){d=!0;break}d&&a.set("yAxis",b)}),this.observe("chartSize",function(a){ReportData.chartSize=a}),this.observe("decimalDigits",function(a){ReportData.chartDecimalDigits=a})},computed:{getAvailableGroups:function(){return reportUtils.getAvailableGroups(this.get("reportData"),this.get("groups"),this.get("fieldsByName"))}},data:{xAxis:ReportData.chartAxisX,yAxis:ReportData.chartAxisY,y2Axis:ReportData.chartAxisY2,chartTitle:ReportData.chartTitle,legend:ReportData.chartLegend,availableLegends:[],labelName:ReportData.chartLabels,groups:[],aggregates:[],availableAxis:[],availableGroups:[],chartSizes:ReportData.chartSizes,chartSize:ReportData.chartSize,chartDecimals:[],decimalDigits:0},components:{chartButtons:chartButtons,selectBox:selectBox,multiSelectBox:multiSelectBox}}),ReportHorizontalBarChart={parseDataItems:function(a,b,c,d,e){for(var f=0;f<a.length;f++){if("string"==typeof a[f]){var g=reportUtils.getAggregate(a[f],b),h=reportUtils.getGroup(a[f],c);g&&e.push(g),h&&d.push(h)}"object"==typeof a[f]&&this.parseDataItems(a[f],b,c,d,e)}},prepareData:function(a,b,c,d,e){var f=ReportData.chartAxisX,g=ReportData.chartAxisY,h=ReportData.chartLegend,i=[],j=[],k=[];if(k.push(f),k.push(g),k.push(h),this.parseDataItems(k,d,e,j,i),j=_.uniq(j,function(a){return a.name+"_"+a.dateGrouping}),ReportData.options.isCombined){var l=a.get("combinedSelectedFields.fields");for(moduleId in l)for(var m=l[moduleId],n=0;n<ReportData.availableFields.length;n++)for(var o=0;o<ReportData.availableFields[n].fields.length;o++)if(m==ReportData.availableFields[n].fields[o].name){var p=jQuery.extend(!0,{},ReportData.availableFields[n].fields[o]);p={name:m},p.sortAction="date_field"==ReportData.chartAxisX?"nogroup"!==ReportData.combinedSelectedFields.sortAction?ReportData.combinedSelectedFields.sortAction:"group":"nogroup",p.dateGrouping=ReportData.combinedSelectedFields.dateGrouping,p.sortDirection=ReportData.combinedSelectedFields.sortDirection,p.position=ReportData.combinedSelectedFields.position,j.unshift(p)}}for(var q=[],n=0;n<i.length;n++)q.indexOf(i[n].selectedField)>-1?(i.splice(n,1),n--):q.push(i[n].selectedField);return{filters:JSON.stringify(b),columns:JSON.stringify(c),options:JSON.stringify(ReportData.chartOptions),labels:JSON.stringify(ReportData.labels),aggregates:JSON.stringify(i),grouping:JSON.stringify(j),calcFields:JSON.stringify(ReportData.calcFields)}},init:function(a,b,c,d,e){loadChart("hbar",this.prepareData(a,b,c,d,e),d,e)}};HorizontalBarChartComponent=BaseChartComponent.extend({template:function(a){return a.isWidget?"<svg></svg>":"#chartViewTemplate"},oninit:function(){this.parentInit()},onrender:function(){var a=this,b=a.get("data"),c=a.get("title"),d=a.get("svg"),e=a.get("isWidget"),f=a.get("stacked"),g={top:50,right:150,bottom:120,left:70};!e&&a.get("margin")&&(g=a.get("margin"));var h=this.get("d3"),i=this.get("nv");i.addGraph(function(){var j=i.models.multiBarHorizontalChart().margin(g).stacked(f).color(h.scale.category10().range());j.xAxis.tickFormat(function(b){return void 0!==a.axisKeys[b]?a.axisKeys[b]:""}),j.xAxis.rotateLabels(-30);var k=a.normalise(b);return a.bigValues&&j.yAxis.tickFormat(function(a){return chartView.get("numberFormat")(null,null,a)}),e||j.legend.margin({top:20,bottom:20}),h.select(d).datum(k).call(j),j.dispatch.on("stateChange",function(a){ReportData.chartStacked=a.stacked}),e||h.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),i.utils.windowResize(j.update),a.get("drilldownEnabled")&&j.multibar.dispatch.on("elementClick",h.contextMenu(getContextMenuElements(a.get("reportData")),function(){a.colorPickerCallback(a)})),a.chart=j,j})},updateData:function(){var a=this,b=a.get("data"),c=a.get("svg");a.set("chartColors",ReportData.chartColors);var d=a.normalise(b);d3.select(c).datum(d).call(a.chart)},normalise:function(a){var b=this.get("legend"),c=this.get("xAxis"),d=this.get("yAxis");c=reportUtils.appendDateGrouping(a,c);for(var e=this.get("aggregates"),f=!1,g=0;g<b.length;g++){if(reportUtils.getAggregate(b[g],e)){f=!0;break}}return f?this.parseAggregates(a,c,d,b):this.parseGroups(a,c,d,b)},data:{data:[],title:"",xAxis:"",yAxis:"",legend:"",svg:""}});