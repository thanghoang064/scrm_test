/*! AnalyticReporting 19-07-2018 */
function capitalize(a){return a&&a[0].toUpperCase()+a.slice(1)}function initChartView(a,b,c,d,e){e=e||b.fieldGroupingSorting,d=d||b.selectedAggregates,c=c||!1;var f="#chart1",g="#chart1 svg";return a&&(f=a,g="#"+a.attr("id")+" svg"),chartView=new ChartView({el:f,data:{svg:g,type:b.chartType,data:b.chartData,title:b.chartTitle,showPercents:b.chartShowPercents,showLabels:b.chartShowLabels,showZoneLabels:b.chartShowZoneLabels,valueZones:b.chartValueZones,xAxisSegment:b.chartAxisXSegment,legend:b.chartLegend,xAxis:b.chartAxisX,yAxis:b.chartAxisY,yAxis2:b.chartAxisY2,yAxisType:b.chartYAxisType,yAxis2Type:b.chartYAxis2Type,aggregates:d,groups:e,bars1Stacked:b.chartBars1Stacked,bars2Stacked:b.chartBars2Stacked,showLinks:c,isWidget:b.isWidget,cumulated:b.chartCumulated,sortableValues:b.chartSortableValues,numberFormat:new NumberFormatter(jQuery.extend({},{numdec:b.chartDecimalDigits},b.numberFormat),null).makeFormatter(),decimalDigits:b.chartDecimalDigits,mapType:b.mapType,country:b.country,state:b.state,zoom:b.zoom,lat:b.lat,lng:b.lng,labels:b.labels,fieldsByName:b.fieldsByName,options:b.options,chartOptions:b.chartOptions,combinedSelectedFields:b.combinedSelectedFields,availableFields:b.availableFields,columns:b.selectedFields,calcFields:b.calcFields,getAvailableGroups:reportUtils.getAvailableGroups(b,e,b.fieldsByName),filters:b.selectedFilters,margin:b.chartMargin,stacked:b.chartStacked,reportData:b,marker:b.marker,markerAxisX:b.markerAxisX,markerAxisY:b.markerAxisY,canEdit:b.canEdit,canDelete:b.canDelete,swapAxis:b.chartSwapAxis,chartColors:b.chartColors},components:{chartComponent:getChartComponent(b.chartType,b.chartLegend,b.chartAxisX,e)}}),chartView}function getContextMenuElements(a){return[{title:function(b){var c="#",d={meta:!1},e="",f="";if(b.data&&b.data.label?(e=b.data.label,f=b.color):b.data&&b.data.key?(e=b.data.key,f=b.color):b.series&&b.point?(e=b.series.key,f=b.point.color):b.series&&b.series.key&&(e=b.series.key,f=b.series.color),b.data?d=b.data:b.points?d=b.points:b.point&&(d=b.point),d.meta||d[2]){var g=d.meta||d[2];c=a.urlDrilldown+a.id+"&drilldown="+encodeURI(JSON.stringify(g))}return'<a href="'+c+'" target="_blank">Drill-down to detailed data</a><input type="hidden" value="'+e+'" id="colorForField"><input type="hidden" value="'+f+'" id="drilldownpopup" />'},action:function(a,b,c){}}]}function getChartObject(a){var b;switch(a){case"area":b=ReportAreaChart;break;case"gauge":b=ReportGaugeChart;break;case"funnel":b=ReportFunnelChart;break;case"bar":b=ReportBarChart;break;case"hbar":b=ReportHorizontalBarChart;break;case"line":b=ReportLineChart;break;case"combined":b=ReportCombinedChart;break;case"map":b=ReportMapChart;break;case"pie":default:b=ReportPieChart}return b}function getChartComponent(a,b,c,d){var e;switch(a){case"area":e=AreaChartComponent;break;case"gauge":e=GaugeChartComponent;break;case"funnel":e=FunnelChartComponent;break;case"bar":var f=reportUtils.getGroup(c,d);f&&f.dateGrouping&&c==f.name&&(c=f.name+"_"+f.dateGrouping),e=b!=c?MultiBarChartComponent:BarChartComponent;break;case"hbar":e=HorizontalBarChartComponent;break;case"line":e=LineChartComponent;break;case"combined":e=CombinedChartComponent;break;case"map":e=MapChartComponent;break;case"pie":default:e=PieChartComponent}return e}function loadChart(a,b,c,d){jQuery.post(ReportData.url+ReportData.id+"&chart=1",b,function(a){if(ReportData.chartSize){if(ReportData.chartHeight||ReportData.chartHeight>0)var b=ReportData.chartHeight+"px";else var b=200+400*ReportData.chartSize/100+"px";var e=ReportData.chartSize+"%";jQuery("#chart1").css({width:e,height:b})}ReportData.chartData=JSON.parse(a),(d.length>0||ReportData.options.isCombined)&&initChartView(!1,ReportData,!0,c,d)})}Ractive.decorators.select2.type.filter={width:"resolve",dropdownAutoWidth:!0};var multiSelectDecorator=function(a,b){var c,d,e=a._ractive.root,f=!1,g={header:!1,selectedList:1,click:function(){window.setTimeout(function(){jQuery(a).multiselect("refresh")},0)}};if(jQuery(a).multiselect(g),e.observe("disableSelectBox",function(b){b?jQuery(a).multiselect("disable"):jQuery(a).multiselect("enable")},{init:!1}),a._ractive.binding){var h=function(){f||(f=!0,window.setTimeout(function(){jQuery(a).change(),jQuery(a).multiselect("refresh"),f=!1},0))};c=e.observe(a._ractive.binding.keypath,h),d=e.observe("optionGroups",h)}return jQuery(a).multiselect(g).on("change",function(){f||(f=!0,e.updateModel(),f=!1)}),{teardown:function(){jQuery(a).multiselect("destroy"),c&&(c.cancel(),d.cancel())}}},selectBoxCache={},selectBox=Ractive.extend({template:function(a){if(void 0===selectBoxCache[a.valueName+"|"+a.titleName+"|"+a.addDecorator]){var b="";a.addDecorator&&""!=a.addDecorator&&(b='decorator="'+a.addDecorator+'"'),selectBoxCache[a.valueName+"|"+a.titleName]=Ractive.parse("<select "+b+' value="{{selected}}" disabled="{{readOnly}}">{{#options}}<option value="{{'+a.valueName+'}}" title="{{'+a.descriptionName+'}}">{{'+a.titleName+"}}</option>{{/options}}</select>")}return selectBoxCache[a.valueName+"|"+a.titleName]},oncomplete:function(){var a=this.get();if(a.autoSelectFirst){var b=this,c=function(c){for(var d=!1,e=0;e<c.length;e++)if(c[e][a.valueName]==a.selected){d=!0;break}!d&&c.length>0&&b.set("selected",a.options[0][a.valueName])};c(a.options),this.observe("options",c,{init:!1})}},data:{selected:null,options:[],titleName:"",valueName:"",descriptionName:"",addDecorator:"",autoSelectFirst:!0,readOnly:!1},modifyArrays:!1}),selectBoxImg=Ractive.extend({template:"#selectBoxImgTemplate",oncomplete:function(){var a=!1,b=this.get("autoSelect"),c=this.get("selected"),d=this.get("options"),e=this.get("valueName");b&&""===c&&this.set("selected",d[0][e]);var f=this.find("select"),g=this;jQuery(f).ddslick({width:250,height:300,background:"transparent",imagePosition:"left",onSelected:function(b){if(a){for(var c=0,d=ReportData.selectedAggregates.length-1;d>=0;d--){var e;for(e in aggregatesDefinitions)ReportData.selectedAggregates[d].value[e]&&c++}"Combined"!=b.selectedData.text||ReportData.fieldGroupingSorting.length>0&&c>1?(g.get("selected")!=b.selectedData.value&&jQuery("#ar-rv-chart-editor-tabs").tabs("option","active",1),g.set("selected",b.selectedData.value)):alert(translated_labels.label_chart_error)}}}),setTimeout(function(){for(var b=0,c=ReportData.selectedAggregates.length-1;c>=0;c--){var d;for(d in aggregatesDefinitions)ReportData.selectedAggregates[c].value[d]&&b++}0==ReportData.fieldGroupingSorting.length||b<2?(jQuery(".dd-options").children()[3].style.backgroundColor="lightgrey;",jQuery(".dd-options").children()[3].children[0].backgroundColor="lightgrey;"):(jQuery(".dd-options").children()[3].backgroundColor="white;",jQuery(".dd-options").children()[3].children[0].backgroundColor="white;"),a=!0},3e3)},data:{options:[],selected:"",autoSelect:!0,id:""}}),multiSelectBox=Ractive.extend({template:"#multiSelectBoxTemplate",oninit:function(){},oncomplete:function(){var a=this,b=function(){var b=a.get("selected"),c=a.getDisabledValues(b),d=a.get("options"),e=a.convertData(d,"key","values","name","title",c,b),f=!1;JSON.stringify(e.options)!==JSON.stringify(a.get("optionGroups"))&&(f=!0),a.set("optionGroups",e.options).then(function(){if(JSON.stringify(e.selected)===JSON.stringify(a.get("selected")))return!0;f=!0}).then(function(){f&&setTimeout(function(){a.fire("selectChanged")},10)})};this.observe("options",b,{init:!1}),this.observe("selected",function(a){this.data.selected=a,b()},{init:!1}),b()},getDisabledValues:function(a){for(var b=this.get("aggregates"),c=this.get("groups"),d=[],e=!1,f=!1,g=0;g<a.length;g++){if(c.length>0)for(var h=0;h<c.length;h++)if(a[g]==c[h].name){e=!0;break}if(ReportData.options.isCombined&&"date_field"==a[g]){e=!0;break}if(b.length>0)for(var h=0;h<b.length;h++){var i;for(i in aggregatesDefinitions)if(b[h].value[i]&&a[g]==b[h].selectedField+aggregatesDefinitions[i].namePostfix){f=!0;break}if(f)break}}if(e){for(var g=0;g<b.length;g++){var i;for(i in aggregatesDefinitions)b[g].value[i]&&d.push(b[g].selectedField+aggregatesDefinitions[i].namePostfix)}for(var g=0;g<a.length;g++){for(var h=0;h<c.length;h++)a[g]!=c[h].name&&d.push(c[h].name);ReportData.options.isCombined&&"date_field"!=a[g]&&d.push("date_field")}}if(f){for(var g=0;g<c.length;g++)d.push(c[g].name);ReportData.options.isCombined&&d.push("date_field")}return d},convertData:function(a,b,c,d,e,f,g){for(var h=[],i=[],j=0;j<a.length;j++){for(var k=[],l=0;l<a[j][c].length;l++){var m=!1;-1!==jQuery.inArray(a[j][c][l][d],f)&&(m=!0);m||-1===jQuery.inArray(a[j][c][l][d],g)||(!0,i.push(a[j][c][l][d])),k.push({value:a[j][c][l][d],title:a[j][c][l][e],disabled:m})}h.push({title:a[j][b],items:k})}return h={options:h,selected:i}},decorators:{multiSelect:multiSelectDecorator},data:{options:[],selected:"",optionGroups:[],disabledValues:[],disabledSelectBox:!1,groups:[],aggregates:[]}}),reportUtils={appendDateGrouping:function(a,b){return void 0===a.cols[b]&&(void 0!==a.cols[b+"_year"]?b+="_year":void 0!==a.cols[b+"_quarter"]?b+="_quarter":void 0!==a.cols[b+"_quarterAndYear"]?b+="_quarterAndYear":void 0!==a.cols[b+"_month"]?b+="_month":void 0!==a.cols[b+"_monthAndYear"]?b+="_monthAndYear":void 0!==a.cols[b+"_week"]?b+="_week":void 0!==a.cols[b+"_weekAndYear"]?b+="_weekAndYear":void 0!==a.cols[b+"_day"]&&(b+="_day")),b},generateFieldsByNameFromBlocks:function(a){for(var b={},c=0;c<a.length;c++)for(var d=0;d<a[c].fields.length;d++)b[a[c].fields[d].name]=a[c].fields[d];return b},isMultiSummaryReport:function(a,b,c,d){d=d||!1;for(var e=[],f=0;f<b.length;f++){var g=b[f],h=g.showAggregates;if("column"!=g.position||!d)for(var i=0;i<a.length;i++){var j=h[a[i].selectedField];if(j){var k,l=!1;for(k in aggregatesDefinitions)j[k]&&(l=!0);l&&e.push(!0)}}}return c||e.pop(),e.length>0},convertToJSONPost:function(a,b){var c={};b=b||[];for(var d=Object.keys(a),e=0;e<d.length;e++)-1==b.indexOf(d[e])?c[d[e]]=JSON.stringify(a[d[e]]):c[d[e]]=a[d[e]];return c},getAvailableGroups:function(a,b,c){for(var d=[],e=0;e<b.length;e++)if(-1!=["group","groupsort","nogroup"].indexOf(b[e].sortAction)){var f=jQuery.extend(!0,{},b[e]),g=f.aggregate;f.title=f.fieldLabel,c[g]&&(f.title=c[g].title),f.dateGrouping&&(f.title+=" "+a.dictionary["label_"+reportUtils.toSnakeCase(f.dateGrouping)],f.name=g+"_"+f.dateGrouping),d.push(f)}return a.options.isCombined&&d.unshift({name:"date_field",title:a.dictionary.label_date,showAggregates:{},sortAction:"group",sortDirection:"DESC",aggregate:"",position:"",dateGrouping:""}),d=_.uniq(d,function(a){return a.name})},makeAvailableFields:function(a){for(var b=[],c=0;c<a.length;c++)for(var d=0;d<a[c].fields.length;d++)b.push(a[c].fields[d]);return b},makeFieldsByName:function(a){for(var b={},c=0;c<a.length;c++)for(var d=0;d<a[c].fields.length;d++)b[a[c].fields[d].name]=a[c].fields[d];return b},getAggregate:function(a,b){for(var c=!1,d=0;d<b.length;d++){var e;for(e in aggregatesDefinitions)b[d].value[e]&&b[d].selectedField+aggregatesDefinitions[e].namePostfix==a&&(c=!0);if(c)return b[d]}},getGroup:function(a,b){for(var c=0;c<b.length;c++){var d=b[c].name;if(b[c].dateGrouping&&(d+="_"+b[c].dateGrouping),d==a||b[c].name==a)return b[c]}},findKey:function(a,b){for(var c in a)if(a[c]==b)return c;return null},unique:function(a){var b=[];return jQuery.each(a,function(a,c){-1==jQuery.inArray(c,b)&&b.push(c)}),b},toSnakeCase:function(a){return a.replace(/([A-Z])/g,function(a){return"_"+a.toLowerCase()})},toTitleCase:function(a){return a.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()})},setFieldsByName:function(){if(ReportData.options.isCombined){for(var a=0;a<ReportData.availableFields.length;a++)for(var b=0;b<ReportData.availableFields[a].fields.length;b++)ReportData.availableFields[a].fields[b].moduleId=ReportData.availableFields[a].fields[b].name.split("_")[0];for(var a=0;a<ReportData.selectableFields.length;a++)for(var b=0;b<ReportData.selectableFields[a].fields.length;b++)ReportData.selectableFields[a].fields[b].moduleId=ReportData.selectableFields[a].fields[b].name.split("_")[0];ReportData.fieldGroupingSorting=ReportData.fieldGroupingSorting.filter(function(a){return void 0!==a.showAggregates})}var c=[];return void 0!==ReportData.options.isCombined&&(ReportData.options.isCombined?(c=reportUtils.makeAvailableFields(ReportData.selectableFields),ReportData.fieldsByName=reportUtils.makeFieldsByName(ReportData.selectableFields)):(c=reportUtils.makeAvailableFields(ReportData.availableFields),ReportData.fieldsByName=reportUtils.makeFieldsByName(ReportData.availableFields))),c}},NumberFormatter=function(a,b){var c=jQuery.extend({},{format:"",seperator:"'",decimal:".",numdec:currentUser.numberPreferences.currencySignificantDigits},a);this.format=c.format,this.decimal=c.decimal,this.seperator=c.seperator,this.aggregates=b,this.numdec=c.numdec,this.integerFields=this.getIntegerFields(),this.integerAggregates=this.getIntegerAggregates()};NumberFormatter.prototype.format="",NumberFormatter.prototype.decimal=".",NumberFormatter.prototype.seperator="'",NumberFormatter.prototype.makeFormatter=function(){var a=this;switch(this.format){case"123,456,789":return function(b,c,d,e,f){try{a.validateNumber(d)}catch(a){return d||""}return d=a.roundByType(d,e,f),a.by3Formatter(d)};case"12,34,56,789":return function(b,c,d,e,f){try{a.validateNumber(d)}catch(a){return d||""}return d=a.roundByType(d,e,f),a.by3then2Formatter(d)};case"123456,789":return function(b,c,d,e,f){try{a.validateNumber(d)}catch(a){return d||""}return d=a.roundByType(d,e,f),a.first3Formatter(d)};case"123456789":default:return function(b,c,d,e,f){try{a.validateNumber(d)}catch(a){return d||""}return d=a.roundByType(d,e,f),a.noFormatter(d)}}},NumberFormatter.prototype.changeDecimalSymbol=function(a){var b="";return a.length>1&&(b=this.decimal+a[1]),b},NumberFormatter.prototype.validateNumber=function(a){if(null==a)throw"";if(!this.isNumber(a))throw a;if(a.length&&!a[0].match("[0-9]"))throw a},NumberFormatter.prototype.by3Formatter=function(a){var b=a.split("."),c=this.changeDecimalSymbol(b);return b[0].length>3&&(b[0]=this.by3(b[0])),b[0]+c},NumberFormatter.prototype.by3then2Formatter=function(a){var b=a.split("."),c=this.changeDecimalSymbol(b);return b[0].length>3&&(b[0]=this.by3then2(b[0])),b[0]+c},NumberFormatter.prototype.first3Formatter=function(a){var b=a.split("."),c=this.changeDecimalSymbol(b);return b[0].length>3&&(b[0]=this.first3(b[0])),b[0]+c},NumberFormatter.prototype.noFormatter=function(a){var b=a.split("."),c=this.changeDecimalSymbol(b);return b[0].length>3&&(b[0]=this.noFormat(b[0])),b[0]+c},NumberFormatter.prototype.separator=function(){var a=this;switch(this.format){case"123,456,789":return function(b,c,d,e,f){try{a.validateNumber(d)}catch(a){return d||""}return a.by3Formatter(String(d))};case"12,34,56,789":return function(b,c,d,e,f){try{a.validateNumber(d)}catch(a){return d||""}return a.by3then2Formatter(String(d))};case"123456,789":return function(b,c,d,e,f){try{a.validateNumber(d)}catch(a){return d||""}return a.first3Formatter(String(d))};case"123456789":default:return function(b,c,d,e,f){try{a.validateNumber(d)}catch(a){return d||""}return a.noFormatter(String(d))}}},NumberFormatter.prototype.noFormat=function(a){return a},NumberFormatter.prototype.by3=function(a){for(var b=a.split("").reverse(),c=[],d=1;d<b.length;d++)c.push(b[d-1]),d%3==0&&c.push(this.seperator);return c.push(b[b.length-1]),c.reverse().join("")},NumberFormatter.prototype.by3then2=function(a){for(var b=a.split("").reverse(),c=[],d=1;d<b.length&&d<4;d++)c.push(b[d-1]),d%3==0&&c.push(this.seperator);for(var d=4;d<b.length;d++)c.push(b[d-1]),d-4&&(d-1)%2==0&&c.push(this.seperator);return c.push(b[b.length-1]),c.reverse().join("")},NumberFormatter.prototype.first3=function(a){var b=a.split(""),c=b.splice(-3,3);return b.length>0&&(c=b.join("")+this.seperator+c.join("")),c},NumberFormatter.prototype.isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},NumberFormatter.prototype.isCountAggregate=function(a,b){var c=a.substr(a.lastIndexOf("_")+1),d=["sum","min","max","avg"];if("cnt"==c||"countDistinct"==c)return!0;if(d.indexOf(c)>-1)return!1;if(void 0!==b&&ReportData.options.aggregateColumn)return!!b.aggregates&&0==b.aggregates.indexOf("Count(");for(var e=0;e<ReportData.selectedAggregates.length;e++)if(a.indexOf(ReportData.selectedAggregates[e].selectedField)>-1)return ReportData.selectedAggregates[e].value.count;return!1},NumberFormatter.prototype.getIntegerFields=function(){for(var a=[],b=0;b<ReportData.availableFields.length;b++)for(var c=0;c<ReportData.availableFields[b].fields.length;c++)"integer"==ReportData.availableFields[b].fields[c].type&&a.push(ReportData.availableFields[b].fields[c].name);return a},NumberFormatter.prototype.getIntegerAggregates=function(){for(var a=[],b=0;b<ReportData.selectedAggregates.length;b++){var c=ReportData.selectedAggregates[b];this.integerFields.indexOf(c.selectedField)>-1&&(c.value.sum&&a.push(ReportData.labels[c.selectedField+"_sum"]),c.value.max&&a.push(ReportData.labels[c.selectedField+"_max"]),c.value.min&&a.push(ReportData.labels[c.selectedField+"_min"]))}return a},NumberFormatter.prototype.isIntegerType=function(a,b){if(void 0!==b&&ReportData.options.aggregateColumn)return this.integerAggregates.indexOf(b.aggregates)>-1;for(var c=0;c<this.integerFields.length;c++)if(a.indexOf("_avg")<0&&a.indexOf(this.integerFields[c])>-1)return!0},NumberFormatter.prototype.roundByType=function(a,b,c){return void 0!==b&&(this.isCountAggregate(b.field,c)||this.isIntegerType(b.field,c))&&"avg"!=c?(Math.round(100*parseFloat(a))/100).toFixed(0):Number(Math.round(a+"e+"+this.numdec)+"e-"+this.numdec).toFixed(this.numdec)};var validateXAxis=function(a){for(var b=this.get("getAvailableGroups"),c=!1,d=0;d<b.length;d++)if(a==b[d].name){c=!0;break}var e=a;c||b.length>0&&(e=b[0].name,this.set("xAxis",e)),ReportData.chartAxisX=e};String.prototype.endsWith||(String.prototype.endsWith=function(a,b){return(void 0===b||b>this.length)&&(b=this.length),this.substring(b-a.length,b)===a});var BaseChartComponent=Ractive.extend({isolated:!1,chartHeight:600,chartHeightModifier:1.2,bigValues:!1,parentInit:function(){var a=this;this.get("isWidget")||((ReportData.chartHeight||ReportData.chartHeight>0)&&(this.chartHeight=ReportData.chartHeight),this.on("increaseHeight",function(){a.chartIncreaseHeight()}),this.on("decreaseHeight",function(){a.chartDecreaseHeight()}),this.on("changeColor",function(b){a.changeColor(b)}),jQuery(document).on("d3RenderRequest",function(){a.chartUpdate()})),a.chart&&setTimeout(function(){console.log("chart update now ",a.chart)},300)},chartUpdate:function(){this.chart&&this.chart.update&&this.chart.update()},chartIncreaseHeight:function(){this.chartHeight=Math.round(this.chartHeight*this.chartHeightModifier),jQuery("#chart1").css({height:this.chartHeight}),ReportData.chartHeight=this.chartHeight,this.chartUpdate()},chartDecreaseHeight:function(){this.chartHeight=Math.round(this.chartHeight/this.chartHeightModifier),jQuery("#chart1").css({height:this.chartHeight}),ReportData.chartHeight=this.chartHeight,this.chartUpdate()},changeColor:function(a){this.chartColors=jQuery.extend({},ReportData.chartColors,a),ReportData.chartColors=this.chartColors,this.updateData()},parseGroups:function(a,b,c,d){for(var c=[].concat(c),d=[].concat(d),e=[],f=[],g=this.get("chartColors"),h={},i=this.get("reportData"),j=0;j<a.data.length;j++){for(var k=0;k<d.length;k++){var l=d[k],m=l+"_raw",n=a.data[j][m];n||(n="-"),e.push(a.data[j][m]),h[a.data[j][m]]=a.data[j][l]}a.data[j][b]||(a.data[j][b]="-"),f.push(a.data[j][b])}var o=this.getTopLefLegendFieldOrdering(d[0],i.chartGrouping);e=reportUtils.unique(e).sort(function(a,b){return"ASC"==o?a-b:b-a}),f=reportUtils.unique(f),this.axisKeys=f;for(var p=[],j=0;j<e.length;j++){var q=h[e[j]];p[j]={key:q,values:[]};var r=d3.scale.category10().range();g&&g[q]?p[j].color=g[q]:p[j].color=r[j];for(var k=0;k<f.length;k++)p[j].values[k]={x:k,y:0},p[j].values[k].meta=this.parseMetaDrilldown([{fieldName:d[0],value:this.parseMetaValue(a.data[j],d[0]),type:"legend"},{fieldName:b,value:this.parseMetaValue(a.data[j],b),type:"xAxis"}])}var s=[];for(var t in h)s.push(h[t]);for(var j=0;j<a.data.length;j++)for(var u=f.indexOf(a.data[j][b]),k=0;k<d.length;k++){var v=s.indexOf(a.data[j][d[k]]);a.data[j][c]||(a.data[j][c]=0),p[v].values[u].y+=parseFloat(a.data[j][c]),parseFloat(a.data[j][c])>=5&&(this.bigValues=!0),p[v].values[u].meta=this.parseMetaDrilldown([{fieldName:d[k],value:this.parseMetaValue(a.data[j],d[k]),type:"legend"},{fieldName:b,value:this.parseMetaValue(a.data[j],b),type:"xAxis"}])}return p},parseAggregatesSwap:function(a,b,c,d){for(var e=[],f=[],g=[],h=0;h<d.length;h++)e.push(d[h]);for(var f=[].concat(c),i=[],j=0;j<f.length;j++)i.push(a.cols[f[j]]);this.axisKeys=i;var k=a.cols[b];g[0]={key:k,values:[]};for(var h=0;h<f.length;h++)g[0].values[h]={x:h,y:0};for(var j=0;j<a.data.length;j++)for(var h=0;h<f.length;h++)for(var l=f[h],m=0;m<g.length;m++)g[m].values[h].y+=parseFloat(a.data[j][l]);return g},parseAggregates:function(a,b,c,d){for(var e=[],f=[],g=this.get("chartColors"),h=0;h<d.length;h++)e.push(d[h]);for(var i=0;i<a.data.length;i++)a.data[i][b]||(a.data[i][b]="-"),f.push(a.data[i][b]);e=reportUtils.unique(e),f=reportUtils.unique(f),this.axisKeys=f;for(var j=[],i=0;i<e.length;i++){j[i]={key:e[i],values:[]};for(var h=0;h<f.length;h++)j[i].values[h]={x:h,y:0}}for(var i=0;i<a.data.length;i++)for(var k=f.indexOf(a.data[i][b]),h=0;h<d.length;h++)for(var l=0;l<j.length;l++)j[l].key==d[h]&&(a.data[i][d[h]]||(a.data[i][d[h]]=0),this.bigValues=!0,j[l].values[k].y+=parseFloat(a.data[i][d[h]]),j[l].values[k].meta=this.parseMetaDrilldown([{fieldName:d[h],value:this.parseMetaValue(a.data[i],d[h]),type:"legend"},{fieldName:b,value:this.parseMetaValue(a.data[i],[b]),type:"xAxis"}]));for(var i=0;i<j.length;i++)j[i].key=a.cols[j[i].key],g&&g[j[i].key]&&(j[i].color=g[j[i].key]);return j},parseMetaDrilldown:function(a){var b=this.get("aggregates"),c=reportUtils.getAvailableGroups(this.get("reportData"),this.get("groups"),this.get("fieldsByName"));if(c.length<1)return!1;a=_.uniq(a,function(a){return a.fieldName});for(var d=0;d<a.length;d++){reportUtils.getAggregate(a[d].fieldName,b)&&a.splice(d,1),a[d].condition="eq";var e=this.findGroupingWithDate(c,a[d].fieldName);e&&(a[d].fieldName=e.aggregate,a[d].condition=e.dateGrouping),"-"!=a[d].value&&""!=a[d].value||(a[d].condition="empty")}return a},parseMetaValue:function(a,b){if(a){if(void 0!==a[b+"_setype"]){if(0==["Users"].indexOf(a[b+"_setype"]))return a[b+"_id"]}return a[b+"_value"]?a[b+"_value"]:a[b]}},findGroupingWithDate:function(a,b){for(var c=0;c<a.length;c++)if(a[c].dateGrouping){var d=b+"_"+a[c].dateGrouping;if(a[c].name==b||a[c].name==d)return a[c]}return!1},findByKeyValue:function(a,b,c){for(var d={},e=0;e<a.length;e++)if(a[e][b]==c){d=a[e];break}return d},colorPickerCallback:function(a){d3.selectAll(".nvtooltip").style("opacity",0),a.get("isWidget")||(a.spectrumContainer&&jQuery(a.spectrumContainer).remove(),jQuery("#drilldownpopup").spectrum({clickoutFiresChange:!1,preferredFormat:"hex",change:function(b){var c=b.toHexString(),d=jQuery("#colorForField").val(),e={};e[d]=c,a.changeColor(e),jQuery(".d3-context-menu").hide()}}),a.spectrumContainer=jQuery("#drilldownpopup").spectrum("container"))},getTopLefLegendFieldOrdering:function(a,b){for(var c="ASC",d=0;d<b.length;++d){var e=b[d],f=e.name;if(e.dateGrouping.length&&"default"!=e.dateGrouping&&(f+="_"+e.dateGrouping),f==a&&"DESC"==e.sortDirection){c="DESC";break}}return c}}),ChartView=Ractive.extend({isolated:!1,template:'<chartComponent data="{{data}}" title="{{title}}" isWidget="{{isWidget}}" xAxis="{{xAxis}}" yAxis="{{yAxis}}" yAxis2="{{yAxis2}}" yAxisType="{{yAxisType}}" yAxis2Type="{{yAxis2Type}}" legend="{{legend}}" bars1Stacked="{{bars1Stacked}}" bars2Stacked="{{bars2Stacked}}" aggregates="{{aggregates}}" groups="{{groups}}" cumulated="{{cumulated}}" sortableValues="{{sortableValues}}" showPercents="{{showPercents}}" showLabels="{{showLabels}}" showZoneLabels="{{showZoneLabels}}" valueZones="{{valueZones}}" xAxisSegment="{{xAxisSegment}}" svg="{{svg}}" decimalDigits={{decimalDigits}} type="{{type}}" mapType="{{mapType}}" country="{{country}}" state="{{state}}" zoom="{{zoom}}" lat="{{lat}}" lng="{{lng}}" labels="{{labels}}" getAvailableGroups="{{getAvailableGroups}}" marker="{{marker}}" markerAxisX="{{markerAxisX}}" markerAxisY="{{markerAxisY}}" drilldownEnabled="{{drilldownEnabled}}" swapAxis="{{swapAxis}}" chartColors="{{chartColors}}" d3="{{d3}}" nv="{{nv}}"/>',computed:{drilldownEnabled:function(){var a=this.get("options");return!a.isCombined&&!(!this.get("canEdit")&&!this.get("canDelete")&&!a.allowDrilldownReadOnly)}},data:{d3:"undefined"!=typeof ard3?ard3:d3,nv:"undefined"!=typeof arnv?arnv:nv,title:"",type:!1,xAxisSegment:!1,valueZones:[],showPercents:!1,showLabels:!0,showZoneLabels:!0,cumulated:!0,sortableValues:[],isWidget:!1,aggregates:[],groups:[],xAxis:[],yAxis:[],yAxis2:[],legend:[],yAxisType:[],yAxis2Type:[],svg:"",numberFormat:{},decimalDigits:0,mapType:!1,country:!1,state:!1,zoom:2,lat:51.505,lng:-.09,labels:{},fieldsByName:{},options:{},chartOptions:{},combinedSelectedFields:[],availableFields:[],columns:[],calcFields:[],getAvailableGroups:[],filters:[],margin:{},stacked:!1,reportData:{},marker:!1,markerAxisX:!1,markerAxisY:!1,canEdit:!1,canDelete:!1,swapAxis:!1,chartColors:{}}}),BarChartLegendManager=Ractive.extend({template:"#barChartLegendTemplate",oninit:function(){var a=this;this.get("yAxis")instanceof String&&this.set("yAxis",[this.get("yAxis")]),this.get("legend")instanceof String&&this.set("legend",[this.get("legend")]);var b=function(){for(var b=[],c=(a.get("groups"),a.get("aggregates")),d=a.get("fieldsByName"),e=0;e<c.length;e++){var f,g=d[c[e].selectedField].title,h=c[e].selectedField;for(f in aggregatesDefinitions)c[e].value[f]&&b.push({name:h+aggregatesDefinitions[f].namePostfix,title:g+" "+translated_labels[aggregatesDefinitions[f].label]})}b=_.uniq(b,function(a){return a.name});var i=[{key:translated_labels.label_groups,values:a.get("getAvailableGroups")},{key:translated_labels.label_aggregates,values:b}],b=[{key:translated_labels.label_aggregates,values:b}];a.set("availableAxis",b),a.set("availableGroups",a.get("getAvailableGroups")),a.set("availableLegends",i)};this.observe("groups",b),this.observe("aggregates",b,{init:!1}),this.observe("xAxis",validateXAxis,{init:!1}),this.observe("yAxis",function(b){1==b.length?a.set("legend",[this.get("xAxis")]):a.set("legend",b),ReportData.chartAxisY=b},{init:!1}),this.observe("xAxis",function(b){1==a.get("yAxis").length&&a.set("legend",[this.get("xAxis")])},{init:!1}),this.observe("y2Axis",function(a){ReportData.chartAxisY2=a},{init:!1}),0==this.get("legend").length&&this.set("legend",[this.get("xAxis")]),this.observe("legend",function(b){ReportData.chartLegend=b;for(var c=a.get("aggregates"),d=!1,e=0;e<b.length;e++)if(reportUtils.getAggregate(b[e],c)){d=!0;break}d&&a.set("yAxis",b)}),this.observe("chartSize",function(a){ReportData.chartSize=a}),this.observe("decimalDigits",function(a){ReportData.chartDecimalDigits=a}),this.observe("showPercents",function(a){ReportData.chartShowPercents=a}),this.observe("swapAxis",function(a){ReportData.chartSwapAxis=a})},computed:{getAvailableGroups:function(){return reportUtils.getAvailableGroups(this.get("reportData"),this.get("groups"),this.get("fieldsByName"))}},data:{xAxis:ReportData.chartAxisX,yAxis:ReportData.chartAxisY,y2Axis:ReportData.chartAxisY2,chartTitle:ReportData.chartTitle,legend:ReportData.chartLegend,availableLegends:[],labelName:ReportData.chartLabels,groups:[],aggregates:[],availableAxis:[],availableGroups:[],chartSizes:ReportData.chartSizes,chartSize:ReportData.chartSize,chartDecimals:[],decimalDigits:0,showPercents:ReportData.chartShowPercents,swapAxis:!1},components:{chartButtons:chartButtons,selectBox:selectBox,multiSelectBox:multiSelectBox}}),ReportBarChart={parseDataItems:function(a,b,c,d,e){for(var f=0;f<a.length;f++){if("string"==typeof a[f]){var g=reportUtils.getAggregate(a[f],b),h=reportUtils.getGroup(a[f],c);g&&e.push(g),h&&d.push(h)}"object"==typeof a[f]&&this.parseDataItems(a[f],b,c,d,e)}},prepareData:function(a,b,c,d,e){var f=ReportData.chartAxisX,g=ReportData.chartAxisY,h=ReportData.chartLegend,i=[],j=[],k=[];if(k.push(f),k.push(g),k.push(h),this.parseDataItems(k,d,e,j,i),j=_.uniq(j,function(a){return a.name+"_"+a.dateGrouping}),ReportData.options.isCombined){var l=a.get("combinedSelectedFields.fields");for(moduleId in l)for(var m=l[moduleId],n=0;n<ReportData.availableFields.length;n++)for(var o=0;o<ReportData.availableFields[n].fields.length;o++)if(m==ReportData.availableFields[n].fields[o].name){var p=jQuery.extend(!0,{},ReportData.availableFields[n].fields[o]);p={name:m},p.sortAction="date_field"==ReportData.chartAxisX?"nogroup"!==ReportData.combinedSelectedFields.sortAction?ReportData.combinedSelectedFields.sortAction:"group":"nogroup",p.dateGrouping=ReportData.combinedSelectedFields.dateGrouping,p.sortDirection=ReportData.combinedSelectedFields.sortDirection,p.position=ReportData.combinedSelectedFields.position,j.unshift(p)}}for(var q=[],n=0;n<i.length;n++)q.indexOf(i[n].selectedField)>-1?(i.splice(n,1),n--):q.push(i[n].selectedField);var r={chartShowPercents:ReportData.chartShowPercents,type:"bar",chartAggregates:d};return{filters:JSON.stringify(b),columns:JSON.stringify(c),options:JSON.stringify(ReportData.chartOptions),labels:JSON.stringify(ReportData.labels),aggregates:JSON.stringify(i),grouping:JSON.stringify(j),calcFields:JSON.stringify(ReportData.calcFields),chartSettings:r}},init:function(a,b,c,d,e){loadChart("bar",this.prepareData(a,b,c,d,e),d,e)}},BarChartComponent=BaseChartComponent.extend({template:function(a){return a.isWidget?"<svg></svg>":"#chartViewTemplate"},oninit:function(){this.parentInit()},onrender:function(){var a=this,b=a.get("data"),c=a.get("title"),d=a.get("svg"),e=a.get("isWidget"),f={top:50,right:50,bottom:120,left:70};!e&&a.get("margin")&&(f=a.get("margin"));var g=this.get("d3"),h=this.get("nv");h.addGraph(function(){var i=h.models.discreteBarChart().options({reduceXTicks:!1}).x(function(a){return a.label}).y(function(a){return a.value}).staggerLabels(!1).showValues(!0).margin(f).color(g.scale.category10().range()).valueFormat(function(a){return chartView.get("numberFormat")(null,null,a)});return i.xAxis.rotateLabels(-30),a.bigValues&&i.yAxis.tickFormat(function(a){return chartView.get("numberFormat")(null,null,a)}),i.forceY(0),g.select(d).datum(a.normalise(b)).call(i),e||g.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),h.utils.windowResize(i.update),a.chartUpdate(),a.get("drilldownEnabled")&&i.discretebar.dispatch.on("elementClick",g.contextMenu(getContextMenuElements(a.get("reportData")),function(){a.colorPickerCallback(a)})),a.chart=i,i})},updateData:function(){var a=this,b=a.get("data"),c=a.get("svg");a.set("chartColors",ReportData.chartColors),d3.select(c).datum(a.normalise(b)).call(a.chart)},normalise:function(a){var b=this,c=this.get("xAxis"),d=this.get("yAxis");c=reportUtils.appendDateGrouping(a,c);var e=[];return _.each(a.data,function(a){a[d]||(a[d]=0),this.bigValues=!0;var f={label:a[c],value:parseFloat(a[d]),meta:b.parseMetaDrilldown([{fieldName:c,value:b.parseMetaValue(a,c),type:"legend"}])},g=b.get("chartColors");g&&g[a[c]]&&(f.color=g[a[c]]),e.push(f)}),[{values:e}]},data:{data:[],title:"",xAxis:"",yAxis:"",swapAxis:!1,svg:""}});MultiBarChartComponent=BaseChartComponent.extend({template:function(a){return a.isWidget?"<svg></svg>":"#chartViewTemplate"},oninit:function(){this.parentInit()},onrender:function(){var a=this,b=a.get("data"),c=a.get("title"),d=a.get("svg"),e=a.get("isWidget"),f=a.get("stacked"),g={top:50,right:150,bottom:120,left:70},h=this.get("d3"),i=this.get("nv");!e&&a.get("margin")&&(g=a.get("margin"));var h=this.get("d3"),i=this.get("nv");i.addGraph(function(){var j=i.models.multiBarChart().reduceXTicks(!1).margin(g).stacked(f).color(h.scale.category10().range());j.xAxis.tickFormat(function(b){return void 0!==a.axisKeys[b]?a.axisKeys[b]:""}),j.xAxis.rotateLabels(-30),a.bigValues&&j.yAxis.tickFormat(function(a){return chartView.get("numberFormat")(null,null,a)}),e||j.legend.margin({top:20,bottom:20});var k=a.normalise(b);return h.select(d).datum(k).call(j),j.dispatch.on("stateChange",function(a){e||(ReportData.chartStacked=a.stacked)}),e||h.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),i.utils.windowResize(j.update),a.chartUpdate(),a.get("drilldownEnabled")&&j.multibar.dispatch.on("elementClick",h.contextMenu(getContextMenuElements(a.get("reportData")),function(){a.colorPickerCallback(a)})),a.chart=j,j})},updateData:function(){var a=this,b=a.get("data"),c=a.get("svg");a.set("chartColors",ReportData.chartColors);var d=a.normalise(b);d3.select(c).datum(d).call(a.chart)},normalise:function(a){var b=this.get("legend"),c=this.get("xAxis"),d=this.get("yAxis");c=reportUtils.appendDateGrouping(a,c);for(var e=this.get("aggregates"),f=!1,g=0;g<b.length;g++){if(reportUtils.getAggregate(b[g],e)){f=!0;break}}return f?this.get("swapAxis")?this.parseAggregatesSwap(a,c,d,b):this.parseAggregates(a,c,d,b):this.parseGroups(a,c,d,b)},data:{data:[],title:"",xAxis:"",yAxis:"",swapAxis:!1,legend:"",svg:""}});var PieChartComponent=BaseChartComponent.extend({template:function(a){return a.isWidget?"<svg></svg>":"#chartViewTemplate"},oninit:function(){this.parentInit()},onrender:function(){var a=this,b=a.get("data"),c=a.get("title"),d=a.get("svg"),e=a.get("isWidget"),f=a.get("showPercents"),g=(this.get("options"),{top:10,right:10,bottom:10,left:10});!e&&a.get("margin")&&(g=a.get("margin"));var h=this.get("d3"),i=this.get("nv");i.addGraph(function(){var j=i.models.pieChart().x(function(a){return a.label}).y(function(a){return a.value}).margin(g).showLabels(!0).color(h.scale.category10().range());return j.pie.labelsOutside(!0).labelType("value").showPercents(f),j.pie.valueFormat(function(a){return chartView.get("numberFormat")(null,null,a)}),e||j.legend.margin({top:20,bottom:20}),h.select(d).datum(a.normalise(b)).transition().duration(350).call(j),e||h.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),i.utils.windowResize(j.update),a.chartUpdate(),a.get("drilldownEnabled")&&j.pie.dispatch.on("elementClick",h.contextMenu(getContextMenuElements(a.get("reportData")),function(){a.colorPickerCallback(a)})),a.chart=j,j})},updateData:function(){var a=this,b=a.get("data"),c=a.get("svg");a.set("chartColors",ReportData.chartColors),d3.select(c).datum(a.normalise(b)).transition().duration(350).call(a.chart)},normalise:function(a){var b=this,c=this.get("xAxis"),d=this.get("yAxis");c=reportUtils.appendDateGrouping(a,c);var e=[];return _.each(a.data,function(a){if(a[c]||a[d]){var f={label:a[c],value:parseFloat(a[d]),meta:b.parseMetaDrilldown([{fieldName:c,value:b.parseMetaValue(a,c),type:"legend"}])},g=b.get("chartColors");g&&g[a[c]]&&(f.color=g[a[c]]),e.push(f)}}),e},data:{data:[],title:"",xAxis:"",yAxis:"",chartColors:{},showPercents:!1}}),LineChartComponent=BaseChartComponent.extend({template:function(a){return a.isWidget?"<svg></svg>":"#chartViewTemplate"},axisKeys:[],oninit:function(){this.parentInit()},onrender:function(){var a=this,b=a.get("data"),c=a.get("title"),d=a.get("svg"),e=this.get("xAxis"),f=a.get("isWidget"),g=this.get("getAvailableGroups"),h=this.get("options"),i={top:50,right:50,bottom:120,left:100};!f&&a.get("margin")&&(i=a.get("margin"));for(var j=this.get("d3"),k=this.get("nv"),l=0;l<g.length;l++)if(g[l].dateGrouping){var m=e+"_"+g[l].dateGrouping;if(m==g[l].name){e=m;break}}k.addGraph(function(){var l=k.models.lineChart().options({reduceXTicks:!1}).margin(i).useInteractiveGuideline(!1).showLegend(!0).color(j.scale.category10().range());e=jQuery.grep(g,function(a){return a.name==e}),h.isCombined&&"date_field"==a.get("xAxis")?e="Date":(e="",e[0]&&(e=e[0].title)),l.xAxis.axisLabel(e).tickFormat(function(b){return void 0!==a.axisKeys[b]?a.axisKeys[b]:""}),l.xAxis.rotateLabels(-30);var m=a.normalise(b);return a.bigValues&&l.yAxis.tickFormat(function(a){return chartView.get("numberFormat")(null,null,a)}),f||l.legend.margin({top:20,bottom:30}),l.forceY(0),j.select(d).datum(m).call(l),f||j.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),k.utils.windowResize(l.update),a.chartUpdate(),a.get("drilldownEnabled")&&l.lines.dispatch.on("elementClick",j.contextMenu(getContextMenuElements(a.get("reportData")),function(){a.colorPickerCallback(a)})),a.chart=l,l})},updateData:function(){var a=this,b=a.get("data"),c=a.get("svg");a.set("chartColors",ReportData.chartColors);var d=a.normalise(b);d3.select(c).datum(d).call(a.chart)},normalise:function(a){var b=this.get("legend"),c=this.get("xAxis"),d=this.get("yAxis"),e=this.get("aggregates");c=reportUtils.appendDateGrouping(a,c);for(var f=!1,g=0;g<b.length;g++){if(reportUtils.getAggregate(b[g],e)){f=!0;break}}return f?this.parseAggregates(a,c,d,b):(b=reportUtils.appendDateGrouping(a,b),this.parseGroups(a,c,d,b))},data:{data:[],title:"",xAxis:"",yAxis:""}});CombinedChartComponent=BaseChartComponent.extend({template:function(a){return a.isWidget?"<svg></svg>":"#chartViewTemplate"},oninit:function(){this.parentInit()},onrender:function(){var a=this,b=a.get("data"),c=a.get("title"),d=a.get("svg"),e=a.get("isWidget"),f={top:50,right:50,bottom:120,left:70};!e&&a.get("margin")&&(f=a.get("margin"));var g=this.get("d3"),h=this.get("nv"),i=a.get("bars1Stacked"),j=a.get("bars2Stacked");h.addGraph(function(){var k=h.models.multiChart().options({reduceXTicks:!1}).margin(f).color(g.scale.category10().range()).bars1stacked(i).bars2stacked(j);k.tooltip.headerFormatter(function(b){return void 0!==a.axisKeys[b]?a.axisKeys[b]:""}),k.xAxis.tickFormat(function(b){return void 0!==a.axisKeys[b]?a.axisKeys[b]:""}),k.xAxis.rotateLabels(-30),a.bigValues&&(k.yAxis1.tickFormat(function(a){return chartView.get("numberFormat")(null,null,a)}),k.yAxis2.tickFormat(function(a){return chartView.get("numberFormat")(null,null,a)}));for(var l=a.normalise(b),m=0,n=0,o=0,p=0,q=0;q<l.length;q++)for(var r=l[q].yAxis,s=l[q].values,t=0;t<s.length;t++)1==r&&s[t].y>o&&(o=s[t].y),2==r&&s[t].y>p&&(p=s[t].y);return k.yDomain1([m,o]),k.yDomain2([n,p]),g.select(d).datum(l).call(k),e||g.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),h.utils.windowResize(k.update),a.get("drilldownEnabled")&&(k.bars1.dispatch.on("elementClick",g.contextMenu(getContextMenuElements(a.get("reportData")),function(){a.colorPickerCallback(a)})),k.bars2.dispatch.on("elementClick",g.contextMenu(getContextMenuElements(a.get("reportData")),function(){a.colorPickerCallback(a)})),k.lines1.dispatch.on("elementClick",g.contextMenu(getContextMenuElements(a.get("reportData")),function(){a.colorPickerCallback(a)})),k.lines2.dispatch.on("elementClick",g.contextMenu(getContextMenuElements(a.get("reportData")),function(){a.colorPickerCallback(a)}))),a.chart=k,k})},updateData:function(){var a=this,b=a.get("data"),c=a.get("svg");a.set("chartColors",ReportData.chartColors);var d=a.normalise(b);d3.select(c).datum(d).call(a.chart)},normalise:function(a){var b=this.get("legend"),c=this.get("xAxis"),d=this.get("yAxis"),e=this.get("yAxis2"),f=(this.get("aggregates"),this.get("yAxisType")),g=this.get("yAxis2Type"),h=this.get("chartColors");c=reportUtils.appendDateGrouping(a,c);for(var i=[],j=[],k=0;k<b.length;k++)i.push(b[k]);for(var l=0;l<a.data.length;l++)a.data[l][c]||(a.data[l][c]="-"),j.push(a.data[l][c]);i=reportUtils.unique(i),j=reportUtils.unique(j),this.axisKeys=j,"string"==typeof d&&(d=[d],this.set("yAxis",d)),"string"==typeof e&&(e=[e],this.set("yAxis2",e)),!f&&d.length>0&&(f="line",this.set("yAxisType",f)),!g&&e.length>0&&(g="line",this.set("yAxis2Type",g));var m=[];m.push({keys:d,type:f,position:1}),m.push({keys:e,type:g,position:2});for(var n=[],o=0,l=0;l<m.length;l++)for(var p=m[l].type,q=m[l].position,k=0;k<m[l].keys.length;k++){var r=m[l].keys[k];n[o]={key:r,type:p,yAxis:q,values:[]};for(var s=0;s<j.length;s++)n[o].values[s]={x:s,y:0};o++}for(var l=0;l<a.data.length;l++)for(var t=j.indexOf(a.data[l][c]),k=0;k<b.length;k++)for(var s=0;s<n.length;s++)if(n[s].key==b[k]){var u=parseFloat(a.data[l][b[k]]);u||(u=0),this.bigValues=!0,n[s].values[t].y=u,n[s].values[t].meta=this.parseMetaDrilldown([{fieldName:b[k],value:this.parseMetaValue(a.data[l],b[k]),type:"legend"},{fieldName:c,value:this.parseMetaValue(a.data[l],c),type:"xAxis"}])}for(var l=0;l<n.length;l++)n[l].key=a.cols[n[l].key],h&&(h[n[l].key]||h[n[l].key+" (right axis)"])&&(n[l].color=h[n[l].key]||h[n[l].key+" (right axis)"]);return n},data:{data:[],title:"",xAxis:"",yAxis:[],yAxis2:[],yAxisType:"",yAxis2Type:"",bars1Stacked:!1,bars2Stacked:!1,legend:[]}});var FunnelChartComponent=BaseChartComponent.extend({template:function(a){return a.isWidget?"<svg></svg>":"#chartViewTemplate"},oninit:function(){this.parentInit()},onrender:function(){function a(){jQuery(e).empty();var g=new D3Funnel(e);g.update=function(){a()};try{g.draw(b.normalise(c),k),jQuery(e+" text").attr("style","font-size:14px;fill: #fff !important")}catch(a){console.log(a)}return f||i.select(e).attr("class","nvd3-svg").append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(d),b.chart=g,g}var b=this,c=b.get("data"),d=b.get("title"),e=b.get("svg"),f=b.get("isWidget"),g=b.get("showPercents"),h=b.get("reportData");!f&&b.get("margin")&&b.get("margin");var i=this.get("d3"),j=b.getTotal(c.data,this.get("yAxis")),k={block:{dynamicHeight:!0,highlight:!0,fill:{type:"gradient"}},label:{format:function(a,c){return g&&(a+=" ("+b.getPercents(j,c).toFixed(2)+"%)"),a+": "+new NumberFormatter(jQuery.extend({},{numdec:h.chartDecimalDigits},h.numberFormat),null).makeFormatter()(null,null,c)}}};b.get("drilldownEnabled")&&(k.events={click:{block:function(a){var c=[{title:function(a){var c=b.get("xAxis"),d=a.label.raw,e=b.findByKeyValue(b.get("data").data,c,d),f=b.parseMetaDrilldown([{fieldName:c,value:b.parseMetaValue(e,c),type:"xAxis"}]),g=a.label.raw,i=a.fill.raw;return'<a href="'+(h.urlDrilldown+h.id)+"&drilldown="+encodeURI(JSON.stringify(f))+'" target="_blank">Drill-down to detailed data</a><input type="hidden" value="'+g+'" id="colorForField"><input type="hidden" value="'+i+'" id="drilldownpopup" />'},action:function(a,b,c){}}];i.contextMenu(c,function(){b.colorPickerCallback(b)}).call(this,a)}}}),f||(k.chart={margin:{left:0,right:0,top:30,bottom:0}}),a(),b.chartUpdate()},getTotal:function(a,b){for(var c=0,d=0;d<a.length;d++)a[d][b]&&(c+=parseFloat(a[d][b]));return c},getPercents:function(a,b){var c=0;return a>0&&b>0&&(c=b/a*100),c},updateData:function(){var a=that.get("reportData");this.set("chartColors",a.chartColors),this.chart.update()},normalise:function(a){for(var b=this.get("xAxis"),c=this.get("yAxis"),d=this.get("cumulated"),e=this.get("groups"),f=0;f<e.length;f++)e[f].name==b&&e[f].dateGrouping&&(b=b+"_"+e[f].dateGrouping);return d?this.normaliseCumulated(a,b,c):this.normaliseNonCumulated(a,b,c)},normaliseCumulated:function(a,b,c,d){var e=this,f=this.get("sortableValues"),g=[],h=[],i=e.get("chartColors");if(_.each(a.data,function(a){if(a[b]||a[c]){var d={key:a[b],val:parseFloat(a[c])};g.push(d)}}),0==f.length&&(g=g.sort(function(a,b){return a.val-b.val}),g=this.cumulateValues(g),g=g.sort(function(a,b){return b.val-a.val})),f.length>0){for(var j=[],k=0;k<f.length;k++)for(var l=f[k].value,m=0;m<g.length;m++)l==g[m].key&&j.push(g[m]);g=this.cumulateValues(j)}for(var k=0;k<g.length;k++){var n=g[k].key,o=g[k].val,p=[n,+o.toFixed(2)];i&&i[n]&&p.push(i[n]),h.push(p)}return h},cumulateValues:function(a){for(var b=0,c=!1,a=a.reverse(),d=0;d<a.length;d++){if(a[d].val>0)c=!0;else if(!c){a.splice(d,1);continue}c&&(a[d].val=a[d].val+b,b=a[d].val)}return a.reverse()},normaliseNonCumulated:function(a,b,c){var d=this,e=[],f=[],g=d.get("chartColors");_.each(a.data,function(a){if(a[b]||a[c]){var d=a[b],f=parseFloat(a[c]),g={key:d,val:f};e.push(g)}}),e=e.sort(function(a,b){return b.val-a.val});for(var e=e.reverse(),h=!1,i=0;i<e.length;i++)if(e[i].val>0)h=!0;else if(!h){e.splice(i,1);continue}for(var i=0;i<e.length;i++){var j=[e[i].key,+e[i].val.toFixed(2)];g&&g[key]&&j.push(g[key]),f.push(j)}return f.reverse()},data:{cumulated:!0,sortableValues:[],data:[],title:"",xAxis:"",yAxis:"",showPercents:!1}}),GaugeChartComponent=BaseChartComponent.extend({template:function(a){return a.isWidget?"<svg></svg>":"#chartViewTemplate"},oninit:function(){this.parentInit()},onrender:function(){function a(){var g=jQuery(b.get("svg")).height();k.margin&&(g=g-k.margin.top-k.margin.bottom),k.size=g,jQuery(e).empty();var h=new D3Gauge(e,k);return h.update=function(){a()},h.write(b.normalise(c)),f||j.select(e).attr("class","nvd3-svg").append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(d),b.chart=h,h}var b=this,c=b.get("data"),d=b.get("title"),e=b.get("svg"),f=b.get("isWidget"),g=b.get("valueZones"),h=b.get("showLabels"),i=b.get("showZoneLabels");!f&&b.get("margin")&&b.get("margin");var j=this.get("d3"),k={min:b.getValueZonesMin(),max:b.getValueZonesMax(),transitionDuration:900,label:"",minorTicks:5,majorTicks:10,needleWidthRatio:.6,needleContainerRadiusRatio:.7,clazz:"small",zones:g,showLabels:h,showZoneLabels:i};f||(k.margin={left:100,right:0,top:30,bottom:0}),a(),b.chartUpdate()},getValueZonesMin:function(){for(var a=this.get("valueZones"),b=0,c=0;c<a.length;c++)a[c].from<b&&(b=parseFloat(a[c].from));return b},getValueZonesMax:function(){for(var a=this.get("data"),b=this.get("valueZones"),c=0,d=0;d<b.length;d++)b[d].to>c&&(c=parseFloat(b[d].to));var e=this.normalise(a);return e>c?e:c},normalise:function(a){var b=this.get("xAxis"),c=this.get("xAxisSegment"),d=this.get("yAxis");b=reportUtils.appendDateGrouping(a,b);var e=0;return _.each(a.data,function(a){if(c){if(a[b]&&a[b]==c){var f=parseFloat(a[d]);f&&(e+=f)}}else{var f=parseFloat(a[d]);f&&(e+=f)}}),e||(e=0),e},data:{data:[],title:"",xAxis:"",yAxis:"",showPercents:!1,valueZones:[],xAxisSegment:!1,showLabels:!1,showZoneLabels:!1}});MapChartComponent=BaseChartComponent.extend({template:function(a){return a.isWidget?'<div id="{{elementId}}" style="height:100%;"></div>':"#chartViewTemplate"},oninit:function(){this.parentInit(),this.set("elementId","id_"+reportUtils.uniqueId())},onrender:function(){var a=this,b=(a.get("title"),a.get("isWidget")),c="choropleth";b&&(c=this.get("elementId"));var d=L.map(c).setView([a.get("lat"),a.get("lng")],a.get("zoom")),e=new L.LatLng(85,-180),f=new L.LatLng(-85,180),g=new L.LatLngBounds(e,f);d.setMaxBounds(g),(new L.Control.Legend).addTo(d),L.tileLayer.provider("Stamen.TonerLite",{minZoom:2}).addTo(d);var h=this.normalise(this.get("data"),this.get("country"),this.get("state"),this.get("xAxis"),this.get("yAxis"),this.get("markerAxisX"),this.get("markerAxisY")),i=this.getOptions(),j=this.getData(h,i);if(new L.ChoroplethDataLayer(j,i).addTo(d),this.get("marker")){var k=this.getMarkerLayer(j,i);d.addLayer(k)}d.on("zoomend",function(a){b||(ReportData.zoom=d.getZoom())}),d.on("dragend",function(a){if(!b){var c=d.getCenter();ReportData.lat=c.lat,ReportData.lng=c.lng}}),b||jQuery(window).on("exportImage",function(a,b){b&&(b=jQuery(b),b.data("initialText",b.text()),b.text("Loading..."));var c=[];leafletImage(d,function(a,d){c.push(d.toDataURL());var e=jQuery("svg")[0],f=jQuery(".leaflet-map-pane").css("transform"),g=parseInt(f.split(",")[4]),h=parseInt(f.split(",")[5]);saveSvgAsPng(e,"chart.png",1,function(a){c.push(a);try{jQuery.post("index.php?entryPoint=combineMapTiles",{sources:c},function(a){window.location="index.php?entryPoint=analyticReportBouncer&img="+a+"&nobase=true"})}catch(a){console.log(a),alery("There was problems with generating map chart image on server.")}finally{b&&b.text(b.data("initialText"))}},g,h)})}),a.chart={update:function(){d.invalidateSize()}}},getChartOptions:function(a,b){var c={};for(key in a)for(chartKey in a[key].data){var d="data."+chartKey;c[d]={displayName:chartKey,fillColor:null}}var e=0;for(option in c){var f=this.get("chartColors"),g=f[e];c[option].fillColor=g,e++}return c},getMarkerLayer:function(a,b){var c={chartOptions:{},layerOptions:{fillOpacity:1,opacity:1,weight:1,radius:15,barThickness:10,gradient:!0},legendOptions:{title:"Chart legend"}},d=this.getChartOptions(a,b);c.chartOptions=d;var e=jQuery.extend(!0,b,c);return new L.PieChartDataLayer(a,e)},getData:function(a,b){for(var c={},d=0;d<a.length;d++){var e=a[d].key,f=a[d].val,g=a[d].title,h={};a[d].data&&(h=a[d].data),c[e]={name:e,val:f,title:g,data:h},c[e][b.codeField]=e}return c},colorize:function(a,b,c){return new L.CustomColorFunction(a,b,c,{interpolate:!0})},getLocationMode:function(){var a;switch(this.get("mapType")){case"state":for(state in LSTATES)L.states=jQuery.extend({},L.states,LSTATES[state]);var b=L.GeometryUtils.loadCentroids(L.states);L.stateCentroids=jQuery.extend({},L.stateCentroids,b),a=L.LocationModes.STATE;break;case"city":a=L.LocationModes.LOOKUP;break;case"country":default:a=L.LocationModes.COUNTRY}return a},getOptions:function(a){var b=this,c=this.get("yAxis"),d=this.get("aggregates"),e=this.get("labels"),f={recordsField:null,locationMode:this.getLocationMode(),codeField:"abbr",displayOptions:{},layerOptions:{fillOpacity:.8,opacity:1,weight:1,stroke:!1},tooltipOptions:{iconSize:new L.Point(100,70),iconAnchor:new L.Point(-5,55)},getIndexKey:function(a,b){return a.text}},g={};switch(this.get("mapType")){case"city":var h={type:"FeatureCollection",features:[]};for(country in LCITIES)jQuery.merge(h.features,LCITIES[country].features);var g=jQuery.extend({},g,{locationLookup:h,locationIndexField:"id",locationTextField:"title"})}f=jQuery.extend(f,g);var i=reportUtils.getAggregate(c,d),j=e[c]?e[c]:i.title,k=this.get("marker")?this.get("colors"):this.get("heatcolors");return f.displayOptions.val={displayName:j,fillColor:b.colorize(this.min,this.max,k)},f},getKeyPath:function(a,b,c,d){var e="";switch(this.get("mapType")){case"state":var f=this.getCountryCode(a[b]);e=f+"."+this.getStateCode(f,a[d]);break;case"city":var g=["GB","FR","AT","BE","DK","IE","IT","NL","SE","PL","ES","MX","IS","NO","CH","GR","CZ","IN","CN","LV","EE","LT"],f=this.getCountryCode(a[b]);return e=f,-1==jQuery.inArray(f,g)&&(e+="."+this.getStateCode(f,a[c])),a[d]&&(e+="."+a[d].replace(/[. ]/g,"")),e;case"country":default:e=this.getCountryCode(a[d])}return e},_normalise:function(a,b,c,d,e,f,g){for(var h={},i=[],j={},k=0;k<a.data.length;k++){var l=a.data[k][d],m=this.getKeyPath(a.data[k],b,c,d);j[m]=l;var n=a.data[k][e];i[m]=l,f&&g&&a.data[k][f]!=g||m&&(n=parseFloat(n)||0,h[m]=h[m]||0,h[m]+=n)}var o=[];for(m in h){var p={};p.keyPath=m,p.key=j[p.keyPath],p.title=i[p.keyPath],p.value=h[m],o.push(p)}return o},_normaliseMarkers:function(a,b,c,d,e,f,g){for(var h={},i=0;i<a.data.length;i++){var j=a.data[i][d],k=a.data[i][e];f&&g&&a.data[i][f]!=g||j&&(k=parseFloat(k)||0,h[j]=h[j]||0,h[j]+=k)}return h},normalise:function(a,b,c,d,e,f,g){b=reportUtils.appendDateGrouping(a,b),c=reportUtils.appendDateGrouping(a,c),d=reportUtils.appendDateGrouping(a,d);var h=this._normalise(a,b,c,d,e);this.max=0,this.min=0;for(var i=[],j=0;j<h.length;j++){h[j].value>this.max&&(this.max=h[j].value),h[j].value<this.min&&(this.min=h[j].value);var k=this._normaliseMarkers(a,b,c,f,g,d,h[j].key),l={key:h[j].keyPath,val:h[j].value,title:h[j].title,data:k};i.push(l)}return i},getCountryNameSynonym:function(a){var b=[{key:"Russia",value:"Russian Federation"},{key:"England",value:"United Kingdom"},{key:"USA",value:"United States"},{key:"US",value:"United States"},{key:"UAE",value:"United Arab Emirates"},{key:"RSA",value:"South Africa"}],c=b.filter(function(b){return b.key==a})[0];return!!c&&c.value},getCountryCode:function(a){if(!a)return!1;if(a.length>2&&L.fullLookup){var b=reportUtils.toTitleCase(a);a.length<=3&&(b=b.toUpperCase());var c=this.getCountryNameSynonym(b);c&&(b=c);var d=reportUtils.findKey(L.fullLookup,b);d&&(a=d)}return a},getStateCode:function(a,b){if(!a||!b)return!1;if(b.length>2&&L.stateAlpha2Lookup&&L.stateAlpha2Lookup[a]){var c=reportUtils.findKey(L.stateAlpha2Lookup[a],b);c&&(b=c)}return b},data:{data:[],title:"",xAxis:"",yAxis:[],yAxis2:[],yAxisType:"",yAxis2Type:"",bars1Stacked:!1,bars2Stacked:!1,legend:[],mapType:"country",zoom:2,lat:0,lng:0,heatcolors:["#2e539c","#8aed4a","#f2e51a","#f41e36"],colors:["#d3e0ba","#bdd097","#a7c074","#91b152","#7ba12f"],chartColors:["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928"]}});var AreaChartComponent=BaseChartComponent.extend({template:function(a){return a.isWidget?"<svg></svg>":"#chartViewTemplate"},axisKeys:[],oninit:function(){this.parentInit()},onrender:function(){var a=this,b=a.get("data"),c=a.get("title"),d=a.get("svg"),e=this.get("xAxis"),f=a.get("isWidget"),g=this.get("getAvailableGroups"),h=this.get("options"),i={top:50,right:50,bottom:120,left:100};!f&&a.get("margin")&&(i=a.get("margin"));for(var j=this.get("d3"),k=this.get("nv"),l=0;l<g.length;l++)if(g[l].dateGrouping){var m=e+"_"+g[l].dateGrouping;if(m==g[l].name){e=m;break}}k.addGraph(function(){var l=k.models.stackedAreaChart().options({reduceXTicks:!1}).margin(i).useInteractiveGuideline(!1).showLegend(!0).showControls(!0).color(j.scale.category10().range()).x(function(a){return a[0]}).y(function(a){return a[1]});e=jQuery.grep(g,function(a){return a.name==e}),h.isCombined&&"date_field"==a.get("xAxis")?e="Date":(e="",e[0]&&(e=e[0].title)),l.xAxis.axisLabel(e).tickFormat(function(b){return void 0!==a.axisKeys[b]?a.axisKeys[b]:""}),l.xAxis.rotateLabels(-30),a.bigValues,f||(l.legend.margin({top:20,bottom:30}),l.controls.margin({top:20,bottom:30})),l.forceY(0);var m=a.normalise(b);return j.select(d).datum(m).call(l),f||j.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),k.utils.windowResize(l.update),a.get("drilldownEnabled")&&l.stacked.dispatch.on("elementClick",j.contextMenu(getContextMenuElements(a.get("reportData")),function(){a.colorPickerCallback(a)})),a.chart=l,l})},updateData:function(){var a=this,b=a.get("data"),c=a.get("svg");a.set("chartColors",ReportData.chartColors);var d=a.normalise(b);console.log(d),d3.select(c).datum(d).call(a.chart)},normalise:function(a){var b=this.get("legend"),c=this.get("xAxis"),d=this.get("yAxis"),e=this.get("aggregates"),f=this.get("sortableValues");c=reportUtils.appendDateGrouping(a,c);for(var g=!1,h=0;h<b.length;h++){if(reportUtils.getAggregate(b[h],e)){g=!0;break}}var i=[];if(g?i=this.parseAggregates(a,c,d,b):(b=reportUtils.appendDateGrouping(a,b),i=this.parseGroups(a,c,d,b)),i=i.map(function(a){return a.values=a.values.map(function(a,b){return[a.x,a.y,a.meta]}),a}),f.length>0){for(var j=[],h=0;h<f.length;h++)for(var k=f[h].key,l=0;l<i.length;l++)k==i[l].key&&j.push(i[l]);i=j}return i},data:{data:[],sortableValues:[],title:"",xAxis:"",yAxis:""}});HorizontalBarChartComponent=BaseChartComponent.extend({template:function(a){return a.isWidget?"<svg></svg>":"#chartViewTemplate"},oninit:function(){this.parentInit()},onrender:function(){var a=this,b=a.get("data"),c=a.get("title"),d=a.get("svg"),e=a.get("isWidget"),f=a.get("stacked"),g={top:50,right:150,bottom:120,left:70};!e&&a.get("margin")&&(g=a.get("margin"));var h=this.get("d3"),i=this.get("nv");i.addGraph(function(){var j=i.models.multiBarHorizontalChart().margin(g).stacked(f).color(h.scale.category10().range());j.xAxis.tickFormat(function(b){return void 0!==a.axisKeys[b]?a.axisKeys[b]:""}),j.xAxis.rotateLabels(-30);var k=a.normalise(b);return a.bigValues&&j.yAxis.tickFormat(function(a){return chartView.get("numberFormat")(null,null,a)}),e||j.legend.margin({top:20,bottom:20}),h.select(d).datum(k).call(j),j.dispatch.on("stateChange",function(a){ReportData.chartStacked=a.stacked}),e||h.select(d).append("text").attr("x",100).attr("y",10).style({"text-anchor":"left","font-weight":"bold"}).text(c),i.utils.windowResize(j.update),a.get("drilldownEnabled")&&j.multibar.dispatch.on("elementClick",h.contextMenu(getContextMenuElements(a.get("reportData")),function(){a.colorPickerCallback(a)})),a.chart=j,j})},updateData:function(){var a=this,b=a.get("data"),c=a.get("svg");a.set("chartColors",ReportData.chartColors);var d=a.normalise(b);d3.select(c).datum(d).call(a.chart)},normalise:function(a){var b=this.get("legend"),c=this.get("xAxis"),d=this.get("yAxis");c=reportUtils.appendDateGrouping(a,c);for(var e=this.get("aggregates"),f=!1,g=0;g<b.length;g++){if(reportUtils.getAggregate(b[g],e)){f=!0;break}}return f?this.parseAggregates(a,c,d,b):this.parseGroups(a,c,d,b)},data:{data:[],title:"",xAxis:"",yAxis:"",legend:"",svg:""}});var chartButtons=Ractive.extend({template:'<reportBtn text="'+translated_labels.label_preview+'" on-clicked="preview" className="green" />',data:{className:""},components:{reportBtn:reportBtn}}),chartTypeManager=Ractive.extend({template:"#chartTypeTemplate",oninit:function(){this.observe("chartSize",function(a){ReportData.chartSize=a}),this.observe("chartType",function(a){ReportData.chartType=a})},data:{chartTypes:[{name:"pie",title:translated_labels.label_pie_chart},{name:"bar",title:translated_labels.label_column_chart},{name:"hbar",title:translated_labels.label_horizontal_bar_chart},{name:"line",title:translated_labels.label_line_chart},{name:"combined",title:translated_labels.label_combined_chart},{name:"funnel",title:translated_labels.label_funnel_chart},{name:"gauge",title:translated_labels.label_gauge_chart},{name:"map",title:translated_labels.label_map_chart},{name:"area",title:translated_labels.label_area_chart}],chartType:ReportData.chartType,chartTitle:ReportData.chartTitle,chartSizes:ReportData.chartSizes,chartSize:ReportData.chartSize},components:{chartButtons:chartButtons,selectBoxImg:selectBoxImg,selectBox:selectBox}});