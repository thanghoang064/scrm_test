/*! AnalyticReporting 19-07-2018 */
if(Ractive.components.reportBuilderModule=Ractive.extend({template:"#reportBuilderModule",data:{moduleName:"",children:[],parentModuleName:"",moduleFieldName:"",parentModuleFieldName:"",relation:"oneToMany",manyToMany:{tableName:"",mainModuleColumnName:"",subModuleColumnName:"",roleRequired:"",roleIndex:"",roleValue:""}},oninit:function(){var a=this;this.on("addModule",function(b){this.get("children").push({moduleName:this.get("defaults.moduleName"),moduleFieldName:this.get("defaults.moduleFieldName"),children:[],parentModuleName:a.get("moduleName"),parentModuleFieldName:this.get("types.modulesFieldTypes")[a.get("moduleName")][1].name,relation:"oneToMany",editable:!0,manyToMany:{tableName:"",mainModuleColumnName:"",subModuleColumnName:"",roleRequired:"",roleIndex:"",roleValue:""}})}),this.on("removeModule",function(a){this.set("children",[]),this.set("parentModuleName",""),this.set("parentModuleName","teardown")}),this.observe(this.observers,{init:!1})},idFieldNameMatcher:function(a,b){var c;switch(b){case"Opportunities":c="opportunity_id";break;default:c=b.toLowerCase().slice(0,-1)+"_id"}for(var d=this.get("types.modulesFieldTypes")[a],e=0,f=d.length;e<f;e++)if(d[e].name==c)return c;return!1},observers:{moduleName:function(a,b){this.set("relation","oneToMany");for(var c=this.get("children"),d=0,e=c.length;d<e;d++)c[d].parentModuleName=a,this.set("children["+d+"].parentModuleName",a),this.set("children["+d+"].parentModuleFieldName",this.get("types.modulesFieldTypes")[a][1].name);if(this.set("moduleFieldName",this.get("types.modulesFieldTypes")[a][1].name),this.set("manyToMany.roleValue",this.get("moduleName")),void 0!==this.get("types.modulesFieldTypes")[this.get("parentModuleName")]){var f=this.idFieldNameMatcher(a,this.get("parentModuleName"));!1!==f&&this.set("moduleFieldName",f)}},"children.*.parentModuleName":function(a,b,c,d){"teardown"==a&&this.splice("children",d,1)},parentModuleName:function(a,b,c){if(this.set("relation","oneToMany"),void 0!==this.get("types.modulesFieldTypes")[a]){for(var d=this.get("types.modulesFieldTypes")[a][1].name,e=this.get("types.modulesFieldTypes")[this.get("moduleName")],f=0,g=e.length;f<g;f++)if(e[f].name==d){this.set("moduleFieldName",d);break}var h=this.idFieldNameMatcher(this.get("moduleName"),a);!1!==h&&this.set("moduleFieldName",h)}},relation:function(a,b,c){if("oneToMany"!=a){var d=this.get("manyToManyTableTypesComputed");if(d.length>0){this.set("manyToMany.tableName",d[0].tableName);var e=this.get("selectedManyToManyTable");void 0!==e.columns[0]&&(this.set("manyToMany.mainModuleColumnName",e.columns[0].name),this.set("manyToMany.subModuleColumnName",e.columns[0].name),this.set("manyToMany.roleIndex",e.columns[0].name)),void 0!==e.columns[1]&&this.set("manyToMany.subModuleColumnName",e.columns[1].name),void 0!==e.columns[2]&&this.set("manyToMany.roleIndex",e.columns[2].name),this.set("manyToMany.roleValue",this.get("moduleName")),this.set("manyToMany.roleRequired",e.relModule)}this.set("moduleFieldName",this.get("types.modulesFieldTypes")[this.get("moduleName")][1].name)}else{var f=this.idFieldNameMatcher(this.get("moduleName"),this.get("parentModuleName"));!1!==f&&this.set("moduleFieldName",f)}},"manyToMany.tableName":function(a,b,c){this.set("manyToMany.roleRequired",this.get("selectedManyToManyTable").relModule)}},computed:{manyToManyTableTypesComputed:function(){var a=[],b=this.get("types.manyToManyTypes")[this.get("parentModuleName")],c=this.get("types.manyToManyTypes")[this.get("moduleName")],d=this.get("types.manyToManyTypes").all;if(void 0!==d&&(a=a.concat(d)),void 0!==b)for(var e=0,f=b.length;e<f;e++)-1==jQuery.inArray(this.get("moduleName"),b[e].applicableModules)&&-1==jQuery.inArray("all",b[e].applicableModules)||(a=a.concat(b[e]));if(void 0!==c)for(var e=0,f=c.length;e<f;e++)-1==jQuery.inArray(this.get("parentModuleName"),c[e].applicableModules)&&-1==jQuery.inArray("all",c[e].applicableModules)||(a=a.concat(c[e]));return a},selectedManyToManyTable:function(){for(var a=this.get("manyToManyTableTypesComputed"),b=0,c=a.length;b<c;b++)if(a[b].tableName==this.get("manyToMany.tableName"))return a[b]}}}),Ractive.components.reportBuilderModuleSimple=Ractive.extend({template:"#reportBuilderModuleSimple",data:{moduleName:"",children:[],parentModuleName:"",moduleFieldName:"",parentModuleFieldName:"",relation:"oneToMany",manyToMany:{tableName:"",mainModuleColumnName:"",subModuleColumnName:"",roleRequired:"",roleIndex:"",roleValue:""}},oninit:function(){var a=this;this.updateRelations(this),this.on("addModule",function(b){var c=this.get("types.allRelationsParsed."+this.get("moduleName"));if(void 0!==c){var d=c[0].name;this.get("children").push({moduleName:d,availableChildren:c,selectedChild:0,selectedRelation:0,children:[],parentModuleName:a.get("moduleName"),moduleFieldName:"",parentModuleFieldName:"",relation:"oneToMany",manyToMany:{tableName:"",mainModuleColumnName:"",subModuleColumnName:"",roleRequired:"",roleIndex:"",roleValue:""}})}}),this.on("removeModule",function(a){this.set("children",[]),this.set("parentModuleName",""),this.set("parentModuleName","teardown")}),this.observe(this.observers,{init:!1})},updateRelations:function(a){var b=a.get("availableChildren"),c=a.get("selectedChild"),d=a.get("selectedRelation");if(void 0!==b){var e=b[c].relationships[d];a.set("moduleFieldName",e.id),a.set("parentModuleFieldName",e.parentId),"many-to-many"==e.relationshipType?(a.set("relation","manyToMany"),a.set("manyToMany.tableName",e.joinTable),a.set("manyToMany.mainModuleColumnName",e.manyParentId),a.set("manyToMany.subModuleColumnName",e.manyId),a.set("manyToMany.roleRequired",!1)):(a.set("relation","oneToMany"),a.set("manyToMany.tableName",""),a.set("manyToMany.mainModuleColumnName",""),a.set("manyToMany.subModuleColumnName",""),a.set("manyToMany.roleRequired",!1))}},observers:{moduleName:function(a,b){var c=this.get("children"),d=this.get("types.allRelationsParsed."+a);if(void 0===d)return void this.set("children",[]);for(var e=0,f=c.length;e<f;e++)c[e].parentModuleName=a,this.set("children["+e+"].parentModuleName",a),this.set("children["+e+"].availableChildren",d);this.updateRelations(this)},"children.*.parentModuleName":function(a,b,c,d){"teardown"==a&&this.splice("children",d,1)},selectedChild:function(a,b,c,d){this.set("moduleName",this.get("availableChildren["+a+"].name"))},parentModuleName:function(a,b,c){this.get("types.modulesFieldTypes")[a]},selectedRelation:function(a,b,c,d){this.updateRelations(this)}}}),void 0===reportBuilderOptions)var reportBuilderOptions={};var reportBuilder=new Ractive({el:"#ar-report-builder",template:"#reportBuilderOptionsTemplate",data:{types:reportBuilderOptions.types,internal:reportBuilderOptions.internal,reportTitle:"",reportDescription:"",selectedReportType:"standard",selectedCategory:-1,depth:0,selectedModules:[],defaults:{moduleName:"",moduleFieldName:""},mode:"create",customOptions:{enableAudit:!1,enableCustomTables:!1},record:0},prepareRequest:function(){var a={};for(var b in this.get()){switch(b){case"types":case"depth":case"internal":case"defaults":continue}a[b]=this.get(b)}return a},oninit:function(){if(void 0!==this.get("types")){for(var a=this.get("types.moduleTypes"),b=this.get("types.modulesFieldTypes"),c=0,d=a.length;c<d;c++)if(void 0!==a[c].name&&void 0!==b[a[c].name][1]&&void 0!==b[a[c].name][1].name){this.set("defaults.moduleName",a[c].name),this.set("defaults.moduleFieldName",b[a[c].name][1].name);break}var e=this,f=[],g=!0;if(!1!==reportBuilderOptions.reportOptions){this.set("reportTitle",reportBuilderOptions.reportOptions.title),this.set("reportDescription",reportBuilderOptions.reportOptions.description),this.set("selectedReportType",reportBuilderOptions.reportOptions.iscombined),this.set("selectedCategory",reportBuilderOptions.reportOptions.categoryId),this.set("defaults.moduleName",reportBuilderOptions.reportOptions.module),this.set("record",reportBuilderOptions.reportOptions.record),this.set("mode","update"),g=!1;var h=reportBuilderOptions.reportOptions.options,i=this.get("customOptions");for(var j in i)void 0!==h[j]&&this.set("customOptions."+j,h[j])}!1!==reportBuilderOptions.predefinedChildren&&(f=reportBuilderOptions.predefinedChildren),this.get("selectedModules").push({moduleName:this.get("defaults.moduleName"),children:f,parentModuleName:"",editable:g}),this.on("addModule",function(a){this.get("selectedModules").push({moduleName:this.get("defaults.moduleName"),children:[],parentModuleName:""})}),this.on("saveReport",function(a){var b=this.prepareRequest();e.set("internal.response",{}),jQuery.post(e.get("internal.postUrl"),b,function(a){e.set("internal.response",JSON.parse(a))})}),this.on("updateCurrentReport",function(a){var b=this.prepareRequest();b.saveAction="update",e.set("internal.response",{}),jQuery.post(e.get("internal.postUrl"),b,function(a){e.set("internal.response",JSON.parse(a))})})}}});if(void 0===reportBuilderSimpleOptions)var reportBuilderSimpleOptions={};var reportBuilderSimple=new Ractive({el:"#ar-report-builder-simple",template:"#reportBuilderOptionsTemplate",data:{types:reportBuilderSimpleOptions.types,internal:reportBuilderSimpleOptions.internal,reportTitle:"",reportDescription:"",selectedReportType:"standard",selectedCategory:-1,depth:0,selectedModules:[],defaults:{moduleName:"",moduleFieldName:""},mode:"create",customOptions:{enableAudit:!1,enableCustomTables:!1},simple:!0},oninit:function(){if(void 0!==this.get("types")){for(var a=this.get("types.moduleTypes"),b=this.get("types.modulesFieldTypes"),c=0,d=a.length;c<d;c++)if(void 0!==a[c].name&&void 0!==b[a[c].name][1]&&void 0!==b[a[c].name][1].name){this.set("defaults.moduleName",a[c].name),this.set("defaults.moduleFieldName",b[a[c].name][1].name);break}var e=this;this.get("selectedModules").push({moduleName:this.get("defaults.moduleName"),children:[],parentModuleName:""}),this.on("addModule",function(a){this.get("selectedModules").push({moduleName:this.get("defaults.moduleName"),children:[],parentModuleName:""})}),this.on("saveReport",function(a){var b={};for(var c in this.get()){switch(c){case"types":case"depth":case"internal":case"defaults":continue}b[c]=this.get(c)}e.set("internal.response",{}),jQuery.post(e.get("internal.postUrl"),b,function(a){e.set("internal.response",JSON.parse(a))})})}}});if(void 0===loadedSettings)var loadedSettings={};var reportBuilderSettings=new Ractive({el:"#ar-settings",template:"#reportBuilderSettingsEditorTemplate",data:{types:loadedSettings.types},oninit:function(){void 0!==this.get("types")&&this.get("types.moduleTypes").unshift({name:"all",title:"Add to all modules"})}});